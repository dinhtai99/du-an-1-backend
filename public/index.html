<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop THB - ƒê·ªì C√¥ng Ngh·ªá</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .product-price {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-sale-price {
            color: #27ae60;
            font-size: 16px;
            text-decoration: line-through;
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #667eea;
            font-size: 20px;
            font-weight: bold;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">üõçÔ∏è Shop THB - ƒê·ªì C√¥ng Ngh·ªá</div>
                <ul class="nav-links">
                    <li><a href="#" onclick="showSection('home')">Trang ch·ªß</a></li>
                    <li><a href="#" onclick="showSection('products')">S·∫£n ph·∫©m</a></li>
                    <li><a href="#" onclick="showSection('cart')">Gi·ªè h√†ng</a></li>
                    <li><a href="#" onclick="showSection('orders')">ƒê∆°n h√†ng</a></li>
                    <li id="adminLink" class="hidden"><a href="#" onclick="showSection('dashboard')">Dashboard</a></li>
                </ul>
                <div class="user-info">
                    <span id="userName"></span>
                    <button id="loginBtn" class="btn btn-primary" onclick="showSection('login')">ƒêƒÉng nh·∫≠p</button>
                    <button id="logoutBtn" class="btn btn-danger hidden" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="section">
            <h2>ƒêƒÉng nh·∫≠p</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberMe"> L∆∞u m·∫≠t kh·∫©u
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
            </form>
            <p style="margin-top: 15px;">
                <strong>T√†i kho·∫£n m·∫´u:</strong><br>
                Admin: admin / admin123<br>
                Nh√¢n vi√™n: nhanvien1 / staff123
            </p>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section hidden">
            <h2>Trang ch·ªß</h2>
            <div id="homeContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="section hidden">
            <h2>S·∫£n ph·∫©m</h2>
            <div class="form-group">
                <input type="text" id="searchProduct" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." onkeyup="loadProducts()" style="padding: 12px; font-size: 16px;">
            </div>
            <div id="productsContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Cart Section -->
        <div id="cartSection" class="section hidden">
            <h2>Gi·ªè h√†ng</h2>
            <div id="cartContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section hidden">
            <h2>ƒê∆°n h√†ng c·ªßa t√¥i</h2>
            <div id="ordersContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Dashboard Section (Admin only) -->
        <div id="dashboardSection" class="section hidden">
            <h2>Dashboard (Admin)</h2>
            <div id="dashboardContent">ƒêang t·∫£i...</div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Check if user is logged in
        if (token) {
            checkAuth();
        } else {
            showSection('login');
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userName').textContent = currentUser.fullName;
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminLink').classList.remove('hidden');
                    }
                    showSection('home');
                } else {
                    localStorage.removeItem('token');
                    token = null;
                    showSection('login');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showSection('login');
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, rememberMe })
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showAlert('loginAlert', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                    setTimeout(() => {
                        checkAuth();
                    }, 1000);
                } else {
                    showAlert('loginAlert', data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'L·ªói k·∫øt n·ªëi server!', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('userName').textContent = '';
            document.getElementById('adminLink').classList.add('hidden');
            showSection('login');
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}Section`).classList.remove('hidden');
            
            if (section === 'home') {
                loadHome();
                currentCategoryId = null; // Reset filter khi v·ªÅ trang ch·ªß
            }
            if (section === 'products') loadProducts();
            if (section === 'cart') loadCart();
            if (section === 'orders') loadOrders();
            if (section === 'dashboard') loadDashboard();
        }

        let categoriesData = []; // L∆∞u danh s√°ch categories ƒë·ªÉ d√πng sau

        async function loadHome() {
            try {
                const response = await fetch(`${API_URL}/home`);
                const data = await response.json();
                categoriesData = data.categories; // L∆∞u categories
                
                let html = '<h3>Danh m·ª•c s·∫£n ph·∫©m</h3><div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">';
                data.categories.forEach(cat => {
                    html += `<button onclick="filterByCategory('${cat._id}', '${cat.name}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">${cat.name}</button>`;
                });
                html += '</div>';

                html += '<h3>S·∫£n ph·∫©m n·ªïi b·∫≠t</h3><div class="product-grid">';
                data.featuredProducts.forEach(product => {
                    html += createProductCard(product);
                });
                html += '</div>';

                html += '<h3 style="margin-top: 30px;">S·∫£n ph·∫©m khuy·∫øn m√£i</h3><div class="product-grid">';
                data.promotionProducts.forEach(product => {
                    html += createProductCard(product);
                });
                html += '</div>';

                document.getElementById('homeContent').innerHTML = html;
            } catch (error) {
                document.getElementById('homeContent').innerHTML = 'L·ªói t·∫£i d·ªØ li·ªáu!';
            }
        }

        let currentCategoryId = null; // L∆∞u category ƒëang ƒë∆∞·ª£c ch·ªçn

        async function loadProducts() {
            const search = document.getElementById('searchProduct')?.value || '';
            let url = `${API_URL}/products?limit=20`;
            
            if (search) {
                url += `&search=${search}`;
            }
            
            if (currentCategoryId) {
                url += `&category=${currentCategoryId}`;
            }
            
            try {
                // Load categories n·∫øu ch∆∞a c√≥
                if (categoriesData.length === 0) {
                    try {
                        const catResponse = await fetch(`${API_URL}/categories/all`);
                        categoriesData = await catResponse.json();
                    } catch (e) {
                        console.error('Load categories error:', e);
                    }
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                let html = '';
                
                // Hi·ªÉn th·ªã filter categories n·∫øu c√≥
                if (categoriesData.length > 0) {
                    html += '<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">';
                    html += '<strong>L·ªçc theo danh m·ª•c:</strong>';
                    html += `<button onclick="filterByCategory(null, 'T·∫•t c·∫£')" style="padding: 6px 12px; background: ${currentCategoryId ? '#ddd' : '#667eea'}; color: ${currentCategoryId ? '#333' : 'white'}; border: none; border-radius: 5px; cursor: pointer;">T·∫•t c·∫£</button>`;
                    categoriesData.forEach(cat => {
                        const isActive = currentCategoryId === cat._id;
                        html += `<button onclick="filterByCategory('${cat._id}', '${cat.name}')" style="padding: 6px 12px; background: ${isActive ? '#667eea' : '#ddd'}; color: ${isActive ? 'white' : '#333'}; border: none; border-radius: 5px; cursor: pointer;">${cat.name}</button>`;
                    });
                    html += '</div>';
                }
                
                if (data.products && data.products.length > 0) {
                    html += `<p style="margin-bottom: 15px; color: #666;">T√¨m th·∫•y ${data.total || data.products.length} s·∫£n ph·∫©m</p>`;
                    html += '<div class="product-grid">';
                    data.products.forEach(product => {
                        html += createProductCard(product);
                    });
                    html += '</div>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o!</p>';
                }
                document.getElementById('productsContent').innerHTML = html;
            } catch (error) {
                console.error('Load products error:', error);
                document.getElementById('productsContent').innerHTML = '<p style="color: red;">L·ªói t·∫£i d·ªØ li·ªáu!</p>';
            }
        }

        function filterByCategory(categoryId, categoryName) {
            currentCategoryId = categoryId;
            // Chuy·ªÉn sang tab s·∫£n ph·∫©m
            showSection('products');
            // Load l·∫°i s·∫£n ph·∫©m v·ªõi filter
            loadProducts();
        }

        function createProductCard(product) {
            const price = product.salePrice || product.price;
            const oldPrice = product.salePrice ? product.price : null;
            const categoryName = product.category?.name || '';

            return `
                <div class="product-card">
                    <div class="product-image">${product.image ? `<img src="${product.image}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üì±'}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${categoryName}</div>
                        <div class="product-price">
                            ${oldPrice ? `<span class="product-sale-price">${formatPrice(oldPrice)}</span>` : ''}
                            ${formatPrice(price)}
                        </div>
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            ‚≠ê ${product.rating || 0} (${product.totalReviews || 0} ƒë√°nh gi√°)
                        </div>
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            T·ªìn kho: ${product.stock}
                        </div>
                        ${token ? `<button class="btn btn-primary" style="width: 100%;" onclick="addToCart('${product._id}')">Th√™m v√†o gi·ªè</button>` : ''}
                    </div>
                </div>
            `;
        }

        async function addToCart(productId) {
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        productId,
                        quantity: 1
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
                    loadCart();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        async function loadCart() {
            if (!token) {
                document.getElementById('cartContent').innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.cart && data.cart.items && data.cart.items.length > 0) {
                    let html = '<div>';
                    data.cart.items.forEach(item => {
                        const product = item.product;
                        html += `
                            <div class="cart-item">
                                <div>
                                    <strong>${product.name}</strong><br>
                                    <small>S·ªë l∆∞·ª£ng: ${item.quantity} x ${formatPrice(item.price)}</small>
                                </div>
                                <div>
                                    <strong>${formatPrice(item.price * item.quantity)}</strong>
                                    <button class="btn btn-danger" onclick="removeFromCart('${item._id}')" style="margin-left: 10px;">X√≥a</button>
                                </div>
                            </div>
                        `;
                    });
                    html += `<div class="cart-total">T·ªïng ti·ªÅn: ${formatPrice(data.total)}</div>`;
                    html += `<button class="btn btn-success" onclick="checkout()" style="width: 100%; margin-top: 20px;">Thanh to√°n</button>`;
                    html += '</div>';
                    document.getElementById('cartContent').innerHTML = html;
                } else {
                    document.getElementById('cartContent').innerHTML = '<p>Gi·ªè h√†ng tr·ªëng!</p>';
                }
            } catch (error) {
                document.getElementById('cartContent').innerHTML = 'L·ªói t·∫£i gi·ªè h√†ng!';
            }
        }

        async function removeFromCart(itemId) {
            try {
                const response = await fetch(`${API_URL}/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    loadCart();
                }
            } catch (error) {
                alert('L·ªói!');
            }
        }

        async function checkout() {
            alert('Ch·ª©c nƒÉng thanh to√°n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        }

        async function loadOrders() {
            if (!token) {
                document.getElementById('ordersContent').innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.orders && data.orders.length > 0) {
                    let html = '<table><thead><tr><th>M√£ ƒë∆°n</th><th>Ng√†y ƒë·∫∑t</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.orders.forEach(order => {
                        html += `
                            <tr>
                                <td>${order.orderNumber}</td>
                                <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                                <td>${formatPrice(order.total)}</td>
                                <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></td>
                                <td><button class="btn btn-primary" onclick="viewOrder('${order._id}')">Xem</button></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    document.getElementById('ordersContent').innerHTML = html;
                } else {
                    document.getElementById('ordersContent').innerHTML = '<p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o!</p>';
                }
            } catch (error) {
                document.getElementById('ordersContent').innerHTML = 'L·ªói t·∫£i ƒë∆°n h√†ng!';
            }
        }

        async function loadDashboard() {
            if (!token || currentUser?.role !== 'admin') {
                document.getElementById('dashboardContent').innerHTML = '<p>Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/dashboard`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: #667eea; color: white; padding: 20px; border-radius: 8px;">
                            <h3>Doanh thu</h3>
                            <p style="font-size: 24px; font-weight: bold;">${formatPrice(data.totalRevenue || 0)}</p>
                        </div>
                        <div style="background: #27ae60; color: white; padding: 20px; border-radius: 8px;">
                            <h3>ƒê∆°n h√†ng m·ªõi</h3>
                            <p style="font-size: 24px; font-weight: bold;">${data.newOrders || 0}</p>
                        </div>
                        <div style="background: #f39c12; color: white; padding: 20px; border-radius: 8px;">
                            <h3>Kh√°ch h√†ng</h3>
                            <p style="font-size: 24px; font-weight: bold;">${data.totalCustomers || 0}</p>
                        </div>
                        <div style="background: #e74c3c; color: white; padding: 20px; border-radius: 8px;">
                            <h3>S·∫£n ph·∫©m s·∫Øp h·∫øt</h3>
                            <p style="font-size: 24px; font-weight: bold;">${data.lowStockProducts?.length || 0}</p>
                        </div>
                    </div>
                `;

                if (data.lowStockProducts && data.lowStockProducts.length > 0) {
                    html += '<h3>S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng</h3><ul>';
                    data.lowStockProducts.forEach(product => {
                        html += `<li>${product.name} - C√≤n: ${product.stock} (T·ªëi thi·ªÉu: ${product.minStock})</li>`;
                    });
                    html += '</ul>';
                }

                document.getElementById('dashboardContent').innerHTML = html;
            } catch (error) {
                document.getElementById('dashboardContent').innerHTML = 'L·ªói t·∫£i dashboard!';
            }
        }

        function viewOrder(orderId) {
            alert(`Xem chi ti·∫øt ƒë∆°n h√†ng: ${orderId}`);
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'M·ªõi',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'shipping': 'ƒêang giao',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        function getStatusColor(status) {
            const colorMap = {
                'new': 'warning',
                'processing': 'warning',
                'shipping': 'warning',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colorMap[status] || 'warning';
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        function showAlert(id, message, type) {
            const alertDiv = document.getElementById(id);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.textContent = '';
                alertDiv.className = '';
            }, 3000);
        }
    </script>
</body>
</html>

