<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shop THB - ƒê·ªì C√¥ng Ngh·ªá</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .nav-links {
            display: flex;
            gap: 20px;
            list-style: none;
        }

        .nav-links a {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: rgba(255,255,255,0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .section {
            background: white;
            padding: 30px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            font-family: inherit;
        }

        .form-group select {
            cursor: pointer;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .product-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .product-image {
            width: 100%;
            height: 200px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
        }

        .product-info {
            padding: 15px;
        }

        .product-name {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }

        .product-price {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .product-sale-price {
            color: #27ae60;
            font-size: 16px;
            text-decoration: line-through;
            margin-right: 10px;
        }

        .hidden {
            display: none;
        }

        .alert {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        .cart-total {
            padding: 20px;
            background: #f8f9fa;
            border-top: 2px solid #667eea;
            font-size: 20px;
            font-weight: bold;
            text-align: right;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }

        .badge-success {
            background: #27ae60;
            color: white;
        }

        .badge-warning {
            background: #f39c12;
            color: white;
        }

        .badge-danger {
            background: #e74c3c;
            color: white;
        }

        .admin-tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            color: #333;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .admin-tab-btn:hover {
            background: #e0e0e0;
        }

        .admin-tab-btn.active {
            background: #667eea;
            color: white;
        }

        .admin-tab-content {
            min-height: 400px;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            overflow: auto;
        }

        .modal-content {
            background: white;
            margin: 50px auto;
            padding: 30px;
            border-radius: 10px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">üõçÔ∏è Shop THB - ƒê·ªì C√¥ng Ngh·ªá</div>
                <ul class="nav-links">
                    <li><a href="#" onclick="showSection('home')">Trang ch·ªß</a></li>
                    <li><a href="#" onclick="showSection('products')">S·∫£n ph·∫©m</a></li>
                    <li><a href="#" onclick="showSection('cart')">Gi·ªè h√†ng</a></li>
                    <li><a href="#" onclick="showSection('orders')">ƒê∆°n h√†ng</a></li>
                    <li id="adminLink" class="hidden"><a href="#" onclick="showSection('dashboard')">Dashboard</a></li>
                </ul>
                <div class="user-info">
                    <span id="userName"></span>
                    <button id="loginBtn" class="btn btn-primary" onclick="showSection('login')">ƒêƒÉng nh·∫≠p</button>
                    <button id="logoutBtn" class="btn btn-danger hidden" onclick="logout()">ƒêƒÉng xu·∫•t</button>
                </div>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Login Section -->
        <div id="loginSection" class="section">
            <h2>ƒêƒÉng nh·∫≠p</h2>
            <div id="loginAlert"></div>
            <form onsubmit="login(event)">
                <div class="form-group">
                    <label>Username:</label>
                    <input type="text" id="loginUsername" required>
                </div>
                <div class="form-group">
                    <label>Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="rememberMe"> L∆∞u m·∫≠t kh·∫©u
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
            </form>
            <p style="margin-top: 15px;">
                <strong>T√†i kho·∫£n m·∫´u:</strong><br>
                Admin: admin / admin123<br>
                Nh√¢n vi√™n: nhanvien1 / staff123
            </p>
        </div>

        <!-- Home Section -->
        <div id="homeSection" class="section hidden">
            <h2>Trang ch·ªß</h2>
            <div id="homeContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Products Section -->
        <div id="productsSection" class="section hidden">
            <h2>S·∫£n ph·∫©m</h2>
            <div class="form-group">
                <input type="text" id="searchProduct" placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..." onkeyup="loadProducts()" style="padding: 12px; font-size: 16px;">
            </div>
            <div id="productsContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Cart Section -->
        <div id="cartSection" class="section hidden">
            <h2>Gi·ªè h√†ng</h2>
            <div id="cartContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Orders Section -->
        <div id="ordersSection" class="section hidden">
            <h2>ƒê∆°n h√†ng c·ªßa t√¥i</h2>
            <div id="ordersContent">ƒêang t·∫£i...</div>
        </div>

        <!-- Dashboard Section (Admin only) -->
        <div id="dashboardSection" class="section hidden">
            <h2>üîß Trang Qu·∫£n Tr·ªã</h2>
            <div id="adminTabs" style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px;">
                <button class="admin-tab-btn active" data-tab="overview" onclick="switchAdminTab('overview', this)">üìä T·ªïng quan</button>
                <button class="admin-tab-btn" data-tab="products" onclick="switchAdminTab('products', this)">üì¶ S·∫£n ph·∫©m</button>
                <button class="admin-tab-btn" data-tab="orders" onclick="switchAdminTab('orders', this)">üìã ƒê∆°n h√†ng</button>
                <button class="admin-tab-btn" data-tab="users" onclick="switchAdminTab('users', this)">üë• Ng∆∞·ªùi d√πng</button>
                <button class="admin-tab-btn" data-tab="categories" onclick="switchAdminTab('categories', this)">üóÇÔ∏è Danh m·ª•c</button>
            </div>
            <div id="adminTabContent">
                <div id="adminOverview" class="admin-tab-content"></div>
                <div id="adminProducts" class="admin-tab-content hidden"></div>
                <div id="adminOrders" class="admin-tab-content hidden"></div>
                <div id="adminUsers" class="admin-tab-content hidden"></div>
                <div id="adminCategories" class="admin-tab-content hidden"></div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let token = localStorage.getItem('token');
        let currentUser = null;

        // Check if user is logged in
        if (token) {
            checkAuth();
        } else {
            showSection('login');
        }

        async function checkAuth() {
            try {
                const response = await fetch(`${API_URL}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('userName').textContent = currentUser.fullName;
                    document.getElementById('loginBtn').classList.add('hidden');
                    document.getElementById('logoutBtn').classList.remove('hidden');
                    if (currentUser.role === 'admin') {
                        document.getElementById('adminLink').classList.remove('hidden');
                    }
                    showSection('home');
                } else {
                    localStorage.removeItem('token');
                    token = null;
                    showSection('login');
                }
            } catch (error) {
                console.error('Auth check error:', error);
                showSection('login');
            }
        }

        async function login(event) {
            event.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const response = await fetch(`${API_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password, rememberMe })
                });

                const data = await response.json();
                
                if (response.ok) {
                    token = data.token;
                    localStorage.setItem('token', token);
                    showAlert('loginAlert', 'ƒêƒÉng nh·∫≠p th√†nh c√¥ng!', 'success');
                    setTimeout(() => {
                        checkAuth();
                    }, 1000);
                } else {
                    showAlert('loginAlert', data.message || 'ƒêƒÉng nh·∫≠p th·∫•t b·∫°i!', 'error');
                }
            } catch (error) {
                showAlert('loginAlert', 'L·ªói k·∫øt n·ªëi server!', 'error');
            }
        }

        function logout() {
            localStorage.removeItem('token');
            token = null;
            currentUser = null;
            document.getElementById('loginBtn').classList.remove('hidden');
            document.getElementById('logoutBtn').classList.add('hidden');
            document.getElementById('userName').textContent = '';
            document.getElementById('adminLink').classList.add('hidden');
            showSection('login');
        }

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}Section`).classList.remove('hidden');
            
            if (section === 'home') {
                loadHome();
                currentCategoryId = null; // Reset filter khi v·ªÅ trang ch·ªß
            }
            if (section === 'products') loadProducts();
            if (section === 'cart') loadCart();
            if (section === 'orders') loadOrders();
            if (section === 'dashboard') {
                loadDashboard();
                switchAdminTab('overview');
            }
        }

        let categoriesData = []; // L∆∞u danh s√°ch categories ƒë·ªÉ d√πng sau

        async function loadHome() {
            try {
                const response = await fetch(`${API_URL}/home`);
                const data = await response.json();
                categoriesData = data.categories; // L∆∞u categories
                
                let html = '<h3>Danh m·ª•c s·∫£n ph·∫©m</h3><div style="display: flex; gap: 10px; margin-bottom: 30px; flex-wrap: wrap;">';
                data.categories.forEach(cat => {
                    html += `<button onclick="filterByCategory('${cat._id}', '${cat.name}')" style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='#5568d3'" onmouseout="this.style.background='#667eea'">${cat.name}</button>`;
                });
                html += '</div>';

                html += '<h3>S·∫£n ph·∫©m n·ªïi b·∫≠t</h3><div class="product-grid">';
                data.featuredProducts.forEach(product => {
                    html += createProductCard(product);
                });
                html += '</div>';

                html += '<h3 style="margin-top: 30px;">S·∫£n ph·∫©m khuy·∫øn m√£i</h3><div class="product-grid">';
                data.promotionProducts.forEach(product => {
                    html += createProductCard(product);
                });
                html += '</div>';

                document.getElementById('homeContent').innerHTML = html;
            } catch (error) {
                document.getElementById('homeContent').innerHTML = 'L·ªói t·∫£i d·ªØ li·ªáu!';
            }
        }

        let currentCategoryId = null; // L∆∞u category ƒëang ƒë∆∞·ª£c ch·ªçn

        async function loadProducts() {
            const search = document.getElementById('searchProduct')?.value || '';
            let url = `${API_URL}/products?limit=20`;
            
            if (search) {
                url += `&search=${search}`;
            }
            
            if (currentCategoryId) {
                url += `&category=${currentCategoryId}`;
            }
            
            try {
                // Load categories n·∫øu ch∆∞a c√≥
                if (categoriesData.length === 0) {
                    try {
                        const catResponse = await fetch(`${API_URL}/categories/all`);
                        categoriesData = await catResponse.json();
                    } catch (e) {
                        console.error('Load categories error:', e);
                    }
                }
                
                const response = await fetch(url);
                const data = await response.json();
                
                let html = '';
                
                // Hi·ªÉn th·ªã filter categories n·∫øu c√≥
                if (categoriesData.length > 0) {
                    html += '<div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">';
                    html += '<strong>L·ªçc theo danh m·ª•c:</strong>';
                    html += `<button onclick="filterByCategory(null, 'T·∫•t c·∫£')" style="padding: 6px 12px; background: ${currentCategoryId ? '#ddd' : '#667eea'}; color: ${currentCategoryId ? '#333' : 'white'}; border: none; border-radius: 5px; cursor: pointer;">T·∫•t c·∫£</button>`;
                    categoriesData.forEach(cat => {
                        const isActive = currentCategoryId === cat._id;
                        html += `<button onclick="filterByCategory('${cat._id}', '${cat.name}')" style="padding: 6px 12px; background: ${isActive ? '#667eea' : '#ddd'}; color: ${isActive ? 'white' : '#333'}; border: none; border-radius: 5px; cursor: pointer;">${cat.name}</button>`;
                    });
                    html += '</div>';
                }
                
                if (data.products && data.products.length > 0) {
                    html += `<p style="margin-bottom: 15px; color: #666;">T√¨m th·∫•y ${data.total || data.products.length} s·∫£n ph·∫©m</p>`;
                    html += '<div class="product-grid">';
                    data.products.forEach(product => {
                        html += createProductCard(product);
                    });
                    html += '</div>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o!</p>';
                }
                document.getElementById('productsContent').innerHTML = html;
            } catch (error) {
                console.error('Load products error:', error);
                document.getElementById('productsContent').innerHTML = '<p style="color: red;">L·ªói t·∫£i d·ªØ li·ªáu!</p>';
            }
        }

        function filterByCategory(categoryId, categoryName) {
            currentCategoryId = categoryId;
            // Chuy·ªÉn sang tab s·∫£n ph·∫©m
            showSection('products');
            // Load l·∫°i s·∫£n ph·∫©m v·ªõi filter
            loadProducts();
        }

        function createProductCard(product) {
            const price = product.salePrice || product.price;
            const oldPrice = product.salePrice ? product.price : null;
            const categoryName = product.category?.name || '';

            return `
                <div class="product-card">
                    <div class="product-image">${product.image ? `<img src="${product.image}" style="width: 100%; height: 100%; object-fit: cover;">` : 'üì±'}</div>
                    <div class="product-info">
                        <div class="product-name">${product.name}</div>
                        <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${categoryName}</div>
                        <div class="product-price">
                            ${oldPrice ? `<span class="product-sale-price">${formatPrice(oldPrice)}</span>` : ''}
                            ${formatPrice(price)}
                        </div>
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            ‚≠ê ${product.rating || 0} (${product.totalReviews || 0} ƒë√°nh gi√°)
                        </div>
                        <div style="font-size: 12px; margin-bottom: 10px;">
                            T·ªìn kho: ${product.stock}
                        </div>
                        ${token ? `<button class="btn btn-primary" style="width: 100%;" onclick="addToCart('${product._id}')">Th√™m v√†o gi·ªè</button>` : ''}
                    </div>
                </div>
            `;
        }

        async function addToCart(productId) {
            if (!token) {
                alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cart`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        productId,
                        quantity: 1
                    })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('ƒê√£ th√™m v√†o gi·ªè h√†ng!');
                    loadCart();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        async function loadCart() {
            if (!token) {
                document.getElementById('cartContent').innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ xem gi·ªè h√†ng!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/cart`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.cart && data.cart.items && data.cart.items.length > 0) {
                    let html = '<div>';
                    data.cart.items.forEach(item => {
                        const product = item.product;
                        html += `
                            <div class="cart-item">
                                <div>
                                    <strong>${product.name}</strong><br>
                                    <small>S·ªë l∆∞·ª£ng: ${item.quantity} x ${formatPrice(item.price)}</small>
                                </div>
                                <div>
                                    <strong>${formatPrice(item.price * item.quantity)}</strong>
                                    <button class="btn btn-danger" onclick="removeFromCart('${item._id}')" style="margin-left: 10px;">X√≥a</button>
                                </div>
                            </div>
                        `;
                    });
                    html += `<div class="cart-total">T·ªïng ti·ªÅn: ${formatPrice(data.total)}</div>`;
                    html += `<button class="btn btn-success" onclick="checkout()" style="width: 100%; margin-top: 20px;">Thanh to√°n</button>`;
                    html += '</div>';
                    document.getElementById('cartContent').innerHTML = html;
                } else {
                    document.getElementById('cartContent').innerHTML = '<p>Gi·ªè h√†ng tr·ªëng!</p>';
                }
            } catch (error) {
                document.getElementById('cartContent').innerHTML = 'L·ªói t·∫£i gi·ªè h√†ng!';
            }
        }

        async function removeFromCart(itemId) {
            try {
                const response = await fetch(`${API_URL}/cart/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                if (response.ok) {
                    loadCart();
                }
            } catch (error) {
                alert('L·ªói!');
            }
        }

        async function checkout() {
            alert('Ch·ª©c nƒÉng thanh to√°n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn!');
        }

        async function loadOrders() {
            if (!token) {
                document.getElementById('ordersContent').innerHTML = '<p>Vui l√≤ng ƒëƒÉng nh·∫≠p!</p>';
                return;
            }

            try {
                const response = await fetch(`${API_URL}/orders`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                
                if (data.orders && data.orders.length > 0) {
                    let html = '<table><thead><tr><th>M√£ ƒë∆°n</th><th>Ng√†y ƒë·∫∑t</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.orders.forEach(order => {
                        html += `
                            <tr>
                                <td>${order.orderNumber}</td>
                                <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                                <td>${formatPrice(order.total)}</td>
                                <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></td>
                                <td><button class="btn btn-primary" onclick="viewOrder('${order._id}')">Xem</button></td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                    document.getElementById('ordersContent').innerHTML = html;
                } else {
                    document.getElementById('ordersContent').innerHTML = '<p>Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o!</p>';
                }
            } catch (error) {
                document.getElementById('ordersContent').innerHTML = 'L·ªói t·∫£i ƒë∆°n h√†ng!';
            }
        }

        async function loadDashboard() {
            if (!token || currentUser?.role !== 'admin') {
                document.getElementById('adminOverview').innerHTML = '<p>Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p!</p>';
                return;
            }
            switchAdminTab('overview');
        }

        // Chuy·ªÉn ƒë·ªïi tab admin
        function switchAdminTab(tabName, buttonElement) {
            // ·∫®n t·∫•t c·∫£ tab content
            document.querySelectorAll('.admin-tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // B·ªè active t·∫•t c·∫£ button
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
            document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.remove('hidden');
            
            // ƒê√°nh d·∫•u button active
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Fallback: t√¨m button theo data-tab
                document.querySelector(`[data-tab="${tabName}"]`)?.classList.add('active');
            }
            
            // Load d·ªØ li·ªáu cho tab
            if (tabName === 'overview') loadAdminOverview();
            else if (tabName === 'products') loadAdminProducts();
            else if (tabName === 'orders') loadAdminOrders();
            else if (tabName === 'users') loadAdminUsers();
            else if (tabName === 'categories') loadAdminCategories();
        }

        // T·ªïng quan Dashboard
        async function loadAdminOverview() {
            try {
                const response = await fetch(`${API_URL}/dashboard`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                let html = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; opacity: 0.9;">üí∞ Doanh thu</h3>
                            <p style="font-size: 32px; font-weight: bold; margin: 0;">${formatPrice(data.totalRevenue || 0)}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; opacity: 0.9;">üì¶ ƒê∆°n h√†ng m·ªõi</h3>
                            <p style="font-size: 32px; font-weight: bold; margin: 0;">${data.newOrders || 0}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; opacity: 0.9;">üë• Kh√°ch h√†ng</h3>
                            <p style="font-size: 32px; font-weight: bold; margin: 0;">${data.totalCustomers || 0}</p>
                        </div>
                        <div style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <h3 style="margin: 0 0 10px 0; font-size: 16px; opacity: 0.9;">‚ö†Ô∏è S·∫£n ph·∫©m s·∫Øp h·∫øt</h3>
                            <p style="font-size: 32px; font-weight: bold; margin: 0;">${data.lowStockProducts?.length || 0}</p>
                        </div>
                    </div>
                `;

                // S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng
                if (data.lowStockProducts && data.lowStockProducts.length > 0) {
                    html += `
                        <div class="section" style="margin-top: 20px;">
                            <h3>‚ö†Ô∏è S·∫£n ph·∫©m s·∫Øp h·∫øt h√†ng</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√™n s·∫£n ph·∫©m</th>
                                        <th>Danh m·ª•c</th>
                                        <th>T·ªìn kho</th>
                                        <th>T·ªëi thi·ªÉu</th>
                                        <th>Thao t√°c</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.lowStockProducts.forEach(product => {
                        html += `
                            <tr>
                                <td>${product.name}</td>
                                <td>${product.category?.name || 'N/A'}</td>
                                <td><span style="color: #e74c3c; font-weight: bold;">${product.stock}</span></td>
                                <td>${product.minStock}</td>
                                <td><button class="btn btn-primary" onclick="viewProductDetail('${product._id}')">Xem</button></td>
                            </tr>
                        `;
                    });
                    html += `</tbody></table></div>`;
                }

                // Top s·∫£n ph·∫©m b√°n ch·∫°y
                if (data.topProducts && data.topProducts.length > 0) {
                    html += `
                        <div class="section" style="margin-top: 20px;">
                            <h3>üî• S·∫£n ph·∫©m b√°n ch·∫°y</h3>
                            <table>
                                <thead>
                                    <tr>
                                        <th>T√™n s·∫£n ph·∫©m</th>
                                        <th>ƒê√£ b√°n</th>
                                        <th>Doanh thu</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    data.topProducts.forEach(item => {
                        if (item.product) {
                            html += `
                                <tr>
                                    <td>${item.product.name}</td>
                                    <td>${item.totalSold}</td>
                                    <td>${formatPrice(item.totalRevenue)}</td>
                                </tr>
                            `;
                        }
                    });
                    html += `</tbody></table></div>`;
                }

                document.getElementById('adminOverview').innerHTML = html;
            } catch (error) {
                document.getElementById('adminOverview').innerHTML = '<p style="color: red;">L·ªói t·∫£i dashboard!</p>';
            }
        }

        // Qu·∫£n l√Ω S·∫£n ph·∫©m
        async function loadAdminProducts() {
            try {
                const search = document.getElementById('searchAdminProduct')?.value || '';
                let url = `${API_URL}/products?limit=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="flex: 1; margin-right: 10px;">
                            <input type="text" id="searchAdminProduct" placeholder="üîç T√¨m ki·∫øm s·∫£n ph·∫©m..." 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                                onkeyup="loadAdminProducts()" value="${search}">
                        </div>
                        <button class="btn btn-primary" onclick="showProductModal()">‚ûï Th√™m s·∫£n ph·∫©m</button>
                    </div>
                    <p style="margin-bottom: 15px; color: #666;">T·ªïng s·ªë s·∫£n ph·∫©m: ${data.total || 0}</p>
                `;

                if (data.products && data.products.length > 0) {
                    html += '<table><thead><tr><th>H√¨nh ·∫£nh</th><th>T√™n s·∫£n ph·∫©m</th><th>Danh m·ª•c</th><th>Gi√°</th><th>T·ªìn kho</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.products.forEach(product => {
                        const price = product.salePrice || product.price;
                        html += `
                            <tr>
                                <td><img src="${product.image || '/placeholder.png'}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                                <td>${product.name}</td>
                                <td>${product.category?.name || 'N/A'}</td>
                                <td>${formatPrice(price)}</td>
                                <td><span style="${product.stock <= product.minStock ? 'color: #e74c3c; font-weight: bold;' : ''}">${product.stock}</span></td>
                                <td><span class="badge badge-${product.status === 1 ? 'success' : 'danger'}">${product.status === 1 ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n'}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewProductDetail('${product._id}')" style="padding: 5px 10px; font-size: 12px;">Xem</button>
                                    <button class="btn btn-success" onclick="editProduct('${product._id}')" style="padding: 5px 10px; font-size: 12px;">S·ª≠a</button>
                                    <button class="btn btn-danger" onclick="deleteProduct('${product._id}')" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o!</p>';
                }

                document.getElementById('adminProducts').innerHTML = html;
            } catch (error) {
                document.getElementById('adminProducts').innerHTML = '<p style="color: red;">L·ªói t·∫£i s·∫£n ph·∫©m!</p>';
            }
        }

        // Qu·∫£n l√Ω ƒê∆°n h√†ng
        async function loadAdminOrders() {
            try {
                const response = await fetch(`${API_URL}/orders?limit=50`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                let html = `
                    <div style="margin-bottom: 20px;">
                        <h3>Danh s√°ch ƒë∆°n h√†ng</h3>
                        <p style="color: #666;">T·ªïng s·ªë ƒë∆°n h√†ng: ${data.total || 0}</p>
                    </div>
                `;

                if (data.orders && data.orders.length > 0) {
                    html += '<table><thead><tr><th>M√£ ƒë∆°n</th><th>Kh√°ch h√†ng</th><th>Ng√†y ƒë·∫∑t</th><th>T·ªïng ti·ªÅn</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.orders.forEach(order => {
                        html += `
                            <tr>
                                <td>${order.orderNumber}</td>
                                <td>${order.customer?.fullName || 'N/A'}</td>
                                <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                                <td>${formatPrice(order.total)}</td>
                                <td><span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewOrderDetail('${order._id}')" style="padding: 5px 10px; font-size: 12px;">Xem</button>
                                    <button class="btn btn-success" onclick="updateOrderStatus('${order._id}')" style="padding: 5px 10px; font-size: 12px;">C·∫≠p nh·∫≠t</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Ch∆∞a c√≥ ƒë∆°n h√†ng n√†o!</p>';
                }

                document.getElementById('adminOrders').innerHTML = html;
            } catch (error) {
                document.getElementById('adminOrders').innerHTML = '<p style="color: red;">L·ªói t·∫£i ƒë∆°n h√†ng!</p>';
            }
        }

        // Qu·∫£n l√Ω Ng∆∞·ªùi d√πng
        async function loadAdminUsers() {
            try {
                const search = document.getElementById('searchAdminUser')?.value || '';
                let url = `${API_URL}/users?limit=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="flex: 1; margin-right: 10px;">
                            <input type="text" id="searchAdminUser" placeholder="üîç T√¨m ki·∫øm ng∆∞·ªùi d√πng..." 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                                onkeyup="loadAdminUsers()" value="${search}">
                        </div>
                        <button class="btn btn-primary" onclick="showUserModal()">‚ûï Th√™m nh√¢n vi√™n</button>
                    </div>
                    <p style="margin-bottom: 15px; color: #666;">T·ªïng s·ªë ng∆∞·ªùi d√πng: ${data.total || 0}</p>
                `;

                if (data.users && data.users.length > 0) {
                    html += '<table><thead><tr><th>T√™n</th><th>Username</th><th>Email</th><th>SƒêT</th><th>Vai tr√≤</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.users.forEach(user => {
                        html += `
                            <tr>
                                <td>${user.fullName}</td>
                                <td>${user.username}</td>
                                <td>${user.email || 'N/A'}</td>
                                <td>${user.phone || 'N/A'}</td>
                                <td><span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'success'}">${user.role}</span></td>
                                <td>
                                    <button class="btn btn-primary" onclick="viewUserDetail('${user._id}')" style="padding: 5px 10px; font-size: 12px;">Xem</button>
                                    <button class="btn btn-success" onclick="editUser('${user._id}')" style="padding: 5px 10px; font-size: 12px;">S·ª≠a</button>
                                    ${user._id !== currentUser.userId ? `<button class="btn btn-danger" onclick="deleteUser('${user._id}')" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>` : ''}
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Ch∆∞a c√≥ ng∆∞·ªùi d√πng n√†o!</p>';
                }

                document.getElementById('adminUsers').innerHTML = html;
            } catch (error) {
                document.getElementById('adminUsers').innerHTML = '<p style="color: red;">L·ªói t·∫£i ng∆∞·ªùi d√πng!</p>';
            }
        }

        // Qu·∫£n l√Ω Danh m·ª•c
        async function loadAdminCategories() {
            try {
                const search = document.getElementById('searchAdminCategory')?.value || '';
                let url = `${API_URL}/categories?limit=50`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                
                let html = `
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div style="flex: 1; margin-right: 10px;">
                            <input type="text" id="searchAdminCategory" placeholder="üîç T√¨m ki·∫øm danh m·ª•c..." 
                                style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                                onkeyup="loadAdminCategories()" value="${search}">
                        </div>
                        <button class="btn btn-primary" onclick="showCategoryModal()">‚ûï Th√™m danh m·ª•c</button>
                    </div>
                    <p style="margin-bottom: 15px; color: #666;">T·ªïng s·ªë danh m·ª•c: ${data.total || 0}</p>
                `;

                if (data.categories && data.categories.length > 0) {
                    html += '<table><thead><tr><th>T√™n danh m·ª•c</th><th>M√¥ t·∫£</th><th>Tr·∫°ng th√°i</th><th>Thao t√°c</th></tr></thead><tbody>';
                    data.categories.forEach(category => {
                        html += `
                            <tr>
                                <td>${category.name}</td>
                                <td>${category.description || 'N/A'}</td>
                                <td><span class="badge badge-${category.status === 1 ? 'success' : 'danger'}">${category.status === 1 ? 'Ho·∫°t ƒë·ªông' : 'Ng·ª´ng'}</span></td>
                                <td>
                                    <button class="btn btn-success" onclick="editCategory('${category._id}')" style="padding: 5px 10px; font-size: 12px;">S·ª≠a</button>
                                    <button class="btn btn-danger" onclick="deleteCategory('${category._id}')" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Ch∆∞a c√≥ danh m·ª•c n√†o!</p>';
                }

                document.getElementById('adminCategories').innerHTML = html;
            } catch (error) {
                document.getElementById('adminCategories').innerHTML = '<p style="color: red;">L·ªói t·∫£i danh m·ª•c!</p>';
            }
        }

        // C√°c h√†m h·ªó tr·ª£
        function viewOrder(orderId) {
            viewOrderDetail(orderId);
        }

        async function viewOrderDetail(orderId) {
            try {
                const response = await fetch(`${API_URL}/orders/${orderId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const order = await response.json();
                
                let html = `
                    <div class="modal" id="orderModal" style="display: block;">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('orderModal')">&times;</span>
                            <h2>Chi ti·∫øt ƒë∆°n h√†ng: ${order.orderNumber}</h2>
                            <div class="section">
                                <h3>Th√¥ng tin kh√°ch h√†ng</h3>
                                <p><strong>T√™n:</strong> ${order.customer?.fullName || 'N/A'}</p>
                                <p><strong>Email:</strong> ${order.customer?.email || 'N/A'}</p>
                                <p><strong>SƒêT:</strong> ${order.customer?.phone || 'N/A'}</p>
                            </div>
                            <div class="section">
                                <h3>ƒê·ªãa ch·ªâ giao h√†ng</h3>
                                <p>${order.shippingAddress?.address || 'N/A'}, ${order.shippingAddress?.city || ''}</p>
                            </div>
                            <div class="section">
                                <h3>S·∫£n ph·∫©m</h3>
                                <table><thead><tr><th>S·∫£n ph·∫©m</th><th>S·ªë l∆∞·ª£ng</th><th>Gi√°</th><th>Th√†nh ti·ªÅn</th></tr></thead><tbody>
                `;
                order.items.forEach(item => {
                    html += `
                        <tr>
                            <td>${item.product?.name || 'N/A'}</td>
                            <td>${item.quantity}</td>
                            <td>${formatPrice(item.price)}</td>
                            <td>${formatPrice(item.subtotal)}</td>
                        </tr>
                    `;
                });
                html += `
                                </tbody></table>
                                <p style="text-align: right; margin-top: 15px;"><strong>T·ªïng ti·ªÅn: ${formatPrice(order.total)}</strong></p>
                            </div>
                            <div class="section">
                                <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge badge-${getStatusColor(order.status)}">${getStatusText(order.status)}</span></p>
                                <p><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${order.paymentMethod || 'COD'}</p>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                alert('L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng!');
            }
        }

        async function viewProductDetail(productId) {
            try {
                const response = await fetch(`${API_URL}/products/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const product = await response.json();
                
                let html = `
                    <div class="modal" id="productModal" style="display: block;">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('productModal')">&times;</span>
                            <h2>Chi ti·∫øt s·∫£n ph·∫©m</h2>
                            <div style="text-align: center; margin-bottom: 20px;">
                                <img src="${product.image || '/placeholder.png'}" style="max-width: 200px; border-radius: 10px;">
                            </div>
                            <div class="section">
                                <p><strong>T√™n:</strong> ${product.name}</p>
                                <p><strong>Danh m·ª•c:</strong> ${product.category?.name || 'N/A'}</p>
                                <p><strong>Gi√° nh·∫≠p:</strong> ${formatPrice(product.importPrice || 0)}</p>
                                <p><strong>Gi√° b√°n:</strong> ${formatPrice(product.price)}</p>
                                ${product.salePrice ? `<p><strong>Gi√° khuy·∫øn m√£i:</strong> ${formatPrice(product.salePrice)}</p>` : ''}
                                <p><strong>T·ªìn kho:</strong> ${product.stock}</p>
                                <p><strong>T·ªëi thi·ªÉu:</strong> ${product.minStock}</p>
                                <p><strong>M√¥ t·∫£:</strong> ${product.description || 'N/A'}</p>
                                <p><strong>Tr·∫°ng th√°i:</strong> <span class="badge badge-${product.status === 1 ? 'success' : 'danger'}">${product.status === 1 ? 'ƒêang b√°n' : 'Ng·ª´ng b√°n'}</span></p>
                            </div>
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="closeModal('productModal'); editProduct('${product._id}')">S·ª≠a s·∫£n ph·∫©m</button>
                                <button class="btn btn-danger" onclick="closeModal('productModal'); deleteProduct('${product._id}')">D·ª´ng b√°n</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                alert('L·ªói t·∫£i chi ti·∫øt s·∫£n ph·∫©m!');
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.remove();
        }

        function updateOrderStatus(orderId) {
            const status = prompt('Nh·∫≠p tr·∫°ng th√°i m·ªõi (new/processing/shipping/completed/cancelled):');
            if (!status) return;
            
            fetch(`${API_URL}/orders/${orderId}/status`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({ status })
            })
            .then(res => res.json())
            .then(data => {
                if (data.order) {
                    alert('C·∫≠p nh·∫≠t tr·∫°ng th√°i th√†nh c√¥ng!');
                    loadAdminOrders();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            })
            .catch(err => alert('L·ªói k·∫øt n·ªëi!'));
        }

        async function showProductModal(productId = null) {
            let product = null;
            let categories = [];
            
            // Load categories
            try {
                const catResponse = await fetch(`${API_URL}/categories/all`);
                categories = await catResponse.json();
            } catch (e) {
                console.error('Load categories error:', e);
            }
            
            // N·∫øu c√≥ productId th√¨ load s·∫£n ph·∫©m ƒë·ªÉ s·ª≠a
            if (productId) {
                try {
                    const response = await fetch(`${API_URL}/products/${productId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    product = await response.json();
                } catch (e) {
                    alert('L·ªói t·∫£i th√¥ng tin s·∫£n ph·∫©m!');
                    return;
                }
            }
            
            const categoryOptions = categories.map(cat => 
                `<option value="${cat._id}" ${product && product.category?._id === cat._id ? 'selected' : ''}>${cat.name}</option>`
            ).join('');
            
            const html = `
                <div class="modal" id="productFormModal" style="display: block;">
                    <div class="modal-content" style="max-width: 700px;">
                        <span class="close" onclick="closeModal('productFormModal')">&times;</span>
                        <h2>${productId ? 'S·ª≠a s·∫£n ph·∫©m' : 'Th√™m s·∫£n ph·∫©m m·ªõi'}</h2>
                        <form id="productForm" onsubmit="saveProduct(event, '${productId || ''}')">
                            <div class="form-group">
                                <label>T√™n s·∫£n ph·∫©m *</label>
                                <input type="text" id="productName" value="${product?.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>Danh m·ª•c *</label>
                                <select id="productCategory" required>
                                    <option value="">-- Ch·ªçn danh m·ª•c --</option>
                                    ${categoryOptions}
                                </select>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Gi√° nh·∫≠p *</label>
                                    <input type="number" id="productImportPrice" value="${product?.importPrice || ''}" min="0" required>
                                </div>
                                <div class="form-group">
                                    <label>Gi√° b√°n *</label>
                                    <input type="number" id="productPrice" value="${product?.price || ''}" min="0" required>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Gi√° khuy·∫øn m√£i</label>
                                    <input type="number" id="productSalePrice" value="${product?.salePrice || ''}" min="0">
                                </div>
                                <div class="form-group">
                                    <label>Tr·∫°ng th√°i</label>
                                    <select id="productStatus">
                                        <option value="1" ${product?.status === 1 ? 'selected' : ''}>ƒêang b√°n</option>
                                        <option value="0" ${product?.status === 0 ? 'selected' : ''}>Ng·ª´ng b√°n</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>S·ªë l∆∞·ª£ng t·ªìn kho</label>
                                    <input type="number" id="productStock" value="${product?.stock || 0}" min="0">
                                </div>
                                <div class="form-group">
                                    <label>S·ªë l∆∞·ª£ng t·ªëi thi·ªÉu</label>
                                    <input type="number" id="productMinStock" value="${product?.minStock || 10}" min="0">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Link ·∫£nh</label>
                                <input type="text" id="productImage" value="${product?.image || ''}" placeholder="https://...">
                            </div>
                            <div class="form-group">
                                <label>M√¥ t·∫£</label>
                                <textarea id="productDescription" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${product?.description || ''}</textarea>
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">${productId ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                                <button type="button" class="btn btn-danger" onclick="closeModal('productFormModal')">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function editProduct(id) {
            showProductModal(id);
        }

        async function saveProduct(event, productId) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                importPrice: document.getElementById('productImportPrice').value,
                price: document.getElementById('productPrice').value,
                salePrice: document.getElementById('productSalePrice').value || undefined,
                stock: document.getElementById('productStock').value || 0,
                minStock: document.getElementById('productMinStock').value || 10,
                description: document.getElementById('productDescription').value,
                image: document.getElementById('productImage').value,
                status: parseInt(document.getElementById('productStatus').value)
            };

            const url = productId ? `${API_URL}/products/${productId}` : `${API_URL}/products`;
            const method = productId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (response.ok) {
                    alert(data.message || (productId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m m·ªõi th√†nh c√¥ng!'));
                    closeModal('productFormModal');
                    loadAdminProducts();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        function deleteProduct(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a/·∫©n s·∫£n ph·∫©m n√†y?')) return;
            fetch(`${API_URL}/products/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || 'X√≥a th√†nh c√¥ng!');
                loadAdminProducts();
            })
            .catch(err => alert('L·ªói!'));
        }

        // ƒê√≥ng modal khi click b√™n ngo√†i
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        async function showUserModal(userId = null) {
            let user = null;
            
            if (userId) {
                try {
                    const response = await fetch(`${API_URL}/users/${userId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    user = await response.json();
                } catch (e) {
                    alert('L·ªói t·∫£i th√¥ng tin ng∆∞·ªùi d√πng!');
                    return;
                }
            }
            
            const html = `
                <div class="modal" id="userFormModal" style="display: block;">
                    <div class="modal-content" style="max-width: 600px;">
                        <span class="close" onclick="closeModal('userFormModal')">&times;</span>
                        <h2>${userId ? 'S·ª≠a nh√¢n vi√™n' : 'Th√™m nh√¢n vi√™n m·ªõi'}</h2>
                        <form id="userForm" onsubmit="saveUser(event, '${userId || ''}')">
                            <div class="form-group">
                                <label>Username *</label>
                                <input type="text" id="userUsername" value="${user?.username || ''}" ${userId ? 'readonly' : 'required'}>
                            </div>
                            ${!userId ? `
                            <div class="form-group">
                                <label>M·∫≠t kh·∫©u *</label>
                                <input type="password" id="userPassword" required>
                            </div>
                            ` : `
                            <div class="form-group">
                                <label>M·∫≠t kh·∫©u m·ªõi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng ƒë·ªïi)</label>
                                <input type="password" id="userPassword">
                            </div>
                            `}
                            <div class="form-group">
                                <label>H·ªç v√† t√™n *</label>
                                <input type="text" id="userFullName" value="${user?.fullName || ''}" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Gi·ªõi t√≠nh</label>
                                    <select id="userGender">
                                        <option value="male" ${user?.gender === 'male' ? 'selected' : ''}>Nam</option>
                                        <option value="female" ${user?.gender === 'female' ? 'selected' : ''}>N·ªØ</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Vai tr√≤</label>
                                    <select id="userRole">
                                        <option value="staff" ${user?.role === 'staff' ? 'selected' : ''}>Nh√¢n vi√™n</option>
                                        <option value="admin" ${user?.role === 'admin' ? 'selected' : ''}>Admin</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>S·ªë ƒëi·ªán tho·∫°i</label>
                                    <input type="text" id="userPhone" value="${user?.phone || ''}">
                                </div>
                                <div class="form-group">
                                    <label>Ng√†y sinh</label>
                                    <input type="date" id="userDateOfBirth" value="${user?.dateOfBirth ? new Date(user.dateOfBirth).toISOString().split('T')[0] : ''}">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Avatar (link)</label>
                                <input type="text" id="userAvatar" value="${user?.avatar || ''}" placeholder="https://...">
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">${userId ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                                <button type="button" class="btn btn-danger" onclick="closeModal('userFormModal')">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function viewUserDetail(id) {
            try {
                const response = await fetch(`${API_URL}/users/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const user = await response.json();
                
                // L·∫•y th·ªëng k√™ ƒë∆°n h√†ng n·∫øu l√† customer
                let orderStats = '';
                if (user.role === 'customer') {
                    try {
                        const orderResponse = await fetch(`${API_URL}/users/${id}/orders`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const orders = await orderResponse.json();
                        const completedOrders = orders.filter(o => o.status === 'completed');
                        const totalSpent = completedOrders.reduce((sum, o) => sum + o.total, 0);
                        orderStats = `
                            <div class="section">
                                <h3>Th·ªëng k√™ mua h√†ng</h3>
                                <p><strong>S·ªë ƒë∆°n h√†ng:</strong> ${completedOrders.length}</p>
                                <p><strong>T·ªïng ti·ªÅn ƒë√£ mua:</strong> ${formatPrice(totalSpent)}</p>
                            </div>
                        `;
                    } catch (e) {
                        console.error('Load order stats error:', e);
                    }
                }
                
                const html = `
                    <div class="modal" id="userDetailModal" style="display: block;">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('userDetailModal')">&times;</span>
                            <h2>Chi ti·∫øt ng∆∞·ªùi d√πng</h2>
                            <div class="section">
                                <h3>Th√¥ng tin c√° nh√¢n</h3>
                                <p><strong>Username:</strong> ${user.username}</p>
                                <p><strong>H·ªç v√† t√™n:</strong> ${user.fullName}</p>
                                <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                <p><strong>S·ªë ƒëi·ªán tho·∫°i:</strong> ${user.phone || 'N/A'}</p>
                                <p><strong>Gi·ªõi t√≠nh:</strong> ${user.gender === 'male' ? 'Nam' : 'N·ªØ'}</p>
                                <p><strong>Ng√†y sinh:</strong> ${user.dateOfBirth ? new Date(user.dateOfBirth).toLocaleDateString('vi-VN') : 'N/A'}</p>
                                <p><strong>Vai tr√≤:</strong> <span class="badge badge-${user.role === 'admin' ? 'danger' : user.role === 'staff' ? 'warning' : 'success'}">${user.role}</span></p>
                            </div>
                            ${orderStats}
                            <div class="action-buttons">
                                <button class="btn btn-success" onclick="closeModal('userDetailModal'); editUser('${user._id}')">S·ª≠a th√¥ng tin</button>
                                <button class="btn btn-danger" onclick="closeModal('userDetailModal')">ƒê√≥ng</button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch (error) {
                alert('L·ªói t·∫£i chi ti·∫øt ng∆∞·ªùi d√πng!');
            }
        }

        async function editUser(id) {
            showUserModal(id);
        }

        async function saveUser(event, userId) {
            event.preventDefault();
            const formData = {
                fullName: document.getElementById('userFullName').value,
                gender: document.getElementById('userGender').value,
                role: document.getElementById('userRole').value,
                phone: document.getElementById('userPhone').value || undefined,
                dateOfBirth: document.getElementById('userDateOfBirth').value || undefined,
                avatar: document.getElementById('userAvatar').value || undefined
            };
            
            const password = document.getElementById('userPassword').value;
            if (password) {
                formData.password = password;
            }
            
            // N·∫øu th√™m m·ªõi th√¨ c·∫ßn username v√† password
            if (!userId) {
                formData.username = document.getElementById('userUsername').value;
                if (!password) {
                    alert('Vui l√≤ng nh·∫≠p m·∫≠t kh·∫©u!');
                    return;
                }
            }

            const url = userId ? `${API_URL}/users/${userId}` : `${API_URL}/users`;
            const method = userId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (response.ok) {
                    alert(data.message || (userId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m m·ªõi th√†nh c√¥ng!'));
                    closeModal('userFormModal');
                    loadAdminUsers();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        function deleteUser(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ng∆∞·ªùi d√πng n√†y?')) return;
            fetch(`${API_URL}/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || 'X√≥a th√†nh c√¥ng!');
                loadAdminUsers();
            })
            .catch(err => alert('L·ªói!'));
        }

        async function showCategoryModal(categoryId = null) {
            let category = null;
            
            if (categoryId) {
                try {
                    const response = await fetch(`${API_URL}/categories/${categoryId}`, {
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    category = await response.json();
                } catch (e) {
                    alert('L·ªói t·∫£i th√¥ng tin danh m·ª•c!');
                    return;
                }
            }
            
            const html = `
                <div class="modal" id="categoryFormModal" style="display: block;">
                    <div class="modal-content" style="max-width: 500px;">
                        <span class="close" onclick="closeModal('categoryFormModal')">&times;</span>
                        <h2>${categoryId ? 'S·ª≠a danh m·ª•c' : 'Th√™m danh m·ª•c m·ªõi'}</h2>
                        <form id="categoryForm" onsubmit="saveCategory(event, '${categoryId || ''}')">
                            <div class="form-group">
                                <label>T√™n danh m·ª•c *</label>
                                <input type="text" id="categoryName" value="${category?.name || ''}" required>
                            </div>
                            <div class="form-group">
                                <label>M√¥ t·∫£</label>
                                <textarea id="categoryDescription" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">${category?.description || ''}</textarea>
                            </div>
                            ${categoryId ? `
                            <div class="form-group">
                                <label>Tr·∫°ng th√°i</label>
                                <select id="categoryStatus">
                                    <option value="1" ${category?.status === 1 ? 'selected' : ''}>Ho·∫°t ƒë·ªông</option>
                                    <option value="0" ${category?.status === 0 ? 'selected' : ''}>Ng·ª´ng</option>
                                </select>
                            </div>
                            ` : ''}
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">${categoryId ? 'C·∫≠p nh·∫≠t' : 'Th√™m m·ªõi'}</button>
                                <button type="button" class="btn btn-danger" onclick="closeModal('categoryFormModal')">H·ªßy</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', html);
        }

        async function editCategory(id) {
            showCategoryModal(id);
        }

        async function saveCategory(event, categoryId) {
            event.preventDefault();
            const formData = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value || undefined
            };
            
            if (categoryId) {
                formData.status = parseInt(document.getElementById('categoryStatus').value);
            }

            const url = categoryId ? `${API_URL}/categories/${categoryId}` : `${API_URL}/categories`;
            const method = categoryId ? 'PUT' : 'POST';

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(formData)
                });

                const data = await response.json();
                if (response.ok) {
                    alert(data.message || (categoryId ? 'C·∫≠p nh·∫≠t th√†nh c√¥ng!' : 'Th√™m m·ªõi th√†nh c√¥ng!'));
                    closeModal('categoryFormModal');
                    loadAdminCategories();
                } else {
                    alert(data.message || 'L·ªói!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        function deleteCategory(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?')) return;
            fetch(`${API_URL}/categories/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${token}` }
            })
            .then(res => res.json())
            .then(data => {
                alert(data.message || 'X√≥a th√†nh c√¥ng!');
                loadAdminCategories();
            })
            .catch(err => alert('L·ªói!'));
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'M·ªõi',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'shipping': 'ƒêang giao',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy'
            };
            return statusMap[status] || status;
        }

        function getStatusColor(status) {
            const colorMap = {
                'new': 'warning',
                'processing': 'warning',
                'shipping': 'warning',
                'completed': 'success',
                'cancelled': 'danger'
            };
            return colorMap[status] || 'warning';
        }

        function formatPrice(price) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(price);
        }

        function showAlert(id, message, type) {
            const alertDiv = document.getElementById(id);
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            setTimeout(() => {
                alertDiv.textContent = '';
                alertDiv.className = '';
            }, 3000);
        }
    </script>
</body>
</html>

