<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Shop THB</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-box {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            width: 100%;
            max-width: 400px;
        }

        .login-box h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            width: 100%;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
        }

        .btn-danger {
            background: #e74c3c;
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .error-message {
            color: #e74c3c;
            margin-top: 10px;
            font-size: 14px;
        }

        /* Admin Dashboard */
        .admin-container {
            display: none;
        }

        .admin-container.active {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .admin-sidebar {
            width: 260px;
            background: linear-gradient(180deg, #1e3a8a 0%, #1e40af 100%);
            color: white;
            padding: 0;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 100;
        }

        .logo-container {
            padding: 25px 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-icon svg {
            width: 100%;
            height: 100%;
        }

        .logo-text {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .sidebar-menu {
            padding: 20px 0;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            color: rgba(255,255,255,0.8);
            cursor: pointer;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
            border-left-color: #60a5fa;
        }

        .menu-item.active {
            background: rgba(255,255,255,0.15);
            color: white;
            border-left-color: #60a5fa;
            font-weight: 600;
        }

        .menu-item-icon {
            font-size: 20px;
            width: 24px;
            text-align: center;
        }

        .menu-item-text {
            flex: 1;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            margin-left: 260px;
            background: #f8fafc;
        }

        .admin-header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .admin-header h1 {
            font-size: 24px;
            color: #1e293b;
            margin: 0;
        }

        .admin-actions {
            display: flex;
            gap: 10px;
        }

        .admin-content {
            padding: 30px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 30px;
        }

        .dashboard-card {
            background: white;
            padding: 28px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid #e2e8f0;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .dashboard-card-icon {
            font-size: 42px;
            margin-bottom: 16px;
            display: inline-block;
        }

        .dashboard-card h3 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 18px;
            font-weight: 600;
        }

        .dashboard-card p {
            color: #64748b;
            font-size: 14px;
            margin: 0;
        }

        /* Table Styles */
        .table-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid #e2e8f0;
        }

        .table-header {
            padding: 24px 28px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .table-header h2 {
            color: #1e293b;
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .search-box {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .search-box input {
            padding: 10px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box select {
            padding: 10px 14px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 14px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .search-box select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #475569;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        tr:hover {
            background: #f8fafc;
        }

        td {
            color: #334155;
            font-size: 14px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .unread-badge {
            background: #ef4444;
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            min-width: 20px;
            text-align: center;
        }
        
        .chat-customer-item {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .chat-customer-item:hover {
            background: #f8f9fa;
        }
        
        .chat-customer-item.active {
            background: #e0e7ff;
            border-left: 4px solid #667eea;
        }
        
        .chat-message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .chat-message.admin {
            align-items: flex-end;
        }
        
        .chat-message.customer {
            align-items: flex-start;
        }
        
        .chat-message-bubble {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }
        
        .chat-message.admin .chat-message-bubble {
            background: #667eea;
            color: white;
        }
        
        .chat-message.customer .chat-message-bubble {
            background: white;
            color: #333;
            border: 1px solid #e2e8f0;
        }
        
        .chat-message-time {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .status-new { background: #e3f2fd; color: #1976d2; }
        .status-processing { background: #fff3e0; color: #f57c00; }
        .status-shipping { background: #f3e5f5; color: #7b1fa2; }
        .status-completed { background: #e8f5e9; color: #388e3c; }
        .status-cancelled { background: #ffebee; color: #d32f2f; }

        .btn-sm {
            padding: 6px 12px;
            font-size: 14px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            margin: 0 3px;
        }

        .btn-edit {
            background: #667eea;
            color: white;
        }

        .btn-delete {
            background: #e74c3c;
            color: white;
        }

        .btn-view {
            background: #27ae60;
            color: white;
        }

        /* Form Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .form-group-full {
            grid-column: 1 / -1;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            padding: 20px;
        }

        .pagination button {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 5px;
        }

        .pagination button.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Statistics */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        /* ƒê·∫£m b·∫£o grid items kh√¥ng tr√†n */
        .stats-grid > * {
            min-width: 0;
            overflow: hidden;
        }
        
        /* Chart containers */
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: relative;
            height: 400px;
        }
        
        .chart-container h3 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
            .chart-wrapper {
                height: 250px;
            }
        }

        .stat-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
            transition: all 0.3s;
            min-width: 0; /* Cho ph√©p shrink */
            overflow: hidden; /* Tr√°nh tr√†n */
            word-wrap: break-word; /* Xu·ªëng d√≤ng khi c·∫ßn */
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
            cursor: pointer;
        }
        
        .stat-card.clickable {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .stat-card.clickable:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }

        .stat-card h4 {
            color: #64748b;
            font-size: 13px;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 500;
        }

        .stat-card .value {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            word-break: break-word;
            overflow-wrap: break-word;
            line-height: 1.2;
            max-width: 100%;
        }
        
        /* Responsive cho s·ªë nh·ªè h∆°n */
        @media (max-width: 768px) {
            .stat-card .value {
                font-size: 24px;
            }
        }
        
        /* Cho s·ªë r·∫•t d√†i */
        .stat-card .value[style*="color"] {
            font-size: clamp(18px, 4vw, 28px);
        }

        /* Hidden */
        .hidden {
            display: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #999;
        }
        
        /* Date picker improvements */
        input[type="date"] {
            position: relative;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 10px;
            cursor: pointer;
            opacity: 0.6;
            width: 20px;
            height: 20px;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator:hover {
            opacity: 1;
        }
        
        input[type="date"]:focus {
            outline: 2px solid #667eea;
            outline-offset: 2px;
            border-color: #667eea;
        }
        
        /* Custom date input wrapper */
        .date-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }
        
        .date-input-wrapper input[type="date"] {
            width: 100%;
        }
        
        .date-input-wrapper::after {
            content: 'üìÖ';
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: #667eea;
            font-size: 18px;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h1>ƒêƒÉng nh·∫≠p Admin</h1>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginEmail" placeholder="Nh·∫≠p username" required>
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u</label>
                    <input type="password" id="loginPassword" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" required>
                </div>
                <button type="submit" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>
                <div id="loginError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Admin Dashboard -->
    <div id="adminScreen" class="admin-container">
        <!-- Sidebar -->
        <div class="admin-sidebar">
            <div class="logo-container">
                <div class="logo-icon">
                    <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                        <!-- Monitor outline -->
                        <rect x="15" y="20" width="70" height="50" fill="none" stroke="white" stroke-width="2.5" rx="3"/>
                        <!-- Monitor stand -->
                        <rect x="40" y="70" width="20" height="8" fill="white"/>
                        <rect x="35" y="78" width="30" height="3" fill="white" rx="1"/>
                        <!-- Circuit board lines inside monitor -->
                        <line x1="25" y1="35" x2="75" y2="35" stroke="white" stroke-width="1.5"/>
                        <line x1="25" y1="45" x2="75" y2="45" stroke="white" stroke-width="1.5"/>
                        <line x1="25" y1="55" x2="75" y2="55" stroke="white" stroke-width="1.5"/>
                        <!-- Circuit components (circles) -->
                        <circle cx="30" cy="35" r="2" fill="white"/>
                        <circle cx="50" cy="35" r="2" fill="white"/>
                        <circle cx="70" cy="35" r="2" fill="white"/>
                        <circle cx="35" cy="45" r="2" fill="white"/>
                        <circle cx="55" cy="45" r="2" fill="white"/>
                        <circle cx="40" cy="55" r="2" fill="white"/>
                        <circle cx="60" cy="55" r="2" fill="white"/>
                        <!-- Vertical connections -->
                        <line x1="30" y1="33" x2="30" y2="37" stroke="white" stroke-width="1"/>
                        <line x1="50" y1="33" x2="50" y2="37" stroke="white" stroke-width="1"/>
                        <line x1="35" y1="43" x2="35" y2="47" stroke="white" stroke-width="1"/>
                        <!-- Curved lines around monitor -->
                        <path d="M 10 25 Q 5 20, 10 15" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                        <path d="M 90 25 Q 95 20, 90 15" stroke="white" stroke-width="2" fill="none" stroke-linecap="round"/>
                    </svg>
                </div>
                <div class="logo-text">THB</div>
            </div>
            <div class="sidebar-menu">
                <div class="menu-item active" onclick="showDashboard()">
                    <span class="menu-item-icon">üìä</span>
                    <span class="menu-item-text">T·ªïng quan</span>
                </div>
                <div class="menu-item" onclick="showOrders()">
                    <span class="menu-item-icon">üõí</span>
                    <span class="menu-item-text">ƒê∆°n h√†ng</span>
                </div>
                <div class="menu-item" onclick="showProducts()">
                    <span class="menu-item-icon">üì¶</span>
                    <span class="menu-item-text">S·∫£n ph·∫©m</span>
                </div>
                <div class="menu-item" onclick="showCategories()">
                    <span class="menu-item-icon">üìÅ</span>
                    <span class="menu-item-text">Danh m·ª•c</span>
                </div>
                <div class="menu-item" onclick="showCustomers()">
                    <span class="menu-item-icon">üë•</span>
                    <span class="menu-item-text">Kh√°ch h√†ng</span>
                </div>
                <div class="menu-item" onclick="showStatistics()">
                    <span class="menu-item-icon">üìà</span>
                    <span class="menu-item-text">Th·ªëng k√™</span>
                </div>
                <div class="menu-item" onclick="showVouchers()">
                    <span class="menu-item-icon">üé´</span>
                    <span class="menu-item-text">Qu·∫£n l√Ω Voucher</span>
                </div>
                <div class="menu-item" onclick="showChatSupport()">
                    <span class="menu-item-icon">üí¨</span>
                    <span class="menu-item-text">H·ªó tr·ª£ kh√°ch h√†ng</span>
                    <span id="chatUnreadBadge" class="unread-badge" style="display: none;">0</span>
                </div>
                <div class="menu-item" onclick="showReviews()">
                    <span class="menu-item-icon">‚≠ê</span>
                    <span class="menu-item-text">ƒê√°nh gi√°</span>
                </div>
                <div class="menu-item" onclick="showAPIManagement()">
                    <span class="menu-item-icon">üîå</span>
                    <span class="menu-item-text">Qu·∫£n l√Ω API</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="admin-main">
            <div class="admin-header">
                <h1 id="pageTitle">T·ªïng quan</h1>
                <div class="admin-actions">
                    <button class="btn btn-primary" onclick="showChangePassword()" style="width: auto; padding: 10px 20px;">ƒê·ªïi m·∫≠t kh·∫©u</button>
                    <button class="btn btn-danger" onclick="logout()" style="width: auto; padding: 10px 20px;">ƒêƒÉng xu·∫•t</button>
                </div>
            </div>

            <div class="admin-content">
                <!-- Dashboard Menu -->
                <div id="dashboardMenu" class="dashboard-grid">
                <div class="dashboard-card" onclick="showOrders()">
                    <div class="dashboard-card-icon">üõí</div>
                    <h3>ƒê∆°n h√†ng</h3>
                    <p>Qu·∫£n l√Ω ƒë∆°n h√†ng</p>
                </div>
                <div class="dashboard-card" onclick="showCategories()">
                    <div class="dashboard-card-icon">üìÅ</div>
                    <h3>Danh m·ª•c</h3>
                    <p>Qu·∫£n l√Ω danh m·ª•c</p>
                </div>
                <div class="dashboard-card" onclick="showProducts()">
                    <div class="dashboard-card-icon">üì¶</div>
                    <h3>S·∫£n ph·∫©m</h3>
                    <p>Qu·∫£n l√Ω s·∫£n ph·∫©m</p>
                </div>
                <div class="dashboard-card" onclick="showCustomers()">
                    <div class="dashboard-card-icon">üë•</div>
                    <h3>Kh√°ch h√†ng</h3>
                    <p>Qu·∫£n l√Ω kh√°ch h√†ng</p>
                </div>
                <div class="dashboard-card" onclick="showStatistics()">
                    <div class="dashboard-card-icon">üìä</div>
                    <h3>Th·ªëng k√™</h3>
                    <p>Xem th·ªëng k√™</p>
                </div>
                <div class="dashboard-card" onclick="showVouchers()">
                    <div class="dashboard-card-icon">üé´</div>
                    <h3>Qu·∫£n l√Ω Voucher</h3>
                    <p>Qu·∫£n l√Ω voucher kh√°ch h√†ng</p>
                </div>
                <div class="dashboard-card" onclick="showReviews()">
                    <div class="dashboard-card-icon">‚≠ê</div>
                    <h3>ƒê√°nh gi√°</h3>
                    <p>Qu·∫£n l√Ω ƒë√°nh gi√° s·∫£n ph·∫©m</p>
                </div>
                <div class="dashboard-card" onclick="showAPIManagement()">
                    <div class="dashboard-card-icon">üîå</div>
                    <h3>Qu·∫£n l√Ω API</h3>
                    <p>Xem danh s√°ch API endpoints</p>
                </div>
            </div>

            <!-- Orders Management -->
            <div id="ordersSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω ƒë∆°n h√†ng</h2>
                        <div class="search-box">
                            <input type="text" id="orderSearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadOrders()">
                            <select id="orderStatusFilter" onchange="loadOrders()">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="new">M·ªõi</option>
                                <option value="processing">ƒêang x·ª≠ l√Ω</option>
                                <option value="shipping">ƒêang giao</option>
                                <option value="completed">Ho√†n th√†nh</option>
                                <option value="cancelled">ƒê√£ h·ªßy</option>
                                <option value="returning">ƒêang ho√†n h√†ng</option>
                                <option value="exchanging">ƒêang ƒë·ªïi h√†ng</option>
                            </select>
                        </div>
                    </div>
                    <div id="ordersTable"></div>
                    <div id="ordersPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Products Management -->
            <div id="productsSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω s·∫£n ph·∫©m</h2>
                        <div class="search-box">
                            <input type="text" id="productSearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadProducts()">
                            <button class="btn btn-primary" onclick="showAddProduct()">Th√™m s·∫£n ph·∫©m</button>
                        </div>
                    </div>
                    <div id="productsTable"></div>
                    <div id="productsPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Categories Management -->
            <div id="categoriesSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω danh m·ª•c</h2>
                        <div class="search-box">
                            <input type="text" id="categorySearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadCategories()">
                            <button class="btn btn-primary" onclick="showAddCategory()">Th√™m danh m·ª•c</button>
                        </div>
                    </div>
                    <div id="categoriesTable"></div>
                    <div id="categoriesPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Customers Management -->
            <div id="customersSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω kh√°ch h√†ng</h2>
                        <div class="search-box">
                            <input type="text" id="customerSearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadCustomers()">
                        </div>
                    </div>
                    <div id="customersTable"></div>
                    <div id="customersPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Statistics -->
            <div id="statisticsSection" class="hidden">
                <h2 style="margin-bottom: 20px;">Th·ªëng k√™</h2>
                <div id="statisticsContent"></div>
            </div>

            <!-- Vouchers Management -->
            <div id="vouchersSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω Voucher</h2>
                        <div class="search-box">
                            <input type="text" id="voucherSearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadVouchers()">
                            <select id="voucherStatusFilter" onchange="loadVouchers()">
                                <option value="">T·∫•t c·∫£ tr·∫°ng th√°i</option>
                                <option value="1">Ho·∫°t ƒë·ªông</option>
                                <option value="0">·∫®n</option>
                            </select>
                            <button class="btn btn-primary" onclick="showAddVoucher()">Th√™m voucher</button>
                        </div>
                    </div>
                    <div id="vouchersTable"></div>
                    <div id="vouchersPagination" class="pagination"></div>
                </div>
            </div>

            <!-- Chat Support -->
            <div id="chatSupportSection" class="hidden">
                <div style="display: flex; height: calc(100vh - 120px); gap: 20px;">
                    <!-- Danh s√°ch kh√°ch h√†ng -->
                    <div style="width: 350px; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                        <div style="padding: 20px; border-bottom: 1px solid #e2e8f0;">
                            <h2 style="margin: 0; color: #333;">üí¨ H·ªó tr·ª£ kh√°ch h√†ng</h2>
                            <div style="margin-top: 15px;">
                                <input type="text" id="chatSearchCustomer" placeholder="T√¨m ki·∫øm kh√°ch h√†ng..." 
                                    style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                                    onkeyup="filterChatCustomers()">
                            </div>
                        </div>
                        <div id="chatCustomersList" style="flex: 1; overflow-y: auto; padding: 10px;">
                            <div class="loading">ƒêang t·∫£i...</div>
                        </div>
                    </div>
                    
                    <!-- Chat window -->
                    <div style="flex: 1; background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column;">
                        <div id="chatWindowHeader" style="padding: 20px; border-bottom: 1px solid #e2e8f0; display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h3 style="margin: 0; color: #333;" id="chatCustomerName">Ch·ªçn kh√°ch h√†ng</h3>
                                    <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;" id="chatCustomerInfo"></p>
                                </div>
                                <button onclick="closeChatWindow()" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                            </div>
                        </div>
                        <div id="chatMessagesContainer" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8f9fa;">
                            <div style="text-align: center; color: #999; padding: 40px;">
                                <p>Ch·ªçn m·ªôt kh√°ch h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p>
                            </div>
                        </div>
                        <div id="chatInputContainer" style="padding: 20px; border-top: 1px solid #e2e8f0; display: none;">
                            <form id="chatMessageForm" onsubmit="sendChatMessage(event)" style="display: flex; gap: 10px;">
                                <input type="text" id="chatMessageInput" placeholder="Nh·∫≠p tin nh·∫Øn..." 
                                    style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;"
                                    required>
                                <button type="submit" id="chatSendBtn" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                    G·ª≠i
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- API Management -->
            <!-- Reviews Management -->
            <div id="reviewsSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω ƒê√°nh gi√°</h2>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <select id="reviewProductFilter" onchange="loadReviews()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>
                            </select>
                            <select id="reviewRatingFilter" onchange="loadReviews()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">T·∫•t c·∫£ ƒë√°nh gi√°</option>
                                <option value="5">5 sao</option>
                                <option value="4">4 sao</option>
                                <option value="3">3 sao</option>
                                <option value="2">2 sao</option>
                                <option value="1">1 sao</option>
                            </select>
                            <select id="reviewVisibilityFilter" onchange="loadReviews()" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px;">
                                <option value="">T·∫•t c·∫£</option>
                                <option value="true">ƒêang hi·ªÉn th·ªã</option>
                                <option value="false">ƒêang ·∫©n</option>
                            </select>
                            <div class="search-box">
                                <input type="text" id="reviewSearch" placeholder="T√¨m ki·∫øm..." onkeyup="loadReviews()">
                            </div>
                            <button class="btn btn-primary" onclick="loadReviews()">üîÑ L√†m m·ªõi</button>
                        </div>
                    </div>
                    <div id="reviewsContent">
                        <p style="text-align: center; padding: 40px; color: #999;">ƒêang t·∫£i...</p>
                    </div>
                </div>
            </div>

            <div id="apiManagementSection" class="hidden">
                <div class="table-container">
                    <div class="table-header">
                        <h2>Qu·∫£n l√Ω API Endpoints</h2>
                        <div class="search-box">
                            <input type="text" id="apiSearch" placeholder="T√¨m ki·∫øm endpoint..." onkeyup="filterAPIs()">
                        </div>
                    </div>
                    <div id="apiContent" style="padding: 24px;">
                        <div id="apiList"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Change Password Modal -->
    <div id="changePasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ƒê·ªïi m·∫≠t kh·∫©u</h2>
                <button class="close-btn" onclick="closeModal('changePasswordModal')">&times;</button>
            </div>
            <form id="changePasswordForm">
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
                    <input type="password" id="oldPassword" required>
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label>X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit" class="btn btn-primary">ƒê·ªïi m·∫≠t kh·∫©u</button>
                <div id="changePasswordError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Product Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="productModalTitle">Th√™m s·∫£n ph·∫©m</h2>
                <button class="close-btn" onclick="closeModal('productModal')">&times;</button>
            </div>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group">
                    <label>T√™n s·∫£n ph·∫©m</label>
                    <input type="text" id="productName" required>
                </div>
                <div class="form-group">
                    <label>Danh m·ª•c</label>
                    <select id="productCategory" required></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Gi√° nh·∫≠p</label>
                        <input type="number" id="productImportPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Gi√° b√°n</label>
                        <input type="number" id="productPrice" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë l∆∞·ª£ng</label>
                        <input type="number" id="productStock" required>
                    </div>
                    <div class="form-group">
                        <label>T·ªìn kho t·ªëi thi·ªÉu</label>
                        <input type="number" id="productMinStock" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Link ·∫£nh</label>
                    <input type="text" id="productImage">
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="productDescription" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <div id="productError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div id="categoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="categoryModalTitle">Th√™m danh m·ª•c</h2>
                <button class="close-btn" onclick="closeModal('categoryModal')">&times;</button>
            </div>
            <form id="categoryForm">
                <input type="hidden" id="categoryId">
                <div class="form-group">
                    <label>T√™n danh m·ª•c</label>
                    <input type="text" id="categoryName" required>
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="categoryDescription" rows="4" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <div id="categoryError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Add/Edit Voucher Modal -->
    <div id="voucherModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="voucherModalTitle">Th√™m voucher</h2>
                <button class="close-btn" onclick="closeModal('voucherModal')">&times;</button>
            </div>
            <form id="voucherForm">
                <input type="hidden" id="voucherId">
                <div class="form-row">
                    <div class="form-group">
                        <label>M√£ voucher *</label>
                        <input type="text" id="voucherCode" required style="text-transform: uppercase;">
                    </div>
                    <div class="form-group">
                        <label>T√™n voucher *</label>
                        <input type="text" id="voucherName" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>M√¥ t·∫£</label>
                    <textarea id="voucherDescription" rows="3" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Lo·∫°i *</label>
                        <select id="voucherType" required onchange="toggleVoucherFields()">
                            <option value="percentage">Ph·∫ßn trƒÉm (%)</option>
                            <option value="fixed">S·ªë ti·ªÅn c·ªë ƒë·ªãnh (VNƒê)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Gi√° tr·ªã *</label>
                        <input type="number" id="voucherValue" required min="0" step="0.01">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group" id="maxDiscountGroup" style="display: none;">
                        <label>Gi·∫£m gi√° t·ªëi ƒëa (VNƒê)</label>
                        <input type="number" id="voucherMaxDiscount" min="0">
                    </div>
                    <div class="form-group">
                        <label>ƒê∆°n h√†ng t·ªëi thi·ªÉu (VNƒê)</label>
                        <input type="number" id="voucherMinOrderValue" min="0" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>S·ªë l∆∞·ª£ng *</label>
                        <input type="number" id="voucherQuantity" required min="1">
                        <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">
                            üí° T·ªïng s·ªë voucher c√≥ th·ªÉ s·ª≠ d·ª•ng
                        </small>
                    </div>
                    <div class="form-group">
                        <label>ƒê√£ d√πng</label>
                        <input type="number" id="voucherUsedCount" min="0" value="0">
                        <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">
                            üí° S·ªë l∆∞·ª£ng voucher ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng. C√≥ th·ªÉ reset v·ªÅ 0 ƒë·ªÉ kh√¥i ph·ª•c voucher ƒë√£ h·∫øt h·∫°n.
                        </small>
                    </div>
                    <div class="form-group">
                        <label>Tr·∫°ng th√°i</label>
                        <select id="voucherStatus">
                            <option value="1">Ho·∫°t ƒë·ªông</option>
                            <option value="0">D·ª´ng ho·∫°t ƒë·ªông</option>
                        </select>
                        <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">
                            üí° Ch·ªçn "Ho·∫°t ƒë·ªông" ƒë·ªÉ voucher c√≥ th·ªÉ s·ª≠ d·ª•ng. Ch·ªçn "D·ª´ng ho·∫°t ƒë·ªông" ƒë·ªÉ t·∫°m th·ªùi v√¥ hi·ªáu h√≥a voucher.
                        </small>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Ng√†y b·∫Øt ƒë·∫ßu *</label>
                        <input type="datetime-local" id="voucherStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Ng√†y k·∫øt th√∫c *</label>
                        <input type="datetime-local" id="voucherEndDate" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>S·∫£n ph·∫©m √°p d·ª•ng (ƒë·ªÉ tr·ªëng = t·∫•t c·∫£)</label>
                    <input type="text" id="voucherProducts" placeholder="Nh·∫≠p ID s·∫£n ph·∫©m, c√°ch nhau b·ªüi d·∫•u ph·∫©y">
                </div>
                <div class="form-group">
                    <label>Danh m·ª•c √°p d·ª•ng (ƒë·ªÉ tr·ªëng = t·∫•t c·∫£)</label>
                    <input type="text" id="voucherCategories" placeholder="Nh·∫≠p ID danh m·ª•c, c√°ch nhau b·ªüi d·∫•u ph·∫©y">
                </div>
                <div class="form-group">
                    <label>Ng∆∞·ªùi d√πng √°p d·ª•ng (ƒë·ªÉ tr·ªëng = t·∫•t c·∫£ user ƒë·ªÅu d√πng ƒë∆∞·ª£c)</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="text" id="voucherUsers" placeholder="Nh·∫≠p ID ng∆∞·ªùi d√πng, c√°ch nhau b·ªüi d·∫•u ph·∫©y" style="flex: 1;">
                        <button type="button" class="btn btn-success" onclick="showCustomerSelector()" style="white-space: nowrap;">
                            üìã Ch·ªçn t·ª´ danh s√°ch
                        </button>
                    </div>
                    <small style="color: #64748b; font-size: 12px; display: block; margin-top: 5px;">
                        üí° ƒê·ªÉ tr·ªëng = t·∫•t c·∫£ kh√°ch h√†ng ƒë·ªÅu d√πng ƒë∆∞·ª£c.<br>
                        üí° Click "üìã Ch·ªçn t·ª´ danh s√°ch" ƒë·ªÉ m·ªü modal ch·ªçn kh√°ch h√†ng b·∫±ng checkbox (d·ªÖ d√†ng h∆°n).
                    </small>
                </div>
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <div id="voucherError" class="error-message"></div>
            </form>
        </div>
    </div>

    <!-- Customer Selector Modal for Voucher -->
    <div id="customerSelectorModal" class="modal">
        <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>Ch·ªçn kh√°ch h√†ng √°p d·ª•ng voucher</h2>
                <button class="close-btn" onclick="closeCustomerSelector()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="customerSelectorSearch" placeholder="üîç T√¨m ki·∫øm kh√°ch h√†ng..." 
                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;"
                           onkeyup="filterCustomerSelector()">
                </div>
                <div style="margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <label style="cursor: pointer;">
                            <input type="checkbox" id="selectAllCustomers" onchange="toggleSelectAllCustomers()" style="margin-right: 8px;">
                            <strong>Ch·ªçn t·∫•t c·∫£</strong>
                        </label>
                    </div>
                    <div>
                        <span id="selectedCustomersCount" style="color: #667eea; font-weight: 600;">ƒê√£ ch·ªçn: 0</span>
                    </div>
                </div>
                <div id="customerSelectorList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 5px; padding: 10px;">
                    <div style="text-align: center; padding: 40px; color: #64748b;">
                        ƒêang t·∫£i danh s√°ch kh√°ch h√†ng...
                    </div>
                </div>
                <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn btn-danger" onclick="closeCustomerSelector()">H·ªßy</button>
                    <button class="btn btn-primary" onclick="applySelectedCustomers()">√Åp d·ª•ng</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentToken = localStorage.getItem('adminToken');
        let currentPage = {
            orders: 1,
            products: 1,
            categories: 1,
            customers: 1,
            vouchers: 1
        };

        // Check if already logged in
        if (currentToken) {
            checkAuth();
        }

        // Verify token and role when page loads
        async function checkAuth() {
            if (!currentToken) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${currentToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    // Ki·ªÉm tra role ph·∫£i l√† admin
                    if (data.role === 'admin') {
                        showAdminScreen();
                    } else {
                        // N·∫øu kh√¥ng ph·∫£i admin, x√≥a token v√† y√™u c·∫ßu ƒëƒÉng nh·∫≠p l·∫°i
                        console.error('User is not admin!');
                        localStorage.removeItem('adminToken');
                        currentToken = null;
                        document.getElementById('loginError').textContent = 'B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang admin!';
                    }
                } else {
                    // Token kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n
                    if (response.status === 401 || response.status === 403) {
                        localStorage.removeItem('adminToken');
                        currentToken = null;
                        document.getElementById('loginError').textContent = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                    }
                }
            } catch (error) {
                console.error('Auth check error:', error);
                // N·∫øu l·ªói k·∫øt n·ªëi, v·∫´n cho ph√©p th·ª≠ ƒëƒÉng nh·∫≠p l·∫°i
                localStorage.removeItem('adminToken');
                currentToken = null;
            }
        }

        // Login
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            errorDiv.textContent = ''; // Clear previous errors

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: email, password })
                });

                const data = await response.json();

                if (response.ok && data.user && data.user.role === 'admin') {
                    localStorage.setItem('adminToken', data.token);
                    currentToken = data.token;
                    showAdminScreen();
                } else {
                    errorDiv.textContent = data.message || 'Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
                }
            } catch (error) {
                console.error('Login error:', error);
                errorDiv.textContent = 'L·ªói k·∫øt n·ªëi server!';
            }
        });

        function showAdminScreen() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('adminScreen').classList.add('active');
            document.getElementById('loginError').textContent = ''; // Clear any errors
            loadDashboard();
        }

        function logout() {
            localStorage.removeItem('adminToken');
            currentToken = null;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminScreen').classList.remove('active');
            document.getElementById('loginError').textContent = '';
        }

        function getAuthHeaders() {
            if (!currentToken) {
                // N·∫øu kh√¥ng c√≥ token, y√™u c·∫ßu ƒëƒÉng nh·∫≠p l·∫°i
                alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                logout();
                throw new Error('No token available');
            }
            return {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${currentToken}`
            };
        }

        // Helper function to handle API errors (401/403)
        function handleApiError(response) {
            if (response.status === 401 || response.status === 403) {
                // Token kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng c√≥ quy·ªÅn
                localStorage.removeItem('adminToken');
                currentToken = null;
                alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n ho·∫∑c b·∫°n kh√¥ng c√≥ quy·ªÅn! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                logout();
                return true; // Indicates error was handled
            }
            return false; // Error not handled
        }

        // Copy text to clipboard
        function copyToClipboard(text, message = 'ƒê√£ copy!') {
            navigator.clipboard.writeText(text).then(() => {
                alert(message);
            }).catch(err => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert(message);
                } catch (err) {
                    alert('Kh√¥ng th·ªÉ copy! Vui l√≤ng copy th·ªß c√¥ng: ' + text);
                }
                document.body.removeChild(textArea);
            });
        }

        // Customer selector for voucher
        let allCustomersList = [];
        let selectedCustomerIds = new Set();

        async function showCustomerSelector() {
            document.getElementById('customerSelectorModal').classList.add('active');
            document.getElementById('customerSelectorSearch').value = '';
            
            // Load selected IDs from input field if any
            const currentIds = document.getElementById('voucherUsers').value;
            selectedCustomerIds.clear();
            if (currentIds && currentIds.trim()) {
                currentIds.split(',').forEach(id => {
                    const trimmedId = id.trim();
                    if (trimmedId) {
                        selectedCustomerIds.add(trimmedId);
                    }
                });
            }
            
            document.getElementById('selectAllCustomers').checked = false;
            
            // Load customers
            try {
                const response = await fetch(`${API_BASE}/users?role=customer&limit=1000`, {
                    headers: getAuthHeaders()
                });
                
                // Handle authentication errors
                if (handleApiError(response)) {
                    return;
                }
                
                const data = await response.json();
                
                if (response.ok && data.users) {
                    allCustomersList = data.users;
                    renderCustomerSelectorList(allCustomersList);
                } else {
                    document.getElementById('customerSelectorList').innerHTML = 
                        '<div style="text-align: center; padding: 40px; color: #e74c3c;">L·ªói t·∫£i danh s√°ch kh√°ch h√†ng!</div>';
                }
            } catch (error) {
                console.error('Error loading customers:', error);
                // Don't show error if it's a logout (from handleApiError)
                if (currentToken) {
                    document.getElementById('customerSelectorList').innerHTML = 
                        '<div style="text-align: center; padding: 40px; color: #e74c3c;">L·ªói k·∫øt n·ªëi server!</div>';
                }
            }
        }

        function renderCustomerSelectorList(customers) {
            const listDiv = document.getElementById('customerSelectorList');
            
            if (customers.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #64748b;">Kh√¥ng c√≥ kh√°ch h√†ng n√†o!</div>';
                updateSelectedCount();
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 8px;">';
            customers.forEach(customer => {
                const customerId = customer._id || customer.id || '';
                const isSelected = selectedCustomerIds.has(customerId);
                
                html += `
                    <label style="display: flex; align-items: center; padding: 12px; border: 1px solid #e2e8f0; border-radius: 5px; cursor: pointer; transition: background 0.2s; ${isSelected ? 'background: #f0f9ff; border-color: #667eea;' : ''}" 
                           onmouseover="this.style.background='#f8f9fa'" 
                           onmouseout="this.style.background='${isSelected ? '#f0f9ff' : 'white'}'">
                        <input type="checkbox" 
                               value="${customerId}" 
                               ${isSelected ? 'checked' : ''}
                               onchange="toggleCustomerSelection('${customerId}')"
                               style="margin-right: 12px; width: 18px; height: 18px; cursor: pointer;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: #1e293b; margin-bottom: 4px;">${customer.fullName || 'N/A'}</div>
                            <div style="font-size: 12px; color: #64748b;">
                                ${customer.email || 'N/A'} | ${customer.phone || 'N/A'}
                            </div>
                            <div style="font-size: 11px; color: #94a3b8; margin-top: 4px;">
                                ID: <code style="background: #f1f3f5; padding: 2px 6px; border-radius: 3px;">${customerId}</code>
                            </div>
                        </div>
                    </label>
                `;
            });
            html += '</div>';
            
            listDiv.innerHTML = html;
            updateSelectedCount();
        }

        function toggleCustomerSelection(customerId) {
            if (selectedCustomerIds.has(customerId)) {
                selectedCustomerIds.delete(customerId);
            } else {
                selectedCustomerIds.add(customerId);
            }
            updateSelectedCount();
        }

        function toggleSelectAllCustomers() {
            const selectAll = document.getElementById('selectAllCustomers').checked;
            const checkboxes = document.querySelectorAll('#customerSelectorList input[type="checkbox"]');
            
            checkboxes.forEach(checkbox => {
                const customerId = checkbox.value;
                checkbox.checked = selectAll;
                if (selectAll) {
                    selectedCustomerIds.add(customerId);
                } else {
                    selectedCustomerIds.delete(customerId);
                }
            });
            
            updateSelectedCount();
        }

        function filterCustomerSelector() {
            const search = document.getElementById('customerSelectorSearch').value.toLowerCase();
            const filtered = allCustomersList.filter(customer => {
                const name = (customer.fullName || '').toLowerCase();
                const email = (customer.email || '').toLowerCase();
                const phone = (customer.phone || '').toLowerCase();
                const id = (customer._id || customer.id || '').toLowerCase();
                return name.includes(search) || email.includes(search) || phone.includes(search) || id.includes(search);
            });
            renderCustomerSelectorList(filtered);
        }

        function updateSelectedCount() {
            const count = selectedCustomerIds.size;
            document.getElementById('selectedCustomersCount').textContent = `ƒê√£ ch·ªçn: ${count}`;
        }

        function applySelectedCustomers() {
            if (selectedCustomerIds.size === 0) {
                if (confirm('B·∫°n ch∆∞a ch·ªçn kh√°ch h√†ng n√†o. B·∫°n c√≥ mu·ªën ƒë·ªÉ tr·ªëng (√°p d·ª•ng cho t·∫•t c·∫£) kh√¥ng?')) {
                    document.getElementById('voucherUsers').value = '';
                    closeCustomerSelector();
                }
                return;
            }
            
            const idsArray = Array.from(selectedCustomerIds);
            const idsString = idsArray.join(', ');
            document.getElementById('voucherUsers').value = idsString;
            console.log('‚úÖ Applied selected customers:', idsArray);
            console.log('‚úÖ Input value set to:', idsString);
            closeCustomerSelector();
        }

        function closeCustomerSelector() {
            document.getElementById('customerSelectorModal').classList.remove('active');
        }

        // Navigation
        function updateActiveMenu(activeItem) {
            document.querySelectorAll('.menu-item').forEach(item => item.classList.remove('active'));
            if (activeItem) {
                activeItem.classList.add('active');
            }
        }

        function updatePageTitle(title) {
            document.getElementById('pageTitle').textContent = title;
        }

        function showSection(sectionId) {
            document.querySelectorAll('[id$="Section"]').forEach(el => el.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            document.getElementById('dashboardMenu').classList.add('hidden');
        }

        function showDashboard() {
            document.querySelectorAll('[id$="Section"]').forEach(el => el.classList.add('hidden'));
            document.getElementById('dashboardMenu').classList.remove('hidden');
            updatePageTitle('T·ªïng quan');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelector('.menu-item'));
        }

        function showOrders() {
            showSection('ordersSection');
            updatePageTitle('Qu·∫£n l√Ω ƒë∆°n h√†ng');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[1]);
            loadOrders();
        }

        function showProducts() {
            showSection('productsSection');
            updatePageTitle('Qu·∫£n l√Ω s·∫£n ph·∫©m');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[2]);
            loadProducts();
            loadCategoriesForSelect();
        }

        function showCategories() {
            showSection('categoriesSection');
            updatePageTitle('Qu·∫£n l√Ω danh m·ª•c');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[3]);
            loadCategories();
        }

        function showCustomers() {
            showSection('customersSection');
            updatePageTitle('Qu·∫£n l√Ω kh√°ch h√†ng');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[4]);
            loadCustomers();
        }

        function showStatistics() {
            showSection('statisticsSection');
            updatePageTitle('Th·ªëng k√™');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[5]);
            loadStatistics();
        }

        function showVouchers() {
            showSection('vouchersSection');
            updatePageTitle('Qu·∫£n l√Ω Voucher');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[6]);
            loadVouchers();
        }

        function showChatSupport() {
            showSection('chatSupportSection');
            updatePageTitle('H·ªó tr·ª£ kh√°ch h√†ng');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[7]);
            loadChatCustomers();
            startChatAutoRefresh();
        }
        
        function showReviews() {
            showSection('reviewsSection');
            updatePageTitle('Qu·∫£n l√Ω ƒê√°nh gi√°');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[8]);
            loadReviews();
        }

        function showAPIManagement() {
            showSection('apiManagementSection');
            updatePageTitle('Qu·∫£n l√Ω API');
            updateActiveMenu(event?.target?.closest('.menu-item') || document.querySelectorAll('.menu-item')[9]);
            loadAPIs();
        }
        
        // Chat Support Functions
        let currentChatCustomerId = null;
        let chatAutoRefreshInterval = null;
        let chatMessagesAutoRefreshInterval = null;
        
        async function loadChatCustomers() {
            try {
                const response = await fetch(`${API_BASE}/chat/messages`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const chats = data.chats || [];
                    
                    if (chats.length === 0) {
                        document.getElementById('chatCustomersList').innerHTML = `
                            <div style="text-align: center; padding: 40px; color: #999;">
                                <p>Ch∆∞a c√≥ kh√°ch h√†ng n√†o li√™n h·ªá</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    chats.forEach(chat => {
                        const customer = chat.customer;
                        const unreadCount = chat.adminUnreadCount || 0;
                        const lastMessageTime = chat.lastMessageAt ? new Date(chat.lastMessageAt).toLocaleString('vi-VN') : '';
                        
                        const customerNameEscaped = (customer.fullName || customer.email || '').replace(/'/g, "\\'");
                        const customerEmailEscaped = (customer.email || '').replace(/'/g, "\\'");
                        const customerPhoneEscaped = (customer.phone || '').replace(/'/g, "\\'");
                        
                        html += `
                            <div class="chat-customer-item" onclick="openChat('${customer._id}', '${customerNameEscaped}', '${customerEmailEscaped}', '${customerPhoneEscaped}')" data-customer-id="${customer._id}">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #333; margin-bottom: 5px;">
                                            ${customer.fullName || customer.email}
                                            ${unreadCount > 0 ? `<span class="unread-badge" style="margin-left: 8px;">${unreadCount}</span>` : ''}
                                        </div>
                                        <div style="font-size: 12px; color: #666; margin-bottom: 3px;">
                                            ${chat.lastMessage ? chat.lastMessage.substring(0, 50) + (chat.lastMessage.length > 50 ? '...' : '') : 'Ch∆∞a c√≥ tin nh·∫Øn'}
                                        </div>
                                        <div style="font-size: 11px; color: #999;">
                                            ${lastMessageTime}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('chatCustomersList').innerHTML = html;
                } else {
                    document.getElementById('chatCustomersList').innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #dc3545;">
                            <p>L·ªói t·∫£i danh s√°ch chat: ${data.message || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat customers:', error);
                document.getElementById('chatCustomersList').innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #dc3545;">
                        <p>L·ªói k·∫øt n·ªëi server!</p>
                    </div>
                `;
            }
        }
        
        async function openChat(customerId, customerName, customerEmail, customerPhone) {
            currentChatCustomerId = customerId;
            
            // Highlight selected customer
            document.querySelectorAll('.chat-customer-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('onclick')?.includes(customerId)) {
                    item.classList.add('active');
                }
            });
            
            // Show chat window
            document.getElementById('chatWindowHeader').style.display = 'block';
            document.getElementById('chatInputContainer').style.display = 'block';
            document.getElementById('chatCustomerName').textContent = customerName;
            document.getElementById('chatCustomerInfo').textContent = `${customerEmail}${customerPhone ? ' | ' + customerPhone : ''}`;
            
            // Load messages
            await loadChatMessages(customerId);
            
            // Start auto-refresh messages
            startChatMessagesAutoRefresh();
        }
        
        async function loadChatMessages(customerId) {
            if (!customerId) return;
            
            try {
                const response = await fetch(`${API_BASE}/chat/messages?customerId=${customerId}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const messages = data.messages || [];
                    
                    if (messages.length === 0) {
                        document.getElementById('chatMessagesContainer').innerHTML = `
                            <div style="text-align: center; color: #999; padding: 40px;">
                                <p>Ch∆∞a c√≥ tin nh·∫Øn n√†o. B·∫Øt ƒë·∫ßu cu·ªôc tr√≤ chuy·ªán!</p>
                            </div>
                        `;
                        return;
                    }
                    
                    let html = '';
                    messages.forEach(msg => {
                        const isAdmin = msg.senderRole === 'admin';
                        const senderName = msg.senderId?.fullName || (isAdmin ? 'Admin' : 'Kh√°ch h√†ng');
                        const time = new Date(msg.createdAt).toLocaleString('vi-VN');
                        
                        html += `
                            <div class="chat-message ${isAdmin ? 'admin' : 'customer'}">
                                <div class="chat-message-bubble">
                                    ${msg.message}
                                </div>
                                <div class="chat-message-time">${senderName} - ${time}</div>
                            </div>
                        `;
                    });
                    
                    document.getElementById('chatMessagesContainer').innerHTML = html;
                    
                    // Scroll to bottom
                    const container = document.getElementById('chatMessagesContainer');
                    container.scrollTop = container.scrollHeight;
                } else {
                    document.getElementById('chatMessagesContainer').innerHTML = `
                        <div style="text-align: center; color: #dc3545; padding: 40px;">
                            <p>L·ªói t·∫£i tin nh·∫Øn: ${data.message || 'Kh√¥ng x√°c ƒë·ªãnh'}</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading chat messages:', error);
                document.getElementById('chatMessagesContainer').innerHTML = `
                    <div style="text-align: center; color: #dc3545; padding: 40px;">
                        <p>L·ªói k·∫øt n·ªëi server!</p>
                    </div>
                `;
            }
        }
        
        async function sendChatMessage(event) {
            event.preventDefault();
            
            if (!currentChatCustomerId) {
                alert('Vui l√≤ng ch·ªçn kh√°ch h√†ng!');
                return;
            }
            
            const messageInput = document.getElementById('chatMessageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                return;
            }
            
            // Disable input v√† button
            messageInput.disabled = true;
            document.getElementById('chatSendBtn').disabled = true;
            document.getElementById('chatSendBtn').textContent = 'ƒêang g·ª≠i...';
            
            // Optimistic update: hi·ªÉn th·ªã tin nh·∫Øn ngay
            const messagesContainer = document.getElementById('chatMessagesContainer');
            const tempMessageId = 'temp_' + Date.now();
            const time = new Date().toLocaleString('vi-VN');
            messagesContainer.innerHTML += `
                <div id="${tempMessageId}" class="chat-message admin">
                    <div class="chat-message-bubble">
                        ${message}
                    </div>
                    <div class="chat-message-time">B·∫°n - ${time}</div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Clear input
            messageInput.value = '';
            
            try {
                const response = await fetch(`${API_BASE}/chat/messages`, {
                    method: 'POST',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({
                        message: message,
                        customerId: currentChatCustomerId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.success) {
                    // Remove temp message v√† load l·∫°i t·ª´ server
                    const tempMsg = document.getElementById(tempMessageId);
                    if (tempMsg) tempMsg.remove();
                    
                    // Reload messages
                    await loadChatMessages(currentChatCustomerId);
                    
                    // Reload customers list ƒë·ªÉ c·∫≠p nh·∫≠t unread count
                    await loadChatCustomers();
                    
                    // Th√¥ng b√°o th√†nh c√¥ng (optional)
                    console.log('‚úÖ Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!');
                } else {
                    // X√≥a tin nh·∫Øn kh·ªèi UI n·∫øu g·ª≠i th·∫•t b·∫°i
                    const tempMsg = document.getElementById(tempMessageId);
                    if (tempMsg) tempMsg.remove();
                    
                    alert(data.message || 'G·ª≠i tin nh·∫Øn th·∫•t b·∫°i!');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                
                // X√≥a tin nh·∫Øn kh·ªèi UI n·∫øu g·ª≠i th·∫•t b·∫°i
                const tempMsg = document.getElementById(tempMessageId);
                if (tempMsg) tempMsg.remove();
                
                alert('L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.');
            } finally {
                // Enable l·∫°i input v√† button
                messageInput.disabled = false;
                document.getElementById('chatSendBtn').disabled = false;
                document.getElementById('chatSendBtn').textContent = 'G·ª≠i';
                messageInput.focus();
            }
        }
        
        function closeChatWindow() {
            currentChatCustomerId = null;
            document.getElementById('chatWindowHeader').style.display = 'none';
            document.getElementById('chatInputContainer').style.display = 'none';
            document.getElementById('chatMessagesContainer').innerHTML = `
                <div style="text-align: center; color: #999; padding: 40px;">
                    <p>Ch·ªçn m·ªôt kh√°ch h√†ng ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p>
                </div>
            `;
            stopChatMessagesAutoRefresh();
            
            // Remove active class
            document.querySelectorAll('.chat-customer-item').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        function startChatAutoRefresh() {
            // Refresh customers list m·ªói 5 gi√¢y
            if (chatAutoRefreshInterval) {
                clearInterval(chatAutoRefreshInterval);
            }
            chatAutoRefreshInterval = setInterval(() => {
                loadChatCustomers();
                loadChatUnreadCount();
            }, 5000);
        }
        
        function startChatMessagesAutoRefresh() {
            // Refresh messages m·ªói 3 gi√¢y khi ƒëang chat
            if (chatMessagesAutoRefreshInterval) {
                clearInterval(chatMessagesAutoRefreshInterval);
            }
            chatMessagesAutoRefreshInterval = setInterval(() => {
                if (currentChatCustomerId) {
                    loadChatMessages(currentChatCustomerId);
                }
            }, 3000);
        }
        
        function stopChatMessagesAutoRefresh() {
            if (chatMessagesAutoRefreshInterval) {
                clearInterval(chatMessagesAutoRefreshInterval);
                chatMessagesAutoRefreshInterval = null;
            }
        }
        
        async function loadChatUnreadCount() {
            try {
                const response = await fetch(`${API_BASE}/chat/unread-count`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();
                
                if (response.ok && data.success) {
                    const unreadCount = data.unreadCount || 0;
                    const badge = document.getElementById('chatUnreadBadge');
                    if (unreadCount > 0) {
                        badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badge.style.display = 'inline-block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Error loading unread count:', error);
            }
        }
        
        function filterChatCustomers() {
            const search = document.getElementById('chatSearchCustomer')?.value.toLowerCase() || '';
            const items = document.querySelectorAll('.chat-customer-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'block' : 'none';
            });
        }
        
        // Load unread count on page load
        if (currentToken) {
            loadChatUnreadCount();
            setInterval(loadChatUnreadCount, 10000); // Refresh every 10 seconds
        }

        // Load Orders
        async function loadOrders(page = 1) {
            const search = document.getElementById('orderSearch')?.value || '';
            const status = document.getElementById('orderStatusFilter')?.value || '';
            const params = new URLSearchParams({ page, limit: 10 });
            if (status) params.append('status', status);

            try {
                const response = await fetch(`${API_BASE}/orders?${params}`, {
                    headers: getAuthHeaders()
                });
                
                // Handle authentication errors
                if (handleApiError(response)) {
                    return;
                }
                
                const data = await response.json();

                if (response.ok) {
                    renderOrdersTable(data.orders);
                    renderPagination('ordersPagination', data.page, data.totalPages, (p) => {
                        currentPage.orders = p;
                        loadOrders(p);
                    });
                }
            } catch (error) {
                console.error('Error loading orders:', error);
                // Don't show error if it's a logout (from handleApiError)
                if (currentToken && error.message !== 'No token available') {
                    alert('L·ªói t·∫£i danh s√°ch ƒë∆°n h√†ng!');
                }
            }
        }

        function renderOrdersTable(orders) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>M√£ ƒë∆°n</th>
                            <th>Kh√°ch h√†ng</th>
                            <th>T·ªïng ti·ªÅn</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(order => `
                            <tr>
                                <td>${order.orderNumber || order._id.slice(-8)}</td>
                                <td>${order.customer?.fullName || 'N/A'}</td>
                                <td>${order.total?.toLocaleString('vi-VN')} VNƒê</td>
                                <td><span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></td>
                                <td>${new Date(order.createdAt).toLocaleDateString('vi-VN')}</td>
                                <td>
                                    <button class="btn-sm btn-view" onclick="viewOrder('${order._id}')">Xem</button>
                                    ${order.status !== 'completed' && order.status !== 'cancelled' ? 
                                        `<button class="btn-sm btn-edit" onclick="updateOrderStatus('${order._id}')">C·∫≠p nh·∫≠t</button>` : ''}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('ordersTable').innerHTML = table;
        }

        function getStatusText(status) {
            const statusMap = {
                'new': 'M·ªõi',
                'processing': 'ƒêang x·ª≠ l√Ω',
                'shipping': 'ƒêang giao',
                'completed': 'Ho√†n th√†nh',
                'cancelled': 'ƒê√£ h·ªßy',
                'returning': 'ƒêang ho√†n h√†ng',
                'exchanging': 'ƒêang ƒë·ªïi h√†ng'
            };
            return statusMap[status] || status;
        }

        function getPaymentStatusText(paymentStatus) {
            const paymentStatusMap = {
                'pending': 'Ch·ªù thanh to√°n',
                'processing': 'ƒêang x·ª≠ l√Ω thanh to√°n',
                'success': 'Thanh to√°n th√†nh c√¥ng',
                'failed': 'Thanh to√°n th·∫•t b·∫°i',
                'cancelled': 'ƒê√£ h·ªßy thanh to√°n'
            };
            return paymentStatusMap[paymentStatus] || paymentStatus;
        }

        function getPaymentStatusColor(paymentStatus) {
            const colorMap = {
                'pending': 'warning',
                'processing': 'info',
                'success': 'success',
                'failed': 'danger',
                'cancelled': 'secondary'
            };
            return colorMap[paymentStatus] || 'secondary';
        }

        async function updateOrderStatus(orderId) {
            // L·∫•y th√¥ng tin ƒë∆°n h√†ng hi·ªán t·∫°i ƒë·ªÉ bi·∫øt tr·∫°ng th√°i hi·ªán t·∫°i
            let currentStatus = 'new';
            try {
                const orderResponse = await fetch(`${API_BASE}/orders/${orderId}`, {
                    headers: getAuthHeaders()
                });
                if (orderResponse.ok) {
                    const order = await orderResponse.json();
                    currentStatus = order.status || 'new';
                }
            } catch (e) {
                console.error('Error loading order:', e);
            }

            // T·∫°o modal v·ªõi dropdown
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.id = 'updateStatusModal';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng</h2>
                        <button class="close-btn" onclick="closeUpdateStatusModal()">&times;</button>
                    </div>
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #333;">
                            Ch·ªçn tr·∫°ng th√°i m·ªõi:
                        </label>
                        <select id="newOrderStatus" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                            <option value="new" ${currentStatus === 'new' ? 'selected' : ''}>M·ªõi</option>
                            <option value="processing" ${currentStatus === 'processing' ? 'selected' : ''}>ƒêang x·ª≠ l√Ω</option>
                            <option value="shipping" ${currentStatus === 'shipping' ? 'selected' : ''}>ƒêang giao</option>
                            <option value="completed" ${currentStatus === 'completed' ? 'selected' : ''}>Ho√†n th√†nh</option>
                            <option value="cancelled" ${currentStatus === 'cancelled' ? 'selected' : ''}>ƒê√£ h·ªßy</option>
                            <option value="returning" ${currentStatus === 'returning' ? 'selected' : ''}>ƒêang ho√†n h√†ng</option>
                            <option value="exchanging" ${currentStatus === 'exchanging' ? 'selected' : ''}>ƒêang ƒë·ªïi h√†ng</option>
                        </select>
                    </div>
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button class="btn btn-secondary" onclick="closeUpdateStatusModal()">H·ªßy</button>
                        <button class="btn btn-primary" onclick="confirmUpdateOrderStatus('${orderId}')">C·∫≠p nh·∫≠t</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // ƒê√≥ng modal khi click b√™n ngo√†i
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeUpdateStatusModal();
                }
            });
        }

        function closeUpdateStatusModal() {
            const modal = document.getElementById('updateStatusModal');
            if (modal) {
                modal.remove();
            }
        }

        async function confirmUpdateOrderStatus(orderId) {
            const statusSelect = document.getElementById('newOrderStatus');
            if (!statusSelect) {
                alert('L·ªói: Kh√¥ng t√¨m th·∫•y dropdown tr·∫°ng th√°i!');
                return;
            }

            const status = statusSelect.value;
            if (!status) {
                alert('Vui l√≤ng ch·ªçn tr·∫°ng th√°i!');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ status })
                });

                if (response.ok) {
                    alert('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                    closeUpdateStatusModal();
                    loadOrders(currentPage.orders);
                } else {
                    const data = await response.json();
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        // Load Products
        async function loadProducts(page = 1) {
            const search = document.getElementById('productSearch')?.value || '';
            const params = new URLSearchParams({ page, limit: 10 });
            if (search) params.append('search', search);

            try {
                const response = await fetch(`${API_BASE}/products?${params}`, {
                    headers: getAuthHeaders()
                });
                
                // Handle authentication errors
                if (handleApiError(response)) {
                    return;
                }
                
                const data = await response.json();

                if (response.ok) {
                    renderProductsTable(data.products);
                    renderPagination('productsPagination', data.page, data.totalPages, (p) => {
                        currentPage.products = p;
                        loadProducts(p);
                    });
                }
            } catch (error) {
                console.error('Error loading products:', error);
                // Don't show error if it's a logout (from handleApiError)
                if (currentToken && error.message !== 'No token available') {
                    alert('L·ªói t·∫£i danh s√°ch s·∫£n ph·∫©m!');
                }
            }
        }

        function renderProductsTable(products) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>·∫¢nh</th>
                            <th>T√™n s·∫£n ph·∫©m</th>
                            <th>Danh m·ª•c</th>
                            <th>Gi√° b√°n</th>
                            <th>T·ªìn kho</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${products.map(product => `
                            <tr>
                                <td><img src="${product.image || product.images?.[0] || 'https://via.placeholder.com/50'}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;"></td>
                                <td>${product.name}</td>
                                <td>${product.category?.name || 'N/A'}</td>
                                <td>${product.price?.toLocaleString('vi-VN')} VNƒê</td>
                                <td>${product.stock || 0}</td>
                                <td>
                                    <button class="btn-sm btn-view" onclick="viewProduct('${product._id}')">Xem</button>
                                    <button class="btn-sm btn-edit" onclick="editProduct('${product._id}')">S·ª≠a</button>
                                    <button class="btn-sm btn-delete" onclick="deleteProduct('${product._id}')">X√≥a</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('productsTable').innerHTML = table;
        }

        async function loadCategoriesForSelect() {
            try {
                const response = await fetch(`${API_BASE}/categories/all`);
                const data = await response.json();
                const select = document.getElementById('productCategory');
                select.innerHTML = '<option value="">Ch·ªçn danh m·ª•c</option>' + 
                    data.map(cat => `<option value="${cat._id}">${cat.name}</option>`).join('');
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function showAddProduct() {
            document.getElementById('productId').value = '';
            document.getElementById('productForm').reset();
            document.getElementById('productModalTitle').textContent = 'Th√™m s·∫£n ph·∫©m';
            document.getElementById('productModal').classList.add('active');
        }

        async function editProduct(id) {
            try {
                const response = await fetch(`${API_BASE}/products/${id}`, {
                    headers: getAuthHeaders()
                });
                const product = await response.json();

                document.getElementById('productId').value = product._id;
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productCategory').value = product.category?._id || product.category || '';
                document.getElementById('productImportPrice').value = product.importPrice || '';
                document.getElementById('productPrice').value = product.price || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productMinStock').value = product.minStock || '';
                document.getElementById('productImage').value = product.image || product.images?.[0] || '';
                document.getElementById('productDescription').value = product.description || '';

                document.getElementById('productModalTitle').textContent = 'S·ª≠a s·∫£n ph·∫©m';
                document.getElementById('productModal').classList.add('active');
            } catch (error) {
                alert('L·ªói t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m!');
            }
        }

        document.getElementById('productForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('productId').value;
            const data = {
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                importPrice: parseFloat(document.getElementById('productImportPrice').value),
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                minStock: parseInt(document.getElementById('productMinStock').value),
                image: document.getElementById('productImage').value,
                description: document.getElementById('productDescription').value
            };

            try {
                const url = id ? `${API_BASE}/products/${id}` : `${API_BASE}/products`;
                const method = id ? 'PUT' : 'POST';
                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('L∆∞u th√†nh c√¥ng!');
                    closeModal('productModal');
                    loadProducts(currentPage.products);
                } else {
                    document.getElementById('productError').textContent = result.message || 'C√≥ l·ªói x·∫£y ra!';
                }
            } catch (error) {
                document.getElementById('productError').textContent = 'L·ªói k·∫øt n·ªëi server!';
            }
        });

        async function deleteProduct(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y?')) return;

            try {
                const response = await fetch(`${API_BASE}/products/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    alert('X√≥a th√†nh c√¥ng!');
                    loadProducts(currentPage.products);
                } else {
                    const data = await response.json();
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        // Load Categories
        async function loadCategories(page = 1) {
            const search = document.getElementById('categorySearch')?.value || '';
            const params = new URLSearchParams({ page, limit: 10 });
            if (search) params.append('search', search);

            try {
                const response = await fetch(`${API_BASE}/categories?${params}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    renderCategoriesTable(data.categories);
                    renderPagination('categoriesPagination', data.page, data.totalPages, (p) => {
                        currentPage.categories = p;
                        loadCategories(p);
                    });
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        function renderCategoriesTable(categories) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>T√™n danh m·ª•c</th>
                            <th>M√¥ t·∫£</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${categories.map(cat => `
                            <tr>
                                <td>${cat.name}</td>
                                <td>${cat.description || 'N/A'}</td>
                                <td><span class="status-badge ${cat.status === 1 ? 'status-completed' : 'status-cancelled'}">${cat.status === 1 ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span></td>
                                <td>
                                    <button class="btn-sm btn-edit" onclick="editCategory('${cat._id}')">S·ª≠a</button>
                                    <button class="btn-sm btn-delete" onclick="deleteCategory('${cat._id}')">X√≥a</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('categoriesTable').innerHTML = table;
        }

        function showAddCategory() {
            document.getElementById('categoryId').value = '';
            document.getElementById('categoryForm').reset();
            document.getElementById('categoryModalTitle').textContent = 'Th√™m danh m·ª•c';
            document.getElementById('categoryModal').classList.add('active');
        }

        async function editCategory(id) {
            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    headers: getAuthHeaders()
                });
                const category = await response.json();

                document.getElementById('categoryId').value = category._id;
                document.getElementById('categoryName').value = category.name || '';
                document.getElementById('categoryDescription').value = category.description || '';

                document.getElementById('categoryModalTitle').textContent = 'S·ª≠a danh m·ª•c';
                document.getElementById('categoryModal').classList.add('active');
            } catch (error) {
                alert('L·ªói t·∫£i d·ªØ li·ªáu danh m·ª•c!');
            }
        }

        document.getElementById('categoryForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('categoryId').value;
            const data = {
                name: document.getElementById('categoryName').value,
                description: document.getElementById('categoryDescription').value
            };

            try {
                const url = id ? `${API_BASE}/categories/${id}` : `${API_BASE}/categories`;
                const method = id ? 'PUT' : 'POST';
                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (response.ok) {
                    alert('L∆∞u th√†nh c√¥ng!');
                    closeModal('categoryModal');
                    loadCategories(currentPage.categories);
                } else {
                    document.getElementById('categoryError').textContent = result.message || 'C√≥ l·ªói x·∫£y ra!';
                }
            } catch (error) {
                document.getElementById('categoryError').textContent = 'L·ªói k·∫øt n·ªëi server!';
            }
        });

        async function deleteCategory(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a danh m·ª•c n√†y?')) return;

            try {
                const response = await fetch(`${API_BASE}/categories/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    alert('X√≥a th√†nh c√¥ng!');
                    loadCategories(currentPage.categories);
                } else {
                    const data = await response.json();
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        // Load Customers
        async function loadCustomers(page = 1) {
            const search = document.getElementById('customerSearch')?.value || '';
            const params = new URLSearchParams({ page, limit: 10, role: 'customer' });
            if (search) params.append('search', search);

            try {
                const response = await fetch(`${API_BASE}/users?${params}`, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    renderCustomersTable(data.users);
                    renderPagination('customersPagination', data.page, data.totalPages, (p) => {
                        currentPage.customers = p;
                        loadCustomers(p);
                    });
                }
            } catch (error) {
                console.error('Error loading customers:', error);
            }
        }

        function renderCustomersTable(customers) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>T√™n</th>
                            <th>Email</th>
                            <th>S·ªë ƒëi·ªán tho·∫°i</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Ng√†y t·∫°o</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${customers.map(customer => {
                            const isBanned = customer.isBanned || false;
                            const statusClass = isBanned ? 'status-cancelled' : 'status-completed';
                            const statusText = isBanned ? 'ƒê√£ kh√≥a' : 'Ho·∫°t ƒë·ªông';
                            
                            const customerId = customer._id || customer.id || '';
                            return `
                            <tr>
                                <td>
                                    <code style="background: #f1f3f5; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;" 
                                          onclick="copyToClipboard('${customerId}', 'ID ƒë√£ ƒë∆∞·ª£c copy!')" 
                                          title="Click ƒë·ªÉ copy ID">
                                        ${customerId.substring(0, 12)}...
                                    </code>
                                </td>
                                <td>${customer.fullName || 'N/A'}</td>
                                <td>${customer.email || 'N/A'}</td>
                                <td>${customer.phone || 'N/A'}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>${new Date(customer.createdAt).toLocaleDateString('vi-VN')}</td>
                                <td>
                                    <button class="btn-sm btn-view" onclick="viewCustomer('${customerId}')">Xem</button>
                                    <button class="btn-sm ${isBanned ? 'btn-edit' : 'btn-delete'}" onclick="toggleBanCustomer('${customerId}', ${isBanned})">
                                        ${isBanned ? 'M·ªü kh√≥a' : 'Kh√≥a'}
                                    </button>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('customersTable').innerHTML = table;
        }

        async function toggleBanCustomer(id, isCurrentlyBanned) {
            const action = isCurrentlyBanned ? 'm·ªü kh√≥a' : 'kh√≥a';
            if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ${action} t√†i kho·∫£n kh√°ch h√†ng n√†y?`)) return;

            try {
                const response = await fetch(`${API_BASE}/users/${id}/ban`, {
                    method: 'PATCH',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ isBanned: !isCurrentlyBanned })
                });

                const result = await response.json();
                if (response.ok) {
                    alert(result.message || `${action.charAt(0).toUpperCase() + action.slice(1)} th√†nh c√¥ng!`);
                    loadCustomers(currentPage.customers);
                } else {
                    alert(result.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                console.error('Error toggling ban:', error);
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        // Load Statistics
        async function loadStatistics() {
            try {
                // Clear ph·∫ßn chi ti·∫øt tr∆∞·ªõc khi load l·∫°i
                const detailSection = document.getElementById('statDetailSection');
                if (detailSection) {
                    detailSection.innerHTML = '';
                }
                
                // L·∫•y filter t·ª´ UI - ch·ªâ d√πng date range
                const filterStartDate = document.getElementById('statFilterStartDate')?.value || '';
                const filterEndDate = document.getElementById('statFilterEndDate')?.value || '';
                
                // L∆∞u v√†o localStorage
                if (filterStartDate) localStorage.setItem('statFilterStartDate', filterStartDate);
                if (filterEndDate) localStorage.setItem('statFilterEndDate', filterEndDate);
                
                // X√¢y d·ª±ng query params
                let url = `${API_BASE}/statistics/overview`;
                const params = new URLSearchParams();
                
                if (filterStartDate && filterEndDate) {
                    // Filter theo kho·∫£ng th·ªùi gian (t·ª´ ng√†y ƒë·∫øn ng√†y)
                    params.append('startDate', filterStartDate);
                    params.append('endDate', filterEndDate);
                } else if (filterStartDate) {
                    // Ch·ªâ c√≥ startDate - t·ª´ ng√†y ƒë√≥ ƒë·∫øn h√¥m nay
                    params.append('startDate', filterStartDate);
                    const today = new Date().toISOString().split('T')[0];
                    params.append('endDate', today);
                } else if (filterEndDate) {
                    // Ch·ªâ c√≥ endDate - t·ª´ ƒë·∫ßu ƒë·∫øn ng√†y ƒë√≥
                    params.append('endDate', filterEndDate);
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                const data = await response.json();

                if (response.ok) {
                    // T·∫°o filter UI
                    const currentDate = new Date();
                    const currentYear = currentDate.getFullYear();
                    const years = [];
                    for (let i = currentYear; i >= currentYear - 5; i--) {
                        years.push(i);
                    }
                    
                    const months = [
                        { value: '1', label: 'Th√°ng 1' },
                        { value: '2', label: 'Th√°ng 2' },
                        { value: '3', label: 'Th√°ng 3' },
                        { value: '4', label: 'Th√°ng 4' },
                        { value: '5', label: 'Th√°ng 5' },
                        { value: '6', label: 'Th√°ng 6' },
                        { value: '7', label: 'Th√°ng 7' },
                        { value: '8', label: 'Th√°ng 8' },
                        { value: '9', label: 'Th√°ng 9' },
                        { value: '10', label: 'Th√°ng 10' },
                        { value: '11', label: 'Th√°ng 11' },
                        { value: '12', label: 'Th√°ng 12' }
                    ];
                    
                    // L·∫•y gi√° tr·ªã date t·ª´ localStorage ho·∫∑c ƒë·ªÉ tr·ªëng
                    const savedStartDate = localStorage.getItem('statFilterStartDate') || '';
                    const savedEndDate = localStorage.getItem('statFilterEndDate') || '';
                    
                    let filterHtml = `
                        <div style="background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                            <h3 style="margin-bottom: 15px; color: #333;">üîç L·ªçc th·ªëng k√™</h3>
                            <div style="display: flex; flex-wrap: wrap; gap: 15px; align-items: end;">
                                <div style="min-width: 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">üìÖ T·ª´ ng√†y:</label>
                                    <div style="position: relative;">
                                        <input type="date" id="statFilterStartDate" value="${savedStartDate}" style="padding: 10px 40px 10px 10px; border: 2px solid #667eea; border-radius: 5px; width: 100%; font-size: 14px; cursor: pointer; background: white; appearance: none; -webkit-appearance: none;" onclick="if(this.showPicker) this.showPicker(); else this.focus();" onchange="loadStatistics()">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #667eea; font-size: 20px;">üìÖ</span>
                                    </div>
                                </div>
                                <div style="min-width: 200px;">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #555;">üìÖ ƒê·∫øn ng√†y:</label>
                                    <div style="position: relative;">
                                        <input type="date" id="statFilterEndDate" value="${savedEndDate}" style="padding: 10px 40px 10px 10px; border: 2px solid #667eea; border-radius: 5px; width: 100%; font-size: 14px; cursor: pointer; background: white; appearance: none; -webkit-appearance: none;" onclick="if(this.showPicker) this.showPicker(); else this.focus();" onchange="loadStatistics()">
                                        <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #667eea; font-size: 20px;">üìÖ</span>
                                    </div>
                                </div>
                                <div>
                                    <button onclick="clearDateFilter()" style="padding: 10px 20px; background: #94a3b8; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap;">X√≥a b·ªô l·ªçc</button>
                                </div>
                            </div>
                            <div style="font-size: 12px; color: #94a3b8; margin-top: 10px;">üí° ƒê·ªÉ tr·ªëng c·∫£ 2 ng√†y ƒë·ªÉ xem t·∫•t c·∫£ th·ªëng k√™</div>
                        </div>
                    `;
                    
                    // L·∫•y c√°c th·ªëng k√™ chi ti·∫øt n·∫øu c√≥ filter
                    let detailedStatsHtml = '';
                    let statusStats = {};
                    let topProducts = [];
                    let paymentStats = {};
                    let dailyData = [];
                    let ordersData = { orders: [] };
                    
                    if (params.toString()) {
                        try {
                            // L·∫•y danh s√°ch ƒë∆°n h√†ng
                            const ordersResponse = await fetch(`${API_BASE}/orders?${params.toString()}&limit=100`, {
                                headers: getAuthHeaders()
                            });
                            ordersData = await ordersResponse.json();
                            
                            // Th·ªëng k√™ theo tr·∫°ng th√°i
                            if (ordersResponse.ok && ordersData.orders) {
                                ordersData.orders.forEach(order => {
                                    const status = order.status || 'unknown';
                                    if (!statusStats[status]) {
                                        statusStats[status] = { count: 0, revenue: 0 };
                                    }
                                    statusStats[status].count++;
                                    if (order.status !== 'cancelled') {
                                        statusStats[status].revenue += order.total || 0;
                                    }
                                });
                            }
                            
                            // L·∫•y top s·∫£n ph·∫©m b√°n ch·∫°y
                            const topProductsResponse = await fetch(`${API_BASE}/statistics/top-products/quantity?${params.toString()}&limit=5`, {
                                headers: getAuthHeaders()
                            });
                            topProducts = topProductsResponse.ok ? await topProductsResponse.json() : [];
                            
                            // L·∫•y th·ªëng k√™ ph∆∞∆°ng th·ª©c thanh to√°n
                            const paymentResponse = await fetch(`${API_BASE}/statistics/payment-methods?${params.toString()}`, {
                                headers: getAuthHeaders()
                            });
                            paymentStats = paymentResponse.ok ? await paymentResponse.json() : {};
                            
                            // L·∫•y v·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m
                            let capitalByProduct = [];
                            try {
                                const capitalResponse = await fetch(`${API_BASE}/statistics/capital-by-product?${params.toString()}&limit=20`, {
                                    headers: getAuthHeaders()
                                });
                                capitalByProduct = capitalResponse.ok ? await capitalResponse.json() : [];
                            } catch (e) {
                                console.error('Error loading capital by product:', e);
                            }
                            
                            // L·∫•y doanh thu theo ng√†y (n·∫øu c√≥ filter date range)
                            if (filterStartDate && filterEndDate) {
                                try {
                                    const dailyResponse = await fetch(`${API_BASE}/statistics/revenue/daily?${params.toString()}`, {
                                        headers: getAuthHeaders()
                                    });
                                    dailyData = dailyResponse.ok ? await dailyResponse.json() : [];
                                } catch (e) {
                                    console.error('Error loading daily revenue:', e);
                                }
                            }
                            
                            // T·∫°o HTML cho th·ªëng k√™ chi ti·∫øt v·ªõi bi·ªÉu ƒë·ªì
                            detailedStatsHtml = `
                                <div class="chart-grid">
                                    <!-- Bi·ªÉu ƒë·ªì tr·∫°ng th√°i ƒë∆°n h√†ng -->
                                    ${Object.keys(statusStats).length > 0 ? `
                                        <div class="chart-container">
                                            <h3>üìä Ph√¢n b·ªë tr·∫°ng th√°i ƒë∆°n h√†ng</h3>
                                            <div class="chart-wrapper">
                                                <canvas id="statusChart"></canvas>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <!-- Bi·ªÉu ƒë·ªì ph∆∞∆°ng th·ª©c thanh to√°n -->
                                    ${Object.keys(paymentStats).filter(m => paymentStats[m].count > 0).length > 0 ? `
                                        <div class="chart-container">
                                            <h3>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
                                            <div class="chart-wrapper">
                                                <canvas id="paymentChart"></canvas>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Bi·ªÉu ƒë·ªì doanh thu theo ng√†y -->
                                ${dailyData.length > 0 ? `
                                    <div class="chart-container">
                                        <h3>üìà Doanh thu theo ng√†y</h3>
                                        <div class="chart-wrapper">
                                            <canvas id="revenueChart"></canvas>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- Bi·ªÉu ƒë·ªì top s·∫£n ph·∫©m -->
                                ${topProducts.length > 0 ? `
                                    <div class="chart-container">
                                        <h3>üèÜ Top 5 s·∫£n ph·∫©m b√°n ch·∫°y</h3>
                                        <div class="chart-wrapper">
                                            <canvas id="topProductsChart"></canvas>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- V·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m -->
                                ${capitalByProduct.length > 0 ? `
                                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <h3 style="margin-bottom: 15px; color: #333;">üí∞ V·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m</h3>
                                        <div style="overflow-x: auto;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">STT</th>
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">T√™n s·∫£n ph·∫©m</th>
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Danh m·ª•c</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Gi√° nh·∫≠p</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">S·ªë l∆∞·ª£ng b√°n</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #f59e0b;">T·ªïng v·ªën</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">Doanh thu</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">L·ª£i nhu·∫≠n</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #667eea;">T·ª∑ l·ªá LN (%)</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${capitalByProduct.map((item, index) => {
                                                        const profitColor = item.totalProfit >= 0 ? '#10b981' : '#e74c3c';
                                                        const marginColor = item.profitMargin >= 0 ? '#10b981' : '#e74c3c';
                                                        return `
                                                            <tr style="border-bottom: 1px solid #dee2e6;">
                                                                <td style="padding: 12px; font-weight: 600; color: #667eea;">${index + 1}</td>
                                                                <td style="padding: 12px; font-weight: 500;">${item.product?.name || 'N/A'}</td>
                                                                <td style="padding: 12px; color: #666;">${item.product?.category?.name || 'N/A'}</td>
                                                                <td style="padding: 12px; text-align: right; color: #f59e0b;">${(item.product?.importPrice || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600;">${item.totalQuantity || 0}</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600; color: #f59e0b;">${(item.totalCapital || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${(item.totalRevenue || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600; color: ${profitColor};">${(item.totalProfit || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600; color: ${marginColor};">${item.profitMargin >= 0 ? '+' : ''}${item.profitMargin.toFixed(2)}%</td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                                <tfoot>
                                                    <tr style="background: #f8f9fa; border-top: 2px solid #dee2e6; font-weight: 700;">
                                                        <td colspan="5" style="padding: 12px; text-align: right;">T·ªîNG:</td>
                                                        <td style="padding: 12px; text-align: right; color: #f59e0b;">
                                                            ${capitalByProduct.reduce((sum, item) => sum + (item.totalCapital || 0), 0).toLocaleString('vi-VN')} VNƒê
                                                        </td>
                                                        <td style="padding: 12px; text-align: right; color: #28a745;">
                                                            ${capitalByProduct.reduce((sum, item) => sum + (item.totalRevenue || 0), 0).toLocaleString('vi-VN')} VNƒê
                                                        </td>
                                                        <td style="padding: 12px; text-align: right; color: #10b981;">
                                                            ${capitalByProduct.reduce((sum, item) => sum + (item.totalProfit || 0), 0).toLocaleString('vi-VN')} VNƒê
                                                        </td>
                                                        <td style="padding: 12px;"></td>
                                                    </tr>
                                                </tfoot>
                                            </table>
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <!-- B·∫£ng th·ªëng k√™ tr·∫°ng th√°i (backup) -->
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <h3 style="margin-bottom: 15px; color: #333;">üìã Chi ti·∫øt theo tr·∫°ng th√°i</h3>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                                        ${Object.entries(statusStats).map(([status, stat]) => {
                                            const statusText = getStatusText(status);
                                            return `
                                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #667eea;">
                                                    <div style="font-size: 12px; color: #666; margin-bottom: 5px;">${statusText}</div>
                                                    <div style="font-size: 20px; font-weight: 700; color: #333;">${stat.count}</div>
                                                    <div style="font-size: 14px; color: #28a745; margin-top: 5px;">${stat.revenue.toLocaleString('vi-VN')} VNƒê</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                                
                                <!-- Chi ti·∫øt ƒë∆°n h√†ng -->
                                ${ordersData.orders && ordersData.orders.length > 0 ? `
                                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                        <h3 style="margin-bottom: 15px; color: #333;">üìã Chi ti·∫øt ƒë∆°n h√†ng (${ordersData.orders.length} ƒë∆°n)</h3>
                                        <div style="overflow-x: auto;">
                                            <table style="width: 100%; border-collapse: collapse;">
                                                <thead>
                                                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">M√£ ƒë∆°n</th>
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Kh√°ch h√†ng</th>
                                                        <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">SƒêT</th>
                                                        <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">T·ªïng ti·ªÅn</th>
                                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Tr·∫°ng th√°i</th>
                                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Ng√†y t·∫°o</th>
                                                        <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Thao t√°c</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    ${ordersData.orders.map(order => {
                                                        const statusClass = {
                                                            'new': 'status-pending',
                                                            'processing': 'status-processing',
                                                            'shipping': 'status-shipping',
                                                            'completed': 'status-completed',
                                                            'cancelled': 'status-cancelled'
                                                        }[order.status] || 'status-pending';
                                                        
                                                        return `
                                                            <tr style="border-bottom: 1px solid #dee2e6;">
                                                                <td style="padding: 12px;"><strong>${order.orderNumber || order._id}</strong></td>
                                                                <td style="padding: 12px;">${order.customer?.fullName || 'N/A'}</td>
                                                                <td style="padding: 12px;">${order.customer?.phone || 'N/A'}</td>
                                                                <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${(order.total || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                                <td style="padding: 12px; text-align: center;">
                                                                    <span class="status-badge ${statusClass}">${getStatusText(order.status)}</span>
                                                                </td>
                                                                <td style="padding: 12px; text-align: center;">${new Date(order.createdAt).toLocaleString('vi-VN')}</td>
                                                                <td style="padding: 12px; text-align: center;">
                                                                    <button class="btn-sm btn-view" onclick="viewOrder('${order._id}')" style="margin-right: 5px;">Xem</button>
                                                                    ${order.status !== 'completed' && order.status !== 'cancelled' ? 
                                                                        `<button class="btn-sm btn-edit" onclick="updateOrderStatus('${order._id}')">C·∫≠p nh·∫≠t</button>` : ''}
                                                                </td>
                                                            </tr>
                                                        `;
                                                    }).join('')}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                ` : ordersData.orders && ordersData.orders.length === 0 ? `
                                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; color: #6c757d;">
                                        <p>Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o trong kho·∫£ng th·ªùi gian ƒë√£ ch·ªçn.</p>
                                    </div>
                                ` : ''}
                            `;
                        } catch (detailedError) {
                            console.error('Error loading detailed statistics:', detailedError);
                            detailedStatsHtml = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; color: #dc3545;">
                                    <p>L·ªói t·∫£i th·ªëng k√™ chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i.</p>
                                </div>
                            `;
                        }
                    }
                    
                    // L∆∞u filter params ƒë·ªÉ d√πng khi click v√†o card
                    const filterParams = params.toString();
                    
                    document.getElementById('statisticsContent').innerHTML = filterHtml + `
                        <div class="stats-grid">
                            <div class="stat-card clickable" onclick="showStatDetail('orders', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>T·ªïng ƒë∆°n h√†ng</h4>
                                <div class="value" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${data.totalOrders || 0}</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('revenue', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>T·ªïng doanh thu</h4>
                                <div class="value" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${(data.totalRevenue || 0).toLocaleString('vi-VN')} VNƒê</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('capital', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>T·ªïng v·ªën</h4>
                                <div class="value" style="color: #f59e0b; word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${(data.totalCapital || 0).toLocaleString('vi-VN')} VNƒê</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('profit', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>L·ª£i nhu·∫≠n</h4>
                                <div class="value" style="color: ${(data.totalProfit || 0) >= 0 ? '#10b981' : '#e74c3c'}; word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${(data.totalProfit || 0).toLocaleString('vi-VN')} VNƒê</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('products', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>T·ªïng s·∫£n ph·∫©m</h4>
                                <div class="value" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${data.totalProducts || 0}</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('customers', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>T·ªïng kh√°ch h√†ng</h4>
                                <div class="value" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${data.totalCustomers || 0}</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                            <div class="stat-card clickable" onclick="showStatDetail('lowstock', '${filterParams}')" title="Click ƒë·ªÉ xem chi ti·∫øt">
                                <h4>S·∫£n ph·∫©m t·ªìn kho th·∫•p</h4>
                                <div class="value" style="word-break: break-word; overflow-wrap: break-word; max-width: 100%;">${data.lowStockProducts || 0}</div>
                                <div style="font-size: 11px; color: #94a3b8; margin-top: 8px;">üëÜ Click ƒë·ªÉ xem chi ti·∫øt</div>
                            </div>
                        </div>
                        <div id="statDetailSection"></div>
                        ${detailedStatsHtml}
                    `;
                    
                    // Render bi·ªÉu ƒë·ªì sau khi HTML ƒë∆∞·ª£c t·∫°o (ch·ªâ khi c√≥ filter)
                    if (params.toString()) {
                        setTimeout(() => {
                            renderCharts(statusStats, paymentStats, dailyData, topProducts);
                        }, 100);
                    }
                }
            } catch (error) {
                console.error('Load statistics error:', error);
                document.getElementById('statisticsContent').innerHTML = '<div class="loading">L·ªói t·∫£i th·ªëng k√™!</div>';
            }
        }
        
        // Render c√°c bi·ªÉu ƒë·ªì
        function renderCharts(statusStats, paymentStats, dailyData, topProducts) {
            // H·ªßy c√°c bi·ªÉu ƒë·ªì c≈© n·∫øu c√≥
            if (window.statusChartInstance) window.statusChartInstance.destroy();
            if (window.paymentChartInstance) window.paymentChartInstance.destroy();
            if (window.revenueChartInstance) window.revenueChartInstance.destroy();
            if (window.topProductsChartInstance) window.topProductsChartInstance.destroy();
            
            // Bi·ªÉu ƒë·ªì tr·∫°ng th√°i ƒë∆°n h√†ng (Doughnut)
            const statusCtx = document.getElementById('statusChart');
            if (statusCtx && Object.keys(statusStats).length > 0) {
                const statusLabels = Object.keys(statusStats).map(status => getStatusText(status));
                const statusData = Object.values(statusStats).map(stat => stat.count);
                const statusColors = {
                    'new': '#f59e0b',
                    'processing': '#3b82f6',
                    'shipping': '#8b5cf6',
                    'completed': '#10b981',
                    'cancelled': '#ef4444'
                };
                const backgroundColors = Object.keys(statusStats).map(status => 
                    statusColors[status] || '#94a3b8'
                );
                
                window.statusChartInstance = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: statusLabels,
                        datasets: [{
                            data: statusData,
                            backgroundColor: backgroundColors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return `${label}: ${value} ƒë∆°n (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Bi·ªÉu ƒë·ªì ph∆∞∆°ng th·ª©c thanh to√°n (Pie)
            const paymentCtx = document.getElementById('paymentChart');
            if (paymentCtx && Object.keys(paymentStats).filter(m => paymentStats[m].count > 0).length > 0) {
                const methodNames = {
                    'COD': 'Thanh to√°n khi nh·∫≠n h√†ng',
                    'cash': 'Ti·ªÅn m·∫∑t',
                    'card': 'Th·∫ª',
                    'e-wallet': 'V√≠ ƒëi·ªán t·ª≠',
                    'zalopay': 'ZaloPay',
                    'momo': 'MoMo'
                };
                const paymentEntries = Object.entries(paymentStats).filter(([method, stat]) => stat.count > 0);
                const paymentLabels = paymentEntries.map(([method]) => methodNames[method] || method);
                const paymentData = paymentEntries.map(([, stat]) => stat.count);
                const paymentColors = ['#667eea', '#764ba2', '#f093fb', '#4facfe', '#43e97b', '#fa709a'];
                
                window.paymentChartInstance = new Chart(paymentCtx, {
                    type: 'pie',
                    data: {
                        labels: paymentLabels,
                        datasets: [{
                            data: paymentData,
                            backgroundColor: paymentColors.slice(0, paymentData.length),
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        const revenue = paymentEntries[context.dataIndex][1].revenue;
                                        return [
                                            `${label}: ${value} ƒë∆°n (${percentage}%)`,
                                            `Doanh thu: ${revenue.toLocaleString('vi-VN')} VNƒê`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Bi·ªÉu ƒë·ªì doanh thu theo ng√†y (Line)
            const revenueCtx = document.getElementById('revenueChart');
            if (revenueCtx && dailyData.length > 0) {
                const revenueLabels = dailyData.map(d => new Date(d.date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
                const revenueData = dailyData.map(d => d.revenue);
                const orderCountData = dailyData.map(d => d.count);
                
                window.revenueChartInstance = new Chart(revenueCtx, {
                    type: 'line',
                    data: {
                        labels: revenueLabels,
                        datasets: [
                            {
                                label: 'Doanh thu (VNƒê)',
                                data: revenueData,
                                borderColor: '#667eea',
                                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y'
                            },
                            {
                                label: 'S·ªë ƒë∆°n h√†ng',
                                data: orderCountData,
                                borderColor: '#10b981',
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                tension: 0.4,
                                fill: true,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `Doanh thu: ${context.parsed.y.toLocaleString('vi-VN')} VNƒê`;
                                        } else {
                                            return `S·ªë ƒë∆°n: ${context.parsed.y} ƒë∆°n`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Doanh thu (VNƒê)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'S·ªë ƒë∆°n h√†ng'
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            }
                        }
                    }
                });
            }
            
            // Bi·ªÉu ƒë·ªì top s·∫£n ph·∫©m (Bar)
            const topProductsCtx = document.getElementById('topProductsChart');
            if (topProductsCtx && topProducts.length > 0) {
                const productLabels = topProducts.map(item => item.product?.name || 'N/A').slice(0, 10);
                const quantityData = topProducts.map(item => item.quantity || 0).slice(0, 10);
                const revenueData = topProducts.map(item => item.revenue || 0).slice(0, 10);
                
                window.topProductsChartInstance = new Chart(topProductsCtx, {
                    type: 'bar',
                    data: {
                        labels: productLabels,
                        datasets: [
                            {
                                label: 'S·ªë l∆∞·ª£ng b√°n',
                                data: quantityData,
                                backgroundColor: 'rgba(102, 126, 234, 0.8)',
                                borderColor: '#667eea',
                                borderWidth: 1,
                                yAxisID: 'y'
                            },
                            {
                                label: 'Doanh thu (VNƒê)',
                                data: revenueData,
                                backgroundColor: 'rgba(16, 185, 129, 0.8)',
                                borderColor: '#10b981',
                                borderWidth: 1,
                                yAxisID: 'y1'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        if (context.datasetIndex === 0) {
                                            return `S·ªë l∆∞·ª£ng: ${context.parsed.y} s·∫£n ph·∫©m`;
                                        } else {
                                            return `Doanh thu: ${context.parsed.y.toLocaleString('vi-VN')} VNƒê`;
                                        }
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'S·ªë l∆∞·ª£ng b√°n'
                                },
                                beginAtZero: true
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Doanh thu (VNƒê)'
                                },
                                grid: {
                                    drawOnChartArea: false
                                },
                                ticks: {
                                    callback: function(value) {
                                        return (value / 1000000).toFixed(1) + 'M';
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // Clear date filter
        function clearDateFilter() {
            document.getElementById('statFilterStartDate').value = '';
            document.getElementById('statFilterEndDate').value = '';
            localStorage.removeItem('statFilterStartDate');
            localStorage.removeItem('statFilterEndDate');
            loadStatistics();
        }
        
        // Hi·ªÉn th·ªã chi ti·∫øt khi click v√†o stat card
        async function showStatDetail(type, filterParams) {
            const detailSection = document.getElementById('statDetailSection');
            if (!detailSection) return;
            
            // Scroll ƒë·∫øn ph·∫ßn chi ti·∫øt
            detailSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            // Hi·ªÉn th·ªã loading
            detailSection.innerHTML = '<div class="loading">ƒêang t·∫£i chi ti·∫øt...</div>';
            
            try {
                let html = '';
                
                // X·ª≠ l√Ω filterParams - n·∫øu r·ªóng th√¨ ch·ªâ d√πng limit
                const queryString = filterParams ? `${filterParams}&limit=100` : 'limit=100';
                
                switch(type) {
                    case 'orders':
                        // Chi ti·∫øt ƒë∆°n h√†ng
                        const ordersResponse = await fetch(`${API_BASE}/orders?${queryString}`, {
                            headers: getAuthHeaders()
                        });
                        if (!ordersResponse.ok) {
                            throw new Error(ordersResponse.statusText || 'L·ªói t·∫£i d·ªØ li·ªáu');
                        }
                        
                        const ordersData = await ordersResponse.json();
                        
                        if (ordersData.orders && ordersData.orders.length > 0) {
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üìã Chi ti·∫øt ƒë∆°n h√†ng (${ordersData.orders.length} ƒë∆°n)</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">M√£ ƒë∆°n</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Kh√°ch h√†ng</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">SƒêT</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">T·ªïng ti·ªÅn</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Tr·∫°ng th√°i</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Ng√†y t·∫°o</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Thao t√°c</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${ordersData.orders.map(order => {
                                                    const statusClass = {
                                                        'new': 'status-pending',
                                                        'processing': 'status-processing',
                                                        'shipping': 'status-shipping',
                                                        'completed': 'status-completed',
                                                        'cancelled': 'status-cancelled'
                                                    }[order.status] || 'status-pending';
                                                    
                                                    return `
                                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                                            <td style="padding: 12px;"><strong>${order.orderNumber || order._id}</strong></td>
                                                            <td style="padding: 12px;">${order.customer?.fullName || 'N/A'}</td>
                                                            <td style="padding: 12px;">${order.customer?.phone || 'N/A'}</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${(order.total || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                            <td style="padding: 12px; text-align: center;">
                                                                <span class="status-badge ${statusClass}">${getStatusText(order.status)}</span>
                                                            </td>
                                                            <td style="padding: 12px; text-align: center;">${new Date(order.createdAt).toLocaleString('vi-VN')}</td>
                                                            <td style="padding: 12px; text-align: center;">
                                                                <button class="btn-sm btn-view" onclick="viewOrder('${order._id}')" style="margin-right: 5px;">Xem</button>
                                                                ${order.status !== 'completed' && order.status !== 'cancelled' ? 
                                                                    `<button class="btn-sm btn-edit" onclick="updateOrderStatus('${order._id}')">C·∫≠p nh·∫≠t</button>` : ''}
                                                            </td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #6c757d;">Kh√¥ng c√≥ ƒë∆°n h√†ng n√†o.</div>';
                        }
                        break;
                        
                    case 'revenue':
                        // Bi·ªÉu ƒë·ªì doanh thu
                        // N·∫øu kh√¥ng c√≥ filter, l·∫•y 30 ng√†y g·∫ßn nh·∫•t
                        let revenueUrl = `${API_BASE}/statistics/revenue/daily`;
                        if (filterParams) {
                            revenueUrl += `?${filterParams}`;
                        } else {
                            // L·∫•y 30 ng√†y g·∫ßn nh·∫•t
                            const endDate = new Date();
                            const startDate = new Date();
                            startDate.setDate(endDate.getDate() - 30);
                            revenueUrl += `?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                        }
                        const revenueResponse = await fetch(revenueUrl, {
                            headers: getAuthHeaders()
                        });
                        const revenueData = revenueResponse.ok ? await revenueResponse.json() : [];
                        
                        if (revenueData.length > 0) {
                            const maxRevenue = Math.max(...revenueData.map(d => d.revenue));
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üìà Ph√¢n t√≠ch doanh thu theo ng√†y</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="display: grid; gap: 10px;">
                                        ${revenueData.map(day => {
                                            const percentage = maxRevenue > 0 ? (day.revenue / maxRevenue * 100) : 0;
                                            return `
                                                <div style="display: flex; align-items: center; gap: 15px;">
                                                    <div style="min-width: 120px; font-size: 12px; color: #666;">${new Date(day.date).toLocaleDateString('vi-VN')}</div>
                                                    <div style="flex: 1; background: #e9ecef; border-radius: 5px; height: 35px; position: relative; overflow: hidden;">
                                                        <div style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${percentage}%; display: flex; align-items: center; justify-content: flex-end; padding-right: 10px; color: white; font-weight: 600; font-size: 12px;">
                                                            ${day.revenue > 0 ? day.revenue.toLocaleString('vi-VN') + ' VNƒê' : ''}
                                                        </div>
                                                    </div>
                                                    <div style="min-width: 150px; text-align: right; font-weight: 600; color: #28a745;">${day.revenue.toLocaleString('vi-VN')} VNƒê</div>
                                                    <div style="min-width: 80px; text-align: center; color: #666; font-size: 12px;">${day.count} ƒë∆°n</div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                </div>
                            `;
                        } else {
                            html = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #6c757d;">Kh√¥ng c√≥ d·ªØ li·ªáu doanh thu.</div>';
                        }
                        break;
                        
                    case 'products':
                        // Danh s√°ch s·∫£n ph·∫©m
                        const productsResponse = await fetch(`${API_BASE}/products?${queryString}`, {
                            headers: getAuthHeaders()
                        });
                        const productsData = productsResponse.ok ? await productsResponse.json() : {};
                        const products = productsData.products || [];
                        
                        if (products.length > 0) {
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üì¶ Danh s√°ch s·∫£n ph·∫©m (${products.length} s·∫£n ph·∫©m)</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">T√™n s·∫£n ph·∫©m</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Danh m·ª•c</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Gi√° b√°n</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">T·ªìn kho</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Tr·∫°ng th√°i</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${products.map(product => `
                                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                                        <td style="padding: 12px;">${product.name || 'N/A'}</td>
                                                        <td style="padding: 12px; color: #666;">${product.category?.name || 'N/A'}</td>
                                                        <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${(product.price || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                        <td style="padding: 12px; text-align: right;">${product.stock || 0}</td>
                                                        <td style="padding: 12px; text-align: center;">
                                                            <span class="status-badge ${product.status === 1 ? 'status-completed' : 'status-cancelled'}">${product.status === 1 ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}</span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #6c757d;">Kh√¥ng c√≥ s·∫£n ph·∫©m n√†o.</div>';
                        }
                        break;
                        
                    case 'customers':
                        // Danh s√°ch kh√°ch h√†ng
                        const customersResponse = await fetch(`${API_BASE}/users/customers/list?${queryString}`, {
                            headers: getAuthHeaders()
                        });
                        const customersData = customersResponse.ok ? await customersResponse.json() : {};
                        // API tr·∫£ v·ªÅ 'customers' ch·ª© kh√¥ng ph·∫£i 'users'
                        const customers = customersData.customers || customersData.users || [];
                        
                        if (customers.length > 0) {
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üë• Danh s√°ch kh√°ch h√†ng (${customers.length} kh√°ch h√†ng)</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">T√™n</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Email</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">SƒêT</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Tr·∫°ng th√°i</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">Ng√†y t·∫°o</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${customers.map(customer => `
                                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                                        <td style="padding: 12px;">${customer.fullName || 'N/A'}</td>
                                                        <td style="padding: 12px;">${customer.email || 'N/A'}</td>
                                                        <td style="padding: 12px;">${customer.phone || 'N/A'}</td>
                                                        <td style="padding: 12px; text-align: center;">
                                                            <span class="status-badge ${customer.isBanned ? 'status-cancelled' : 'status-completed'}">${customer.isBanned ? 'ƒê√£ kh√≥a' : 'Ho·∫°t ƒë·ªông'}</span>
                                                        </td>
                                                        <td style="padding: 12px; text-align: center;">${new Date(customer.createdAt).toLocaleDateString('vi-VN')}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #6c757d;">Kh√¥ng c√≥ kh√°ch h√†ng n√†o.</div>';
                        }
                        break;
                        
                    case 'lowstock':
                        // S·∫£n ph·∫©m t·ªìn kho th·∫•p
                        const lowStockResponse = await fetch(`${API_BASE}/statistics/low-stock`, {
                            headers: getAuthHeaders()
                        });
                        const lowStockData = lowStockResponse.ok ? await lowStockResponse.json() : [];
                        
                        if (lowStockData.length > 0) {
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">‚ö†Ô∏è S·∫£n ph·∫©m t·ªìn kho th·∫•p (${lowStockData.length} s·∫£n ph·∫©m)</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">T√™n s·∫£n ph·∫©m</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Danh m·ª•c</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">T·ªìn kho</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">T·ªìn kho t·ªëi thi·ªÉu</th>
                                                    <th style="padding: 12px; text-align: center; font-weight: 600; color: #495057;">C·∫£nh b√°o</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${lowStockData.map(item => `
                                                    <tr style="border-bottom: 1px solid #dee2e6;">
                                                        <td style="padding: 12px;">${item.product?.name || 'N/A'}</td>
                                                        <td style="padding: 12px; color: #666;">${item.product?.category?.name || 'N/A'}</td>
                                                        <td style="padding: 12px; text-align: right; font-weight: 600; color: ${item.stock < 3 ? '#dc3545' : '#f59e0b'};">${item.stock || 0}</td>
                                                        <td style="padding: 12px; text-align: right;">${item.minStock || 0}</td>
                                                        <td style="padding: 12px; text-align: center;">
                                                            <span class="status-badge ${item.warning ? 'status-cancelled' : 'status-pending'}">${item.warning ? 'C·∫ßn nh·∫≠p h√†ng' : 'S·∫Øp h·∫øt'}</span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = '<div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; color: #28a745;">T·∫•t c·∫£ s·∫£n ph·∫©m ƒë·ªÅu ƒë·ªß t·ªìn kho!</div>';
                        }
                        break;
                        
                    case 'capital':
                        // V·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m
                        let capitalUrl = `${API_BASE}/statistics/capital-by-product`;
                        if (filterParams) {
                            capitalUrl += `?${filterParams}&limit=50`;
                        } else {
                            capitalUrl += '?limit=50';
                        }
                        
                        const capitalResponse = await fetch(capitalUrl, {
                            headers: getAuthHeaders()
                        });
                        const capitalData = capitalResponse.ok ? await capitalResponse.json() : [];
                        
                        if (capitalData.length > 0) {
                            const totalCapital = capitalData.reduce((sum, item) => sum + (item.totalCapital || 0), 0);
                            const totalRevenue = capitalData.reduce((sum, item) => sum + (item.totalRevenue || 0), 0);
                            const totalProfit = capitalData.reduce((sum, item) => sum + (item.totalProfit || 0), 0);
                            
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üí∞ V·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m (${capitalData.length} s·∫£n ph·∫©m)</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    
                                    <!-- T·ªïng h·ª£p -->
                                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                                        <div style="background: #fff7ed; padding: 15px; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">T·ªïng v·ªën ƒë·∫ßu t∆∞</div>
                                            <div style="font-size: 20px; font-weight: 700; color: #f59e0b;">${totalCapital.toLocaleString('vi-VN')} VNƒê</div>
                                        </div>
                                        <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">T·ªïng doanh thu</div>
                                            <div style="font-size: 20px; font-weight: 700; color: #28a745;">${totalRevenue.toLocaleString('vi-VN')} VNƒê</div>
                                        </div>
                                        <div style="background: ${totalProfit >= 0 ? '#f0fdf4' : '#fef2f2'}; padding: 15px; border-radius: 8px; border-left: 4px solid ${totalProfit >= 0 ? '#10b981' : '#e74c3c'};">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">T·ªïng l·ª£i nhu·∫≠n</div>
                                            <div style="font-size: 20px; font-weight: 700; color: ${totalProfit >= 0 ? '#10b981' : '#e74c3c'};">${totalProfit.toLocaleString('vi-VN')} VNƒê</div>
                                        </div>
                                    </div>
                                    
                                    <div style="overflow-x: auto;">
                                        <table style="width: 100%; border-collapse: collapse;">
                                            <thead>
                                                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">STT</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">T√™n s·∫£n ph·∫©m</th>
                                                    <th style="padding: 12px; text-align: left; font-weight: 600; color: #495057;">Danh m·ª•c</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">Gi√° nh·∫≠p</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #495057;">S·ªë l∆∞·ª£ng b√°n</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #f59e0b;">T·ªïng v·ªën</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">Doanh thu</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #10b981;">L·ª£i nhu·∫≠n</th>
                                                    <th style="padding: 12px; text-align: right; font-weight: 600; color: #667eea;">T·ª∑ l·ªá LN (%)</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${capitalData.map((item, index) => {
                                                    const profitColor = item.totalProfit >= 0 ? '#10b981' : '#e74c3c';
                                                    const marginColor = item.profitMargin >= 0 ? '#10b981' : '#e74c3c';
                                                    return `
                                                        <tr style="border-bottom: 1px solid #dee2e6;">
                                                            <td style="padding: 12px; font-weight: 600; color: #667eea;">${index + 1}</td>
                                                            <td style="padding: 12px; font-weight: 500;">${item.product?.name || 'N/A'}</td>
                                                            <td style="padding: 12px; color: #666;">${item.product?.category?.name || 'N/A'}</td>
                                                            <td style="padding: 12px; text-align: right; color: #f59e0b;">${(item.product?.importPrice || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600;">${item.totalQuantity || 0}</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #f59e0b;">${(item.totalCapital || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600; color: #28a745;">${(item.totalRevenue || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600; color: ${profitColor};">${(item.totalProfit || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                            <td style="padding: 12px; text-align: right; font-weight: 600; color: ${marginColor};">${item.profitMargin >= 0 ? '+' : ''}${item.profitMargin.toFixed(2)}%</td>
                                                        </tr>
                                                    `;
                                                }).join('')}
                                            </tbody>
                                            <tfoot>
                                                <tr style="background: #f8f9fa; border-top: 2px solid #dee2e6; font-weight: 700;">
                                                    <td colspan="5" style="padding: 12px; text-align: right;">T·ªîNG:</td>
                                                    <td style="padding: 12px; text-align: right; color: #f59e0b;">
                                                        ${totalCapital.toLocaleString('vi-VN')} VNƒê
                                                    </td>
                                                    <td style="padding: 12px; text-align: right; color: #28a745;">
                                                        ${totalRevenue.toLocaleString('vi-VN')} VNƒê
                                                    </td>
                                                    <td style="padding: 12px; text-align: right; color: ${totalProfit >= 0 ? '#10b981' : '#e74c3c'};">
                                                        ${totalProfit.toLocaleString('vi-VN')} VNƒê
                                                    </td>
                                                    <td style="padding: 12px;"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            `;
                        } else {
                            html = `
                                <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                        <h3 style="color: #333; margin: 0;">üí∞ V·ªën ƒë·∫ßu t∆∞ theo s·∫£n ph·∫©m</h3>
                                        <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                    </div>
                                    <div style="text-align: center; padding: 40px; color: #6c757d;">
                                        <p>Kh√¥ng c√≥ d·ªØ li·ªáu v·ªën ƒë·∫ßu t∆∞.</p>
                                        <p style="margin-top: 10px; font-size: 12px;">Vui l√≤ng √°p d·ª•ng filter th·ªùi gian ƒë·ªÉ xem chi ti·∫øt.</p>
                                    </div>
                                </div>
                            `;
                        }
                        break;
                        
                    case 'profit':
                        html = `
                            <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="color: #333; margin: 0;">üí∞ Ph√¢n t√≠ch l·ª£i nhu·∫≠n</h3>
                                    <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                                </div>
                                <div style="text-align: center; padding: 40px; color: #6c757d;">
                                    <p>Th√¥ng tin l·ª£i nhu·∫≠n ƒë∆∞·ª£c t√≠nh t·ª´ ch√™nh l·ªách gi·ªØa gi√° b√°n v√† gi√° nh·∫≠p c·ªßa t·ª´ng s·∫£n ph·∫©m trong ƒë∆°n h√†ng.</p>
                                    <p style="margin-top: 10px;">ƒê·ªÉ xem chi ti·∫øt, vui l√≤ng xem ph·∫ßn "Chi ti·∫øt ƒë∆°n h√†ng" b√™n d∆∞·ªõi.</p>
                                </div>
                            </div>
                        `;
                        break;
                        
                    default:
                        html = '';
                }
                
                detailSection.innerHTML = html;
            } catch (error) {
                console.error('Error loading stat detail:', error);
                detailSection.innerHTML = `
                    <div style="background: white; padding: 20px; border-radius: 10px; margin-top: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="color: #dc3545; margin: 0;">‚ùå L·ªói t·∫£i d·ªØ li·ªáu</h3>
                            <button onclick="document.getElementById('statDetailSection').innerHTML = ''" style="padding: 8px 16px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer;">ƒê√≥ng</button>
                        </div>
                        <div style="text-align: center; padding: 20px; color: #6c757d;">
                            <p>Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.</p>
                            <p style="font-size: 12px; margin-top: 10px; color: #999;">${error.message || 'L·ªói kh√¥ng x√°c ƒë·ªãnh'}</p>
                        </div>
                    </div>
                `;
            }
        }

        // Change Password
        function showChangePassword() {
            document.getElementById('changePasswordForm').reset();
            document.getElementById('changePasswordModal').classList.add('active');
        }

        document.getElementById('changePasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const oldPassword = document.getElementById('oldPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (newPassword !== confirmPassword) {
                document.getElementById('changePasswordError').textContent = 'M·∫≠t kh·∫©u m·ªõi kh√¥ng kh·ªõp!';
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/change-password`, {
                    method: 'PUT',
                    headers: getAuthHeaders(),
                    body: JSON.stringify({ oldPassword, newPassword, confirmPassword })
                });

                const data = await response.json();
                if (response.ok) {
                    alert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
                    closeModal('changePasswordModal');
                } else {
                    document.getElementById('changePasswordError').textContent = data.message || 'C√≥ l·ªói x·∫£y ra!';
                }
            } catch (error) {
                document.getElementById('changePasswordError').textContent = 'L·ªói k·∫øt n·ªëi server!';
            }
        });

        // Utility functions
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function renderPagination(containerId, currentPage, totalPages, onPageChange) {
            const container = document.getElementById(containerId);
            if (totalPages <= 1) {
                container.innerHTML = '';
                return;
            }

            // Store callback in data attribute
            container.setAttribute('data-callback', onPageChange.toString());

            let html = '';
            if (currentPage > 1) {
                html += `<button onclick="handlePagination('${containerId}', ${currentPage - 1})">Tr∆∞·ªõc</button>`;
            }

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    html += `<button class="${i === currentPage ? 'active' : ''}" onclick="handlePagination('${containerId}', ${i})">${i}</button>`;
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    html += `<span>...</span>`;
                }
            }

            if (currentPage < totalPages) {
                html += `<button onclick="handlePagination('${containerId}', ${currentPage + 1})">Sau</button>`;
            }

            container.innerHTML = html;
            // Store callback function reference
            container._callback = onPageChange;
        }

        function handlePagination(containerId, page) {
            const container = document.getElementById(containerId);
            if (container._callback) {
                container._callback(page);
            }
        }

        function loadDashboard() {
            // Load initial data if needed
        }

        // View functions
        async function viewOrder(id) {
            try {
                const response = await fetch(`${API_BASE}/orders/${id}`, {
                    headers: getAuthHeaders()
                });
                const order = await response.json();

                if (response.ok) {
                    // T·∫°o ƒë·ªãa ch·ªâ giao h√†ng ƒë·∫ßy ƒë·ªß
                    const shippingAddr = order.shippingAddress || {};
                    const fullAddress = [
                        shippingAddr.address || '',
                        shippingAddr.ward ? `Ph∆∞·ªùng/X√£: ${shippingAddr.ward}` : '',
                        shippingAddr.district ? `Qu·∫≠n/Huy·ªán: ${shippingAddr.district}` : '',
                        shippingAddr.city ? `T·ªânh/TP: ${shippingAddr.city}` : ''
                    ].filter(Boolean).join(', ');

                    // T·∫°o modal hi·ªÉn th·ªã chi ti·∫øt
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.id = 'orderDetailModal';
                    modal.innerHTML = `
                        <div class="modal-content" style="max-width: 800px;">
                            <div class="modal-header">
                                <h2>Chi ti·∫øt ƒë∆°n h√†ng: ${order.orderNumber || id}</h2>
                                <button class="close-btn" onclick="closeOrderDetailModal()">&times;</button>
                            </div>
                            <div style="max-height: 80vh; overflow-y: auto;">
                                <!-- Th√¥ng tin kh√°ch h√†ng -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üë§ Th√¥ng tin kh√°ch h√†ng</h3>
                                    <p style="margin: 5px 0;"><strong>T√™n:</strong> ${order.customer?.fullName || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Email:</strong> ${order.customer?.email || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>SƒêT:</strong> ${order.customer?.phone || 'N/A'}</p>
                                </div>

                                <!-- ƒê·ªãa ch·ªâ giao h√†ng -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üìç ƒê·ªãa ch·ªâ giao h√†ng</h3>
                                    <p style="margin: 5px 0;"><strong>Ng∆∞·ªùi nh·∫≠n:</strong> ${shippingAddr.fullName || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>SƒêT:</strong> ${shippingAddr.phone || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>ƒê·ªãa ch·ªâ:</strong> ${fullAddress || 'N/A'}</p>
                                </div>

                                <!-- Th√¥ng tin ƒë∆°n h√†ng -->
                                <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px;">
                                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üìã Th√¥ng tin ƒë∆°n h√†ng</h3>
                                    <p style="margin: 5px 0;"><strong>Tr·∫°ng th√°i:</strong> <span class="status-badge status-${order.status}">${getStatusText(order.status)}</span></p>
                                    <p style="margin: 5px 0;"><strong>Ph∆∞∆°ng th·ª©c thanh to√°n:</strong> ${order.paymentMethod || 'N/A'}</p>
                                    <p style="margin: 5px 0;"><strong>Tr·∫°ng th√°i thanh to√°n:</strong> <span class="status-badge status-${getPaymentStatusColor(order.paymentStatus || 'pending')}">${getPaymentStatusText(order.paymentStatus || 'pending')}</span></p>
                                    <p style="margin: 5px 0;"><strong>Ng√†y t·∫°o:</strong> ${new Date(order.createdAt).toLocaleString('vi-VN')}</p>
                                    ${order.completedAt ? `<p style="margin: 5px 0;"><strong>Ng√†y ho√†n th√†nh:</strong> ${new Date(order.completedAt).toLocaleString('vi-VN')}</p>` : ''}
                                </div>

                                <!-- S·∫£n ph·∫©m -->
                                <div style="margin-bottom: 20px;">
                                    <h3 style="margin: 0 0 15px 0; color: #667eea;">üõçÔ∏è S·∫£n ph·∫©m</h3>
                                    <table style="width: 100%; border-collapse: collapse;">
                                        <thead>
                                            <tr style="background: #667eea; color: white;">
                                                <th style="padding: 10px; text-align: left;">S·∫£n ph·∫©m</th>
                                                <th style="padding: 10px; text-align: center;">S·ªë l∆∞·ª£ng</th>
                                                <th style="padding: 10px; text-align: right;">Gi√°</th>
                                                <th style="padding: 10px; text-align: right;">Th√†nh ti·ªÅn</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${order.items?.map(item => `
                                                <tr style="border-bottom: 1px solid #dee2e6;">
                                                    <td style="padding: 10px;">${item.product?.name || 'N/A'}</td>
                                                    <td style="padding: 10px; text-align: center;">${item.quantity || 0}</td>
                                                    <td style="padding: 10px; text-align: right;">${(item.price || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                    <td style="padding: 10px; text-align: right; font-weight: 600;">${(item.subtotal || 0).toLocaleString('vi-VN')} VNƒê</td>
                                                </tr>
                                            `).join('') || '<tr><td colspan="4" style="padding: 20px; text-align: center;">Kh√¥ng c√≥ s·∫£n ph·∫©m</td></tr>'}
                                        </tbody>
                                        <tfoot>
                                            <tr style="background: #f8f9fa;">
                                                <td colspan="3" style="padding: 10px; text-align: right;">T·ªïng ti·ªÅn s·∫£n ph·∫©m:</td>
                                                <td style="padding: 10px; text-align: right; font-weight: 600;">
                                                    ${(order.subtotal || 0).toLocaleString('vi-VN')} VNƒê
                                                </td>
                                            </tr>
                                            <tr style="background: #f8f9fa;">
                                                <td colspan="3" style="padding: 10px; text-align: right;">Ph√≠ v·∫≠n chuy·ªÉn:</td>
                                                <td style="padding: 10px; text-align: right; font-weight: 600;">
                                                    ${(order.shippingFee || 0).toLocaleString('vi-VN')} VNƒê
                                                </td>
                                            </tr>
                                            ${order.voucherCode ? `
                                            <tr style="background: #e8f5e9;">
                                                <td colspan="3" style="padding: 10px; text-align: right; color: #2e7d32;">
                                                    <strong>üé´ M√£ voucher:</strong> ${order.voucherCode}
                                                    ${order.voucherDiscount ? `<br><small>Gi·∫£m gi√°: -${(order.voucherDiscount || 0).toLocaleString('vi-VN')} VNƒê</small>` : ''}
                                                </td>
                                                <td style="padding: 10px; text-align: right; font-weight: 600; color: #2e7d32;">
                                                    ${order.voucherDiscount ? `-${(order.voucherDiscount || 0).toLocaleString('vi-VN')} VNƒê` : '0 VNƒê'}
                                                </td>
                                            </tr>
                                            ` : ''}
                                            <tr style="background: #667eea; color: white;">
                                                <td colspan="3" style="padding: 15px; text-align: right; font-weight: 700; font-size: 16px;">T·ªïng ti·ªÅn:</td>
                                                <td style="padding: 15px; text-align: right; font-weight: 700; font-size: 18px;">
                                                    ${(order.total || 0).toLocaleString('vi-VN')} VNƒê
                                                </td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>

                                ${order.notes ? `
                                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ffc107;">
                                    <h3 style="margin: 0 0 10px 0; color: #856404;">üìù Ghi ch√∫</h3>
                                    <p style="margin: 0; color: #856404;">${order.notes}</p>
                                </div>
                                ` : ''}

                                ${order.status === 'returning' ? `
                                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 5px; border-left: 4px solid #ff9800;">
                                    <h3 style="margin: 0 0 15px 0; color: #e65100;">üîÑ Y√™u c·∫ßu ho√†n h√†ng ƒë·ªÉ ƒë·ªïi</h3>
                                    <p style="margin: 5px 0;"><strong>L√Ω do:</strong> ${order.returnReason || 'N/A'}</p>
                                    ${order.returnRequestedAt ? `<p style="margin: 5px 0;"><strong>Th·ªùi gian y√™u c·∫ßu:</strong> ${new Date(order.returnRequestedAt).toLocaleString('vi-VN')}</p>` : ''}
                                    ${order.returnItems && order.returnItems.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <strong>S·∫£n ph·∫©m c·∫ßn ho√†n:</strong>
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                ${order.returnItems.map(item => `<li>${item.product?.name || 'N/A'} - S·ªë l∆∞·ª£ng: ${item.quantity}${item.reason ? ` (L√Ω do: ${item.reason})` : ''}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${order.exchangeItems && order.exchangeItems.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <strong>S·∫£n ph·∫©m mu·ªën ƒë·ªïi:</strong>
                                            <ul style="margin: 5px 0; padding-left: 20px;">
                                                ${order.exchangeItems.map(item => `<li>${item.oldProduct?.name || 'N/A'} ‚Üí ${item.newProduct?.name || 'N/A'} (S·ªë l∆∞·ª£ng: ${item.quantity})</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                                        <button class="btn btn-success" onclick="processReturnOrder('${id}', 'accept')">‚úÖ Ch·∫•p nh·∫≠n</button>
                                        <button class="btn btn-danger" onclick="processReturnOrder('${id}', 'reject')">‚ùå T·ª´ ch·ªëi</button>
                                    </div>
                                </div>
                                ` : ''}

                                ${order.status === 'exchanging' ? `
                                <div style="margin-bottom: 20px; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
                                    <h3 style="margin: 0 0 15px 0; color: #1565c0;">üîÑ ƒêang x·ª≠ l√Ω ƒë·ªïi h√†ng</h3>
                                    ${order.returnProcessedAt ? `<p style="margin: 5px 0;"><strong>Th·ªùi gian x·ª≠ l√Ω:</strong> ${new Date(order.returnProcessedAt).toLocaleString('vi-VN')}</p>` : ''}
                                    ${order.returnProcessedBy ? `<p style="margin: 5px 0;"><strong>Ng∆∞·ªùi x·ª≠ l√Ω:</strong> ${order.returnProcessedBy?.fullName || 'N/A'}</p>` : ''}
                                </div>
                                ` : ''}
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; padding-top: 20px; border-top: 1px solid #dee2e6;">
                                <button class="btn btn-secondary" onclick="closeOrderDetailModal()">ƒê√≥ng</button>
                                ${order.status !== 'completed' && order.status !== 'cancelled' && order.status !== 'returning' && order.status !== 'exchanging' ? 
                                    `<button class="btn btn-primary" onclick="closeOrderDetailModal(); updateOrderStatus('${id}')">C·∫≠p nh·∫≠t tr·∫°ng th√°i</button>` : ''}
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);

                    // ƒê√≥ng modal khi click b√™n ngo√†i
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            closeOrderDetailModal();
                        }
                    });
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng!');
                }
            } catch (error) {
                console.error('View order error:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng!');
            }
        }

        function closeOrderDetailModal() {
            const modal = document.getElementById('orderDetailModal');
            if (modal) {
                modal.remove();
            }
        }

        async function processReturnOrder(orderId, action) {
            // action: 'accept' ho·∫∑c 'reject'
            if (!confirm(action === 'accept' 
                ? 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ch·∫•p nh·∫≠n y√™u c·∫ßu ho√†n h√†ng n√†y?' 
                : 'B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën t·ª´ ch·ªëi y√™u c·∫ßu ho√†n h√†ng n√†y?')) {
                return;
            }

            const note = prompt('Nh·∫≠p ghi ch√∫ (t√πy ch·ªçn):');
            if (note === null) return; // User ƒë√£ h·ªßy

            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}/return-status`, {
                    method: 'PUT',
                    headers: {
                        ...getAuthHeaders(),
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        note: note || ''
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    alert(data.message || 'X·ª≠ l√Ω y√™u c·∫ßu ho√†n h√†ng th√†nh c√¥ng!');
                    closeOrderDetailModal();
                    loadOrders(); // Reload danh s√°ch ƒë∆°n h√†ng
                } else {
                    alert(data.message || 'L·ªói x·ª≠ l√Ω y√™u c·∫ßu ho√†n h√†ng!');
                }
            } catch (error) {
                console.error('Process return order error:', error);
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        async function viewProduct(id) {
            try {
                const response = await fetch(`${API_BASE}/products/${id}`, {
                    headers: getAuthHeaders()
                });
                const product = await response.json();

                if (response.ok) {
                    alert(`Chi ti·∫øt s·∫£n ph·∫©m:\n\n` +
                        `T√™n: ${product.name}\n` +
                        `Danh m·ª•c: ${product.category?.name || 'N/A'}\n` +
                        `Gi√° nh·∫≠p: ${product.importPrice?.toLocaleString('vi-VN')} VNƒê\n` +
                        `Gi√° b√°n: ${product.price?.toLocaleString('vi-VN')} VNƒê\n` +
                        `T·ªìn kho: ${product.stock || 0}\n` +
                        `T·ªìn kho t·ªëi thi·ªÉu: ${product.minStock || 0}\n` +
                        `ƒê√°nh gi√°: ${product.rating || 0}/5 (${product.totalReviews || 0} ƒë√°nh gi√°)\n` +
                        `Tr·∫°ng th√°i: ${product.status === 1 ? 'Ho·∫°t ƒë·ªông' : '·∫®n'}\n` +
                        `M√¥ t·∫£: ${product.description || 'N/A'}`);
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m!');
                }
            } catch (error) {
                alert('L·ªói t·∫£i d·ªØ li·ªáu s·∫£n ph·∫©m!');
            }
        }

        async function viewCustomer(id) {
            try {
                const response = await fetch(`${API_BASE}/users/${id}`, {
                    headers: getAuthHeaders()
                });
                const customer = await response.json();

                if (response.ok) {
                    // Get customer orders
                    const ordersResponse = await fetch(`${API_BASE}/users/${id}/orders`, {
                        headers: getAuthHeaders()
                    });
                    const orders = await ordersResponse.ok ? await ordersResponse.json() : [];

                    const totalSpent = orders.reduce((sum, order) => sum + (order.total || 0), 0);

                    const customerId = customer._id || customer.id || id;
                    const detailText = `Chi ti·∫øt kh√°ch h√†ng:\n\n` +
                        `ID: ${customerId}\n` +
                        `T√™n: ${customer.fullName || 'N/A'}\n` +
                        `Email: ${customer.email || 'N/A'}\n` +
                        `SƒêT: ${customer.phone || 'N/A'}\n` +
                        `Ng√†y t·∫°o: ${new Date(customer.createdAt).toLocaleDateString('vi-VN')}\n` +
                        `T·ªïng ƒë∆°n h√†ng: ${orders.length}\n` +
                        `T·ªïng ti·ªÅn ƒë√£ mua: ${totalSpent.toLocaleString('vi-VN')} VNƒê\n\n` +
                        `üí° Click n√∫t b√™n d∆∞·ªõi ƒë·ªÉ copy ID v√†o clipboard!`;
                    
                    if (confirm(detailText + '\n\nB·∫°n c√≥ mu·ªën copy ID n√†y kh√¥ng?')) {
                        copyToClipboard(customerId, '‚úÖ ID kh√°ch h√†ng ƒë√£ ƒë∆∞·ª£c copy! B·∫°n c√≥ th·ªÉ paste v√†o form voucher.');
                    }
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng!');
                }
            } catch (error) {
                alert('L·ªói t·∫£i d·ªØ li·ªáu kh√°ch h√†ng!');
            }
        }

        // Voucher Management
        async function loadVouchers(page = 1) {
            const search = document.getElementById('voucherSearch')?.value || '';
            const status = document.getElementById('voucherStatusFilter')?.value || '';
            const params = new URLSearchParams({ page, limit: 10 });
            if (status) params.append('status', status);

            try {
                const url = `${API_BASE}/vouchers?${params}`;
                const headers = getAuthHeaders();
                
                console.log('üîç Loading vouchers:', url);
                console.log('üîë Headers:', headers);
                
                const response = await fetch(url, { headers });
                const data = await response.json();

                console.log('üì¶ Response status:', response.status);
                console.log('üì¶ Response data:', data);

                if (response.ok) {
                    // Ki·ªÉm tra format response (h·ªó tr·ª£ c·∫£ format c≈© v√† m·ªõi)
                    let vouchers = [];
                    if (data.data && Array.isArray(data.data)) {
                        // Format m·ªõi: { success: true, data: [...] }
                        vouchers = data.data;
                    } else if (data.vouchers && Array.isArray(data.vouchers)) {
                        // Format c≈©: { vouchers: [...] }
                        vouchers = data.vouchers;
                    } else if (Array.isArray(data)) {
                        // Format array tr·ª±c ti·∫øp
                        vouchers = data;
                    }
                    
                    if (vouchers.length > 0) {
                        console.log('‚úÖ Found vouchers:', vouchers.length);
                        renderVouchersTable(vouchers);
                        // Ph√¢n trang (n·∫øu c√≥)
                        if (data.totalPages) {
                            renderPagination('vouchersPagination', data.page || 1, data.totalPages, (p) => {
                                currentPage.vouchers = p;
                                loadVouchers(p);
                            });
                        } else {
                            document.getElementById('vouchersPagination').innerHTML = '';
                        }
                    } else {
                        console.log('‚ö†Ô∏è No vouchers found');
                        document.getElementById('vouchersTable').innerHTML = '<div style="padding: 40px; text-align: center; color: #64748b;">Kh√¥ng c√≥ voucher n√†o! <br><button class="btn btn-primary" onclick="showAddVoucher()" style="margin-top: 10px;">Th√™m voucher ƒë·∫ßu ti√™n</button></div>';
                        document.getElementById('vouchersPagination').innerHTML = '';
                    }
                } else {
                    console.error('‚ùå API Error:', data);
                    document.getElementById('vouchersTable').innerHTML = `<div style="padding: 40px; text-align: center; color: #e74c3c;">L·ªói: ${data.message || 'Kh√¥ng th·ªÉ t·∫£i danh s√°ch voucher'}</div>`;
                }
            } catch (error) {
                console.error('‚ùå Network Error:', error);
                document.getElementById('vouchersTable').innerHTML = '<div style="padding: 40px; text-align: center; color: #e74c3c;">L·ªói k·∫øt n·ªëi server! Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt.</div>';
            }
        }

        function renderVouchersTable(vouchers) {
            const table = `
                <table>
                    <thead>
                        <tr>
                            <th>M√£ voucher</th>
                            <th>T√™n</th>
                            <th>Lo·∫°i</th>
                            <th>Gi√° tr·ªã</th>
                            <th>S·ªë l∆∞·ª£ng</th>
                            <th>ƒê√£ d√πng</th>
                            <th>Ng∆∞·ªùi d√πng √°p d·ª•ng</th>
                            <th>Ng√†y b·∫Øt ƒë·∫ßu</th>
                            <th>Ng√†y k·∫øt th√∫c</th>
                            <th>Tr·∫°ng th√°i</th>
                            <th>Thao t√°c</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${vouchers.map(voucher => {
                            // H·ªó tr·ª£ c·∫£ format c≈© v√† m·ªõi
                            const code = voucher.code || '';
                            const name = voucher.name || '';
                            const type = voucher.type || voucher.discountType || 'percentage';
                            const value = voucher.value || voucher.discount || 0;
                            const quantity = voucher.quantity || 0;
                            const usedCount = voucher.usedCount || voucher.used || 0;
                            const startDate = voucher.startDate ? new Date(voucher.startDate) : new Date();
                            const endDate = voucher.endDate ? new Date(voucher.endDate) : new Date();
                            const status = voucher.status; // C√≥ th·ªÉ l√† 0/1 ho·∫∑c "active"/"inactive"/"expired"
                            const id = voucher._id || voucher.id || '';
                            
                            // X√°c ƒë·ªãnh ng∆∞·ªùi d√πng √°p d·ª•ng
                            const applicableUsers = voucher.applicableUsers || [];
                            console.log(`üîç Rendering voucher ${voucher.code || voucher._id} - applicableUsers:`, applicableUsers);
                            console.log(`üîç Rendering voucher ${voucher.code || voucher._id} - applicableUsers length:`, applicableUsers.length);
                            console.log(`üîç Rendering voucher ${voucher.code || voucher._id} - applicableUsers type:`, typeof applicableUsers, Array.isArray(applicableUsers));
                            
                            let usersText = 'T·∫•t c·∫£';
                            if (applicableUsers.length > 0) {
                                if (applicableUsers.length === 1) {
                                    const userId = typeof applicableUsers[0] === 'object' ? applicableUsers[0]._id || applicableUsers[0].id : applicableUsers[0];
                                    usersText = `1 user (${String(userId).substring(0, 8)}...)`;
                                } else {
                                    usersText = `${applicableUsers.length} users`;
                                }
                            }
                            
                            // X√°c ƒë·ªãnh tr·∫°ng th√°i hi·ªÉn th·ªã
                            let statusClass = 'status-cancelled';
                            let statusText = 'Kh√¥ng h·ª£p l·ªá';
                            const now = new Date();
                            
                            if (typeof status === 'string') {
                                // Format m·ªõi: "active", "inactive", "expired"
                                // Nh∆∞ng c·∫ßn ki·ªÉm tra th√™m c√°c ƒëi·ªÅu ki·ªán th·ª±c t·∫ø
                                if (status === 'inactive' || status === 0) {
                                    // N·∫øu status = 0 ho·∫∑c "inactive" ‚Üí D·ª´ng ho·∫°t ƒë·ªông (do admin t·∫Øt)
                                    statusClass = 'status-cancelled';
                                    statusText = 'D·ª´ng ho·∫°t ƒë·ªông';
                                } else if (status === 'expired' || usedCount >= quantity || endDate < now || startDate > now) {
                                    // H·∫øt h·∫°n do: ƒë√£ d√πng h·∫øt, qu√° h·∫°n, ho·∫∑c ch∆∞a ƒë·∫øn th·ªùi gian
                                    statusClass = 'status-cancelled';
                                    if (usedCount >= quantity) {
                                        statusText = 'H·∫øt h·∫°n (ƒë√£ d√πng h·∫øt)';
                                    } else if (endDate < now) {
                                        statusText = 'H·∫øt h·∫°n (qu√° th·ªùi gian)';
                                    } else if (startDate > now) {
                                        statusText = 'Ch∆∞a c√≥ hi·ªáu l·ª±c';
                                    } else {
                                        statusText = 'H·∫øt h·∫°n';
                                    }
                                } else if (status === 'active' || status === 1) {
                                    // Ho·∫°t ƒë·ªông b√¨nh th∆∞·ªùng
                                    statusClass = 'status-completed';
                                    statusText = 'Ho·∫°t ƒë·ªông';
                                }
                            } else {
                                // Format c≈©: 0 ho·∫∑c 1 (number)
                                if (status === 0) {
                                    // Admin ƒë√£ t·∫Øt voucher
                                    statusClass = 'status-cancelled';
                                    statusText = 'D·ª´ng ho·∫°t ƒë·ªông';
                                } else if (status === 1) {
                                    // Ki·ªÉm tra c√°c ƒëi·ªÅu ki·ªán
                                    if (usedCount >= quantity) {
                                    statusClass = 'status-cancelled';
                                        statusText = 'H·∫øt h·∫°n (ƒë√£ d√πng h·∫øt)';
                                    } else if (endDate < now) {
                                        statusClass = 'status-cancelled';
                                        statusText = 'H·∫øt h·∫°n (qu√° th·ªùi gian)';
                                    } else if (startDate > now) {
                                        statusClass = 'status-cancelled';
                                        statusText = 'Ch∆∞a c√≥ hi·ªáu l·ª±c';
                                    } else {
                                        statusClass = 'status-completed';
                                        statusText = 'Ho·∫°t ƒë·ªông';
                                }
                            } else {
                                    statusClass = 'status-cancelled';
                                    statusText = 'Kh√¥ng h·ª£p l·ªá';
                                }
                            }
                            
                            return `
                            <tr>
                                <td><strong>${code}</strong></td>
                                <td>${name}</td>
                                <td>${type === 'percentage' ? 'Ph·∫ßn trƒÉm' : 'C·ªë ƒë·ªãnh'}</td>
                                <td>${type === 'percentage' ? value + '%' : value.toLocaleString('vi-VN') + ' VNƒê'}</td>
                                <td>${quantity}</td>
                                <td>${usedCount}</td>
                                <td><span title="${applicableUsers.length > 0 ? 'Ch·ªâ √°p d·ª•ng cho ' + applicableUsers.length + ' user(s)' : '√Åp d·ª•ng cho t·∫•t c·∫£ user'}" style="cursor: help;">${usersText}</span></td>
                                <td>${startDate.toLocaleDateString('vi-VN')}</td>
                                <td>${endDate.toLocaleDateString('vi-VN')}</td>
                                <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                                <td>
                                    <button class="btn-sm btn-view" onclick="viewVoucher('${id}')">Xem</button>
                                    <button class="btn-sm btn-edit" onclick="editVoucher('${id}')">S·ª≠a</button>
                                    <button class="btn-sm btn-delete" onclick="deleteVoucher('${id}')">X√≥a</button>
                                </td>
                            </tr>
                        `;
                        }).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('vouchersTable').innerHTML = table;
        }

        function showAddVoucher() {
            document.getElementById('voucherId').value = '';
            document.getElementById('voucherForm').reset();
            document.getElementById('voucherModalTitle').textContent = 'Th√™m voucher';
            document.getElementById('voucherModal').classList.add('active');
            toggleVoucherFields();
        }

        function toggleVoucherFields() {
            const type = document.getElementById('voucherType')?.value;
            const maxDiscountGroup = document.getElementById('maxDiscountGroup');
            if (type === 'percentage' && maxDiscountGroup) {
                maxDiscountGroup.style.display = 'block';
            } else if (maxDiscountGroup) {
                maxDiscountGroup.style.display = 'none';
            }
        }

        async function editVoucher(id) {
            try {
                const response = await fetch(`${API_BASE}/vouchers/${id}`, {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                
                // H·ªó tr·ª£ c·∫£ format m·ªõi v√† c≈©
                const voucher = result.data || result;

                document.getElementById('voucherId').value = voucher._id || id;
                document.getElementById('voucherCode').value = voucher.code || '';
                document.getElementById('voucherName').value = voucher.name || '';
                document.getElementById('voucherDescription').value = voucher.description || '';
                document.getElementById('voucherType').value = voucher.type || voucher.discountType || 'percentage';
                document.getElementById('voucherValue').value = voucher.value || voucher.discount || '';
                document.getElementById('voucherMaxDiscount').value = voucher.maxDiscount || '';
                document.getElementById('voucherMinOrderValue').value = voucher.minOrderValue || voucher.minOrderAmount || 0;
                document.getElementById('voucherQuantity').value = voucher.quantity || '';
                document.getElementById('voucherUsedCount').value = voucher.usedCount || voucher.used || 0;
                
                // X·ª≠ l√Ω status (c√≥ th·ªÉ l√† 0/1 ho·∫∑c "active"/"inactive")
                let statusValue = 1;
                if (voucher.status !== undefined) {
                    if (typeof voucher.status === 'string') {
                        statusValue = voucher.status === 'active' ? 1 : 0;
                    } else {
                        statusValue = voucher.status;
                    }
                }
                document.getElementById('voucherStatus').value = statusValue;
                
                const startDate = voucher.startDate ? new Date(voucher.startDate) : new Date();
                const endDate = voucher.endDate ? new Date(voucher.endDate) : new Date();
                document.getElementById('voucherStartDate').value = startDate.toISOString().slice(0, 16);
                document.getElementById('voucherEndDate').value = endDate.toISOString().slice(0, 16);
                
                document.getElementById('voucherProducts').value = voucher.applicableProducts?.map(p => p._id || p).join(', ') || '';
                document.getElementById('voucherCategories').value = voucher.applicableCategories?.map(c => c._id || c).join(', ') || '';
                document.getElementById('voucherUsers').value = voucher.applicableUsers?.map(u => u._id || u).join(', ') || '';

                document.getElementById('voucherModalTitle').textContent = 'S·ª≠a voucher';
                document.getElementById('voucherModal').classList.add('active');
                toggleVoucherFields();
            } catch (error) {
                console.error('Error loading voucher:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu voucher!');
            }
        }

        document.getElementById('voucherForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // X√≥a th√¥ng b√°o l·ªói c≈©
            const errorElement = document.getElementById('voucherError');
            if (errorElement) {
                errorElement.textContent = '';
                errorElement.style.display = 'none';
            }
            
            const id = document.getElementById('voucherId').value;
            
            const parseIds = (str) => {
                if (!str || !str.trim()) return [];
                return str.split(',').map(s => s.trim()).filter(s => s);
            };

            const quantity = parseInt(document.getElementById('voucherQuantity').value);
            const usedCount = parseInt(document.getElementById('voucherUsedCount').value) || 0;
            
            // Validation: usedCount kh√¥ng ƒë∆∞·ª£c l·ªõn h∆°n quantity
            if (usedCount > quantity) {
                if (errorElement) {
                    errorElement.textContent = `S·ªë ƒë√£ d√πng (${usedCount}) kh√¥ng th·ªÉ l·ªõn h∆°n s·ªë l∆∞·ª£ng (${quantity})!`;
                    errorElement.style.display = 'block';
                } else {
                    alert(`L·ªói: S·ªë ƒë√£ d√πng (${usedCount}) kh√¥ng th·ªÉ l·ªõn h∆°n s·ªë l∆∞·ª£ng (${quantity})!`);
                }
                return;
            }
            
            if (usedCount < 0) {
                if (errorElement) {
                    errorElement.textContent = 'S·ªë ƒë√£ d√πng kh√¥ng th·ªÉ nh·ªè h∆°n 0!';
                    errorElement.style.display = 'block';
                } else {
                    alert('L·ªói: S·ªë ƒë√£ d√πng kh√¥ng th·ªÉ nh·ªè h∆°n 0!');
                }
                return;
            }

            // L·∫•y v√† parse applicableUsers
            const voucherUsersInput = document.getElementById('voucherUsers').value;
            const applicableUsers = parseIds(voucherUsersInput);
            
            // Debug logging
            console.log('üîç Voucher Users Input:', voucherUsersInput);
            console.log('üîç Parsed Applicable Users:', applicableUsers);
            console.log('üîç Applicable Users Length:', applicableUsers.length);
            
            // C·∫£nh b√°o n·∫øu c√≥ ch·ªçn user nh∆∞ng parse ra m·∫£ng r·ªóng
            if (voucherUsersInput && voucherUsersInput.trim() && applicableUsers.length === 0) {
                alert('‚ö†Ô∏è C·∫£nh b√°o: B·∫°n ƒë√£ nh·∫≠p ID ng∆∞·ªùi d√πng nh∆∞ng kh√¥ng h·ª£p l·ªá. Voucher s·∫Ω √°p d·ª•ng cho T·∫§T C·∫¢ user!\n\nVui l√≤ng ki·ªÉm tra l·∫°i ID ho·∫∑c s·ª≠ d·ª•ng n√∫t "Ch·ªçn t·ª´ danh s√°ch" ƒë·ªÉ ch·ªçn kh√°ch h√†ng.');
            }
            
            // Th√¥ng b√°o s·ªë l∆∞·ª£ng user ƒë∆∞·ª£c ch·ªçn
            if (applicableUsers.length > 0) {
                console.log(`‚úÖ Voucher s·∫Ω ch·ªâ √°p d·ª•ng cho ${applicableUsers.length} user(s):`, applicableUsers);
            } else {
                console.log('‚ÑπÔ∏è Voucher s·∫Ω √°p d·ª•ng cho T·∫§T C·∫¢ user (applicableUsers r·ªóng)');
            }

            const data = {
                code: document.getElementById('voucherCode').value.toUpperCase(),
                name: document.getElementById('voucherName').value,
                description: document.getElementById('voucherDescription').value,
                type: document.getElementById('voucherType').value,
                value: parseFloat(document.getElementById('voucherValue').value),
                minOrderValue: parseFloat(document.getElementById('voucherMinOrderValue').value) || 0,
                quantity: quantity,
                usedCount: usedCount,
                startDate: document.getElementById('voucherStartDate').value,
                endDate: document.getElementById('voucherEndDate').value,
                status: parseInt(document.getElementById('voucherStatus').value),
                applicableProducts: parseIds(document.getElementById('voucherProducts').value),
                applicableCategories: parseIds(document.getElementById('voucherCategories').value),
                applicableUsers: applicableUsers // S·ª≠ d·ª•ng bi·∫øn ƒë√£ parse
            };

            if (data.type === 'percentage' && document.getElementById('voucherMaxDiscount').value) {
                data.maxDiscount = parseFloat(document.getElementById('voucherMaxDiscount').value);
            }

            console.log('üíæ Saving voucher:', { id, data });
            console.log('üíæ ApplicableUsers trong data:', data.applicableUsers);
            console.log('üíæ ApplicableUsers type:', typeof data.applicableUsers, Array.isArray(data.applicableUsers));
            console.log('üíæ ApplicableUsers length:', data.applicableUsers?.length);
            
            try {
                // Ki·ªÉm tra token tr∆∞·ªõc khi g·ª≠i request
                if (!currentToken) {
                    alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                    logout();
                    return;
                }

                const url = id ? `${API_BASE}/vouchers/${id}` : `${API_BASE}/vouchers`;
                const method = id ? 'PUT' : 'POST';
                
                console.log('üì§ Sending request:', { url, method });
                console.log('üì§ Request body applicableUsers:', JSON.stringify(data.applicableUsers));
                
                const response = await fetch(url, {
                    method,
                    headers: getAuthHeaders(),
                    body: JSON.stringify(data)
                });

                console.log('üì• Response status:', response.status);

                let result;
                try {
                    result = await response.json();
                    console.log('üì¶ Response data:', result);
                    console.log('üì¶ Response applicableUsers:', result.data?.applicableUsers);
                    console.log('üì¶ Response applicableUsers length:', result.data?.applicableUsers?.length);
                } catch (jsonError) {
                    console.error('‚ùå JSON parse error:', jsonError);
                    const text = await response.text();
                    console.error('üìÑ Response text:', text);
                    if (errorElement) {
                        errorElement.textContent = 'L·ªói: Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!';
                        errorElement.style.display = 'block';
                    } else {
                        alert('L·ªói: Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!');
                    }
                    return;
                }

                if (response.ok) {
                    // H·ªó tr·ª£ c·∫£ format m·ªõi v√† c≈©
                    let message = result.message || result.success?.message || (result.success ? 'L∆∞u th√†nh c√¥ng!' : 'C√≥ l·ªói x·∫£y ra!');
                    
                    // Th√™m th√¥ng b√°o chi ti·∫øt n·∫øu ƒëang kh√¥i ph·ª•c voucher
                    const status = parseInt(document.getElementById('voucherStatus').value);
                    const oldUsedCount = result.data?.used || 0;
                    const newUsedCount = parseInt(document.getElementById('voucherUsedCount').value) || 0;
                    const quantity = parseInt(document.getElementById('voucherQuantity').value);
                    
                    if (status === 1 && id) {
                        // ƒêang s·ª≠a voucher v√† chuy·ªÉn v·ªÅ "Ho·∫°t ƒë·ªông"
                        if (newUsedCount < oldUsedCount) {
                            message += '\n\n‚úÖ Voucher ƒë√£ ƒë∆∞·ª£c kh√¥i ph·ª•c! S·ªë ƒë√£ d√πng ƒë√£ ƒë∆∞·ª£c reset.';
                        } else if (quantity > newUsedCount) {
                            message += '\n\n‚úÖ Voucher ƒë√£ ƒë∆∞·ª£c k√≠ch ho·∫°t l·∫°i v√† c√≥ th·ªÉ s·ª≠ d·ª•ng ngay!';
                        }
                    } else if (status === 0 && id) {
                        // ƒêang t·∫Øt voucher
                        message += '\n\n‚ö†Ô∏è Voucher ƒë√£ b·ªã d·ª´ng ho·∫°t ƒë·ªông. Kh√°ch h√†ng kh√¥ng th·ªÉ s·ª≠ d·ª•ng.';
                    }
                    
                    alert(message);
                    closeModal('voucherModal');
                    loadVouchers(currentPage.vouchers || 1);
                } else {
                    // Ki·ªÉm tra n·∫øu l·ªói do token
                    if (response.status === 401 || response.status === 403) {
                        if (result.message && (result.message.includes('Token') || result.message.includes('ƒëƒÉng nh·∫≠p') || result.message.includes('Ch∆∞a ƒëƒÉng nh·∫≠p'))) {
                            alert('Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n! Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
                            logout();
                            return;
                        }
                    }
                    // H·ªó tr·ª£ c·∫£ format m·ªõi v√† c≈©
                    const errorMsg = result.message || (result.success === false ? result.message : 'C√≥ l·ªói x·∫£y ra!');
                    if (errorElement) {
                        errorElement.textContent = errorMsg;
                        errorElement.style.display = 'block';
                    } else {
                        alert(errorMsg);
                    }
                    console.error('‚ùå Error saving voucher:', result);
                }
            } catch (error) {
                console.error('‚ùå Network error:', error);
                if (errorElement) {
                    errorElement.textContent = 'L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.';
                    errorElement.style.display = 'block';
                } else {
                    alert('L·ªói k·∫øt n·ªëi server! Vui l√≤ng th·ª≠ l·∫°i.');
                }
            }
        });

        async function deleteVoucher(id) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a voucher n√†y?')) return;

            try {
                const response = await fetch(`${API_BASE}/vouchers/${id}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });

                if (response.ok) {
                    alert('X√≥a th√†nh c√¥ng!');
                    loadVouchers(currentPage.vouchers);
                } else {
                    const data = await response.json();
                    alert(data.message || 'C√≥ l·ªói x·∫£y ra!');
                }
            } catch (error) {
                alert('L·ªói k·∫øt n·ªëi server!');
            }
        }

        async function viewVoucher(id) {
            try {
                const response = await fetch(`${API_BASE}/vouchers/${id}`, {
                    headers: getAuthHeaders()
                });
                const result = await response.json();
                
                // H·ªó tr·ª£ c·∫£ format m·ªõi v√† c≈©
                const voucher = result.data || result;
                
                console.log('üëÅÔ∏è ViewVoucher - Full response:', result);
                console.log('üëÅÔ∏è ViewVoucher - Voucher data:', voucher);
                console.log('üëÅÔ∏è ViewVoucher - applicableUsers:', voucher.applicableUsers);
                console.log('üëÅÔ∏è ViewVoucher - applicableUsers type:', typeof voucher.applicableUsers, Array.isArray(voucher.applicableUsers));
                console.log('üëÅÔ∏è ViewVoucher - applicableUsers length:', voucher.applicableUsers?.length);

                if (response.ok && voucher) {
                    const type = voucher.type || voucher.discountType || 'percentage';
                    const value = voucher.value || voucher.discount || 0;
                    const quantity = voucher.quantity || 0;
                    const usedCount = voucher.usedCount || voucher.used || 0;
                    const minOrderValue = voucher.minOrderValue || voucher.minOrderAmount || 0;
                    const startDate = voucher.startDate ? new Date(voucher.startDate) : new Date();
                    const endDate = voucher.endDate ? new Date(voucher.endDate) : new Date();
                    
                    const now = new Date();
                    let statusText = 'Kh√¥ng h·ª£p l·ªá';
                    if (typeof voucher.status === 'string') {
                        statusText = voucher.status === 'active' ? 'Ho·∫°t ƒë·ªông' : 
                                   voucher.status === 'inactive' ? 'D·ª´ng ho·∫°t ƒë·ªông' : 'H·∫øt h·∫°n';
                    } else {
                        const isValid = voucher.status === 1 && 
                                      quantity > usedCount &&
                                      startDate <= now &&
                                      endDate >= now;
                        statusText = isValid ? 'H·ª£p l·ªá' : 'Kh√¥ng h·ª£p l·ªá';
                    }

                    // X√°c ƒë·ªãnh ng∆∞·ªùi d√πng √°p d·ª•ng
                    const applicableUsers = voucher.applicableUsers || [];
                    console.log('üëÅÔ∏è ViewVoucher - Processing applicableUsers:', applicableUsers);
                    console.log('üëÅÔ∏è ViewVoucher - applicableUsers length after || []:', applicableUsers.length);
                    
                    let usersInfo = 'T·∫•t c·∫£ user';
                    if (applicableUsers.length > 0) {
                        const userIds = applicableUsers.map(u => {
                            if (typeof u === 'object') return u._id || u.id || u;
                            return u;
                        });
                        usersInfo = `${applicableUsers.length} user(s): ${userIds.join(', ')}`;
                        console.log('üëÅÔ∏è ViewVoucher - usersInfo:', usersInfo);
                    } else {
                        console.log('üëÅÔ∏è ViewVoucher - applicableUsers is empty, showing "T·∫•t c·∫£ user"');
                    }

                    alert(`Chi ti·∫øt voucher:\n\n` +
                        `M√£: ${voucher.code || 'N/A'}\n` +
                        `T√™n: ${voucher.name || 'N/A'}\n` +
                        `M√¥ t·∫£: ${voucher.description || 'N/A'}\n` +
                        `Lo·∫°i: ${type === 'percentage' ? 'Ph·∫ßn trƒÉm' : 'C·ªë ƒë·ªãnh'}\n` +
                        `Gi√° tr·ªã: ${type === 'percentage' ? value + '%' : value.toLocaleString('vi-VN') + ' VNƒê'}\n` +
                        `Gi·∫£m t·ªëi ƒëa: ${voucher.maxDiscount ? voucher.maxDiscount.toLocaleString('vi-VN') + ' VNƒê' : 'Kh√¥ng gi·ªõi h·∫°n'}\n` +
                        `ƒê∆°n h√†ng t·ªëi thi·ªÉu: ${minOrderValue.toLocaleString('vi-VN')} VNƒê\n` +
                        `S·ªë l∆∞·ª£ng: ${quantity}\n` +
                        `ƒê√£ d√πng: ${usedCount}\n` +
                        `C√≤n l·∫°i: ${quantity - usedCount}\n` +
                        `Ng∆∞·ªùi d√πng √°p d·ª•ng: ${usersInfo}\n` +
                        `Ng√†y b·∫Øt ƒë·∫ßu: ${startDate.toLocaleString('vi-VN')}\n` +
                        `Ng√†y k·∫øt th√∫c: ${endDate.toLocaleString('vi-VN')}\n` +
                        `Tr·∫°ng th√°i: ${statusText}\n` +
                        `Hi·ªÉn th·ªã: ${(typeof voucher.status === 'string' ? voucher.status === 'active' : voucher.status === 1) ? 'C√≥' : 'Kh√¥ng'}`);
                } else {
                    alert('Kh√¥ng t√¨m th·∫•y voucher!');
                }
            } catch (error) {
                console.error('Error loading voucher:', error);
                alert('L·ªói t·∫£i d·ªØ li·ªáu voucher!');
            }
        }

        // API Management
        const apiEndpoints = [
            // Auth
            { method: 'POST', path: '/api/auth/login', description: 'ƒêƒÉng nh·∫≠p', auth: false },
            { method: 'POST', path: '/api/auth/register', description: 'ƒêƒÉng k√Ω t√†i kho·∫£n', auth: false },
            { method: 'POST', path: '/api/auth/logout', description: 'ƒêƒÉng xu·∫•t', auth: true },
            { method: 'PUT', path: '/api/auth/change-password', description: 'ƒê·ªïi m·∫≠t kh·∫©u', auth: true },
            { method: 'GET', path: '/api/auth/me', description: 'L·∫•y th√¥ng tin user hi·ªán t·∫°i', auth: true },
            { method: 'PUT', path: '/api/auth/me', description: 'C·∫≠p nh·∫≠t th√¥ng tin c√° nh√¢n', auth: true },
            
            // Users
            { method: 'GET', path: '/api/users', description: 'L·∫•y danh s√°ch nh√¢n vi√™n', auth: true, admin: true },
            { method: 'GET', path: '/api/users/:id', description: 'L·∫•y chi ti·∫øt nh√¢n vi√™n', auth: true, admin: true },
            { method: 'POST', path: '/api/users', description: 'Th√™m nh√¢n vi√™n m·ªõi', auth: true, admin: true },
            { method: 'PUT', path: '/api/users/:id', description: 'C·∫≠p nh·∫≠t nh√¢n vi√™n', auth: true, admin: true },
            { method: 'DELETE', path: '/api/users/:id', description: 'X√≥a nh√¢n vi√™n', auth: true, admin: true },
            { method: 'GET', path: '/api/users/:id/orders', description: 'L·∫•y l·ªãch s·ª≠ ƒë∆°n h√†ng c·ªßa user', auth: true },
            { method: 'GET', path: '/api/users/customers/list', description: 'L·∫•y danh s√°ch kh√°ch h√†ng', auth: true, admin: true },
            { method: 'PATCH', path: '/api/users/:id/ban', description: 'Kh√≥a/M·ªü kh√≥a t√†i kho·∫£n', auth: true, admin: true },
            
            // Categories
            { method: 'GET', path: '/api/categories', description: 'L·∫•y danh s√°ch lo·∫°i s·∫£n ph·∫©m', auth: false },
            { method: 'GET', path: '/api/categories/all', description: 'L·∫•y t·∫•t c·∫£ lo·∫°i s·∫£n ph·∫©m', auth: false },
            { method: 'GET', path: '/api/categories/:id', description: 'L·∫•y chi ti·∫øt lo·∫°i s·∫£n ph·∫©m', auth: false },
            { method: 'GET', path: '/api/categories/:id/products', description: 'L·∫•y s·∫£n ph·∫©m theo danh m·ª•c', auth: false },
            { method: 'POST', path: '/api/categories', description: 'Th√™m lo·∫°i s·∫£n ph·∫©m', auth: true },
            { method: 'PUT', path: '/api/categories/:id', description: 'C·∫≠p nh·∫≠t lo·∫°i s·∫£n ph·∫©m', auth: true },
            { method: 'DELETE', path: '/api/categories/:id', description: 'X√≥a lo·∫°i s·∫£n ph·∫©m', auth: true },
            
            // Products
            { method: 'GET', path: '/api/products', description: 'L·∫•y danh s√°ch s·∫£n ph·∫©m', auth: false },
            { method: 'GET', path: '/api/products/:id', description: 'L·∫•y chi ti·∫øt s·∫£n ph·∫©m', auth: false },
            { method: 'POST', path: '/api/products', description: 'Th√™m s·∫£n ph·∫©m m·ªõi', auth: true },
            { method: 'PUT', path: '/api/products/:id', description: 'C·∫≠p nh·∫≠t s·∫£n ph·∫©m', auth: true },
            { method: 'DELETE', path: '/api/products/:id', description: 'X√≥a/·∫®n s·∫£n ph·∫©m', auth: true },
            { method: 'GET', path: '/api/products/low-stock/all', description: 'L·∫•y s·∫£n ph·∫©m t·ªìn kho th·∫•p', auth: true },
            { method: 'GET', path: '/api/products/export/excel', description: 'Xu·∫•t Excel s·∫£n ph·∫©m', auth: true },
            
            // Cart
            { method: 'GET', path: '/api/cart', description: 'L·∫•y gi·ªè h√†ng', auth: true },
            { method: 'POST', path: '/api/cart', description: 'Th√™m v√†o gi·ªè h√†ng', auth: true },
            { method: 'PUT', path: '/api/cart/:id', description: 'C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng trong gi·ªè h√†ng', auth: true },
            { method: 'DELETE', path: '/api/cart/:id', description: 'X√≥a s·∫£n ph·∫©m kh·ªèi gi·ªè h√†ng', auth: true },
            { method: 'DELETE', path: '/api/cart', description: 'X√≥a to√†n b·ªô gi·ªè h√†ng', auth: true },
            
            // Orders
            { method: 'GET', path: '/api/orders', description: 'L·∫•y danh s√°ch ƒë∆°n h√†ng', auth: true },
            { method: 'GET', path: '/api/orders/:id', description: 'L·∫•y chi ti·∫øt ƒë∆°n h√†ng', auth: true },
            { method: 'GET', path: '/api/orders/:id/timeline', description: 'L·∫•y timeline ƒë∆°n h√†ng', auth: true },
            { method: 'POST', path: '/api/orders', description: 'T·∫°o ƒë∆°n h√†ng m·ªõi', auth: true },
            { method: 'PUT', path: '/api/orders/:id/status', description: 'C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng', auth: true },
            { method: 'PUT', path: '/api/orders/:id/cancel', description: 'H·ªßy ƒë∆°n h√†ng (kh√°ch h√†ng)', auth: true },
            
            // Addresses
            { method: 'GET', path: '/api/addresses', description: 'L·∫•y danh s√°ch ƒë·ªãa ch·ªâ', auth: true },
            { method: 'GET', path: '/api/addresses/default', description: 'L·∫•y ƒë·ªãa ch·ªâ m·∫∑c ƒë·ªãnh', auth: true },
            { method: 'POST', path: '/api/addresses', description: 'Th√™m ƒë·ªãa ch·ªâ m·ªõi', auth: true },
            { method: 'PUT', path: '/api/addresses/:id', description: 'C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ', auth: true },
            { method: 'DELETE', path: '/api/addresses/:id', description: 'X√≥a ƒë·ªãa ch·ªâ', auth: true },
            
            // Reviews
            { method: 'GET', path: '/api/reviews', description: 'L·∫•y t·∫•t c·∫£ ƒë√°nh gi√° (Admin)', auth: true, admin: true },
            { method: 'GET', path: '/api/reviews/product/:productId', description: 'L·∫•y ƒë√°nh gi√° c·ªßa s·∫£n ph·∫©m', auth: false },
            { method: 'GET', path: '/api/reviews/my', description: 'L·∫•y ƒë√°nh gi√° c·ªßa t√¥i', auth: true },
            { method: 'POST', path: '/api/reviews', description: 'Th√™m ƒë√°nh gi√°', auth: true },
            { method: 'PUT', path: '/api/reviews/:id', description: 'C·∫≠p nh·∫≠t ƒë√°nh gi√°', auth: true },
            { method: 'DELETE', path: '/api/reviews/:id', description: 'X√≥a ƒë√°nh gi√° (Customer)', auth: true },
            { method: 'DELETE', path: '/api/reviews/admin/:id', description: 'X√≥a ƒë√°nh gi√° (Admin)', auth: true, admin: true },
            { method: 'PUT', path: '/api/reviews/admin/:id/toggle-visibility', description: '·∫®n/Hi·ªán ƒë√°nh gi√° (Admin)', auth: true, admin: true },
            
            // Favorites
            { method: 'GET', path: '/api/favorites', description: 'L·∫•y danh s√°ch y√™u th√≠ch', auth: true },
            { method: 'GET', path: '/api/favorites/check/:productId', description: 'Ki·ªÉm tra s·∫£n ph·∫©m ƒë√£ y√™u th√≠ch', auth: true },
            { method: 'POST', path: '/api/favorites/:productId', description: 'Th√™m v√†o y√™u th√≠ch', auth: true },
            { method: 'DELETE', path: '/api/favorites/:productId', description: 'X√≥a kh·ªèi y√™u th√≠ch', auth: true },
            
            // Notifications
            { method: 'GET', path: '/api/notifications', description: 'L·∫•y danh s√°ch th√¥ng b√°o', auth: true },
            { method: 'PUT', path: '/api/notifications/:id/read', description: 'ƒê√°nh d·∫•u ƒë√£ ƒë·ªçc', auth: true },
            { method: 'PUT', path: '/api/notifications/read-all', description: 'ƒê√°nh d·∫•u t·∫•t c·∫£ ƒë√£ ƒë·ªçc', auth: true },
            { method: 'DELETE', path: '/api/notifications/:id', description: 'X√≥a th√¥ng b√°o', auth: true },
            
            // Support
            { method: 'GET', path: '/api/support', description: 'L·∫•y danh s√°ch ticket h·ªó tr·ª£', auth: true },
            { method: 'GET', path: '/api/support/:id', description: 'L·∫•y chi ti·∫øt ticket', auth: true },
            { method: 'POST', path: '/api/support', description: 'T·∫°o ticket m·ªõi', auth: true },
            { method: 'POST', path: '/api/support/:id/message', description: 'G·ª≠i tin nh·∫Øn trong ticket', auth: true },
            { method: 'PUT', path: '/api/support/:id', description: 'C·∫≠p nh·∫≠t ticket (Admin)', auth: true, admin: true },
            { method: 'PUT', path: '/api/support/:id/close', description: 'ƒê√≥ng ticket', auth: true },
            
            // Vouchers
            { method: 'GET', path: '/api/vouchers', description: 'L·∫•y danh s√°ch voucher', auth: false },
            { method: 'GET', path: '/api/vouchers/validate/:code', description: 'Ki·ªÉm tra m√£ voucher', auth: false },
            { method: 'GET', path: '/api/vouchers/:id', description: 'L·∫•y chi ti·∫øt voucher', auth: false },
            { method: 'POST', path: '/api/vouchers/check', description: 'Ki·ªÉm tra voucher h·ª£p l·ªá', auth: true },
            { method: 'POST', path: '/api/vouchers', description: 'T·∫°o voucher m·ªõi', auth: true, admin: true },
            { method: 'PUT', path: '/api/vouchers/:id', description: 'C·∫≠p nh·∫≠t voucher', auth: true, admin: true },
            { method: 'DELETE', path: '/api/vouchers/:id', description: 'X√≥a voucher', auth: true, admin: true },
            
            // Chat
            { method: 'POST', path: '/api/chat/messages', description: 'G·ª≠i tin nh·∫Øn (Customer ‚Üî Admin)', auth: true },
            { method: 'GET', path: '/api/chat/messages', description: 'L·∫•y danh s√°ch chat/tin nh·∫Øn', auth: true },
            { method: 'GET', path: '/api/chat/unread-count', description: 'L·∫•y s·ªë tin nh·∫Øn ch∆∞a ƒë·ªçc', auth: true },
            { method: 'GET', path: '/api/chat/info', description: 'L·∫•y th√¥ng tin chat (cho Android app)', auth: true },
            
            // Payment
            { method: 'POST', path: '/api/payment/zalopay/create', description: 'T·∫°o thanh to√°n ZaloPay', auth: true },
            { method: 'POST', path: '/api/payment/momo/create', description: 'T·∫°o thanh to√°n MoMo', auth: true },
            { method: 'POST', path: '/api/payment/zalopay/callback', description: 'Callback ZaloPay', auth: false },
            { method: 'POST', path: '/api/payment/momo/callback', description: 'Callback MoMo', auth: false },
            { method: 'GET', path: '/api/payment/zalopay/status/:orderId', description: 'Ki·ªÉm tra tr·∫°ng th√°i ZaloPay', auth: true },
            { method: 'GET', path: '/api/payment/momo/status/:orderId', description: 'Ki·ªÉm tra tr·∫°ng th√°i MoMo', auth: true },
            { method: 'GET', path: '/api/payment/momo/return', description: 'Return URL MoMo', auth: false },
            
            // Home
            { method: 'GET', path: '/api/home', description: 'L·∫•y d·ªØ li·ªáu trang ch·ªß', auth: false },
            
            // Dashboard
            { method: 'GET', path: '/api/dashboard', description: 'Dashboard t·ªïng quan', auth: true, admin: true },
            { method: 'GET', path: '/api/dashboard/revenue', description: 'Doanh thu dashboard', auth: true, admin: true },
            { method: 'GET', path: '/api/dashboard/top-products', description: 'Top s·∫£n ph·∫©m dashboard', auth: true, admin: true },
            
            // Statistics
            { method: 'GET', path: '/api/statistics/overview', description: 'T·ªïng h·ª£p th·ªëng k√™', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/revenue', description: 'B√°o c√°o doanh thu', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/revenue/daily', description: 'Doanh thu theo ng√†y', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/revenue/monthly', description: 'Doanh thu theo th√°ng', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/revenue/yearly', description: 'Doanh thu theo nƒÉm', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/top-products', description: 'S·∫£n ph·∫©m b√°n ch·∫°y', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/top-products/quantity', description: 'Top s·∫£n ph·∫©m theo s·ªë l∆∞·ª£ng', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/top-products/revenue', description: 'Top s·∫£n ph·∫©m theo doanh thu', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/low-stock', description: 'S·∫£n ph·∫©m t·ªìn kho th·∫•p', auth: true, admin: true },
            { method: 'GET', path: '/api/statistics/payment-methods', description: 'Th·ªëng k√™ ph∆∞∆°ng th·ª©c thanh to√°n', auth: true, admin: true },
            
            // Invoices
            { method: 'POST', path: '/api/invoices', description: 'T·∫°o h√≥a ƒë∆°n m·ªõi (kh√°ch h√†ng)', auth: true },
            { method: 'GET', path: '/api/invoices', description: 'L·∫•y danh s√°ch h√≥a ƒë∆°n', auth: true },
            { method: 'GET', path: '/api/invoices/:id', description: 'L·∫•y chi ti·∫øt h√≥a ƒë∆°n', auth: true },
            { method: 'PATCH', path: '/api/invoices/:id/status', description: 'C·∫≠p nh·∫≠t tr·∫°ng th√°i h√≥a ƒë∆°n', auth: true },
        ];

        // Reviews Management Functions
        async function loadReviews() {
            try {
                const productFilter = document.getElementById('reviewProductFilter')?.value || '';
                const ratingFilter = document.getElementById('reviewRatingFilter')?.value || '';
                const visibilityFilter = document.getElementById('reviewVisibilityFilter')?.value || '';
                const search = document.getElementById('reviewSearch')?.value || '';
                
                let url = `${API_BASE}/reviews?limit=50`;
                if (productFilter) url += `&productId=${productFilter}`;
                if (ratingFilter) url += `&rating=${ratingFilter}`;
                
                const response = await fetch(url, {
                    headers: getAuthHeaders()
                });
                
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.message || 'L·ªói t·∫£i ƒë√°nh gi√°!');
                }
                
                const data = await response.json();
                
                if (!data || !data.reviews) {
                    throw new Error('D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá!');
                }
                
                // Load danh s√°ch s·∫£n ph·∫©m cho filter
                if (!productFilter) {
                    const productsResponse = await fetch(`${API_BASE}/products?limit=100`, {
                        headers: getAuthHeaders()
                    });
                    if (productsResponse.ok) {
                        const productsData = await productsResponse.json();
                        const productSelect = document.getElementById('reviewProductFilter');
                        if (productSelect) {
                            const currentValue = productSelect.value;
                            productSelect.innerHTML = '<option value="">T·∫•t c·∫£ s·∫£n ph·∫©m</option>';
                            if (productsData.products) {
                                productsData.products.forEach(product => {
                                    const option = document.createElement('option');
                                    option.value = product._id;
                                    option.textContent = product.name;
                                    if (product._id === currentValue) option.selected = true;
                                    productSelect.appendChild(option);
                                });
                            }
                        }
                    }
                }
                
                // Filter by search and visibility
                let filteredReviews = data.reviews || [];
                
                // Filter by visibility
                if (visibilityFilter !== '') {
                    const isVisible = visibilityFilter === 'true';
                    filteredReviews = filteredReviews.filter(review => {
                        // M·∫∑c ƒë·ªãnh isVisible = true n·∫øu kh√¥ng c√≥ tr∆∞·ªùng n√†y (cho ƒë√°nh gi√° c≈©)
                        const reviewVisible = review.isVisible !== undefined ? review.isVisible : true;
                        return reviewVisible === isVisible;
                    });
                }
                
                // Filter by search
                if (search) {
                    const searchLower = search.toLowerCase();
                    filteredReviews = filteredReviews.filter(review => {
                        const userName = review.user?.fullName?.toLowerCase() || '';
                        const productName = review.product?.name?.toLowerCase() || '';
                        const comment = review.comment?.toLowerCase() || '';
                        return userName.includes(searchLower) || 
                               productName.includes(searchLower) || 
                               comment.includes(searchLower);
                    });
                }
                
                let html = `
                    <div style="margin-bottom: 15px; color: #666;">
                        T·ªïng s·ªë ƒë√°nh gi√°: <strong>${filteredReviews.length}</strong>
                    </div>
                `;
                
                if (filteredReviews.length > 0) {
                    html += '<table><thead><tr>';
                    html += '<th>Kh√°ch h√†ng</th>';
                    html += '<th>S·∫£n ph·∫©m</th>';
                    html += '<th>ƒê√°nh gi√°</th>';
                    html += '<th>B√¨nh lu·∫≠n</th>';
                    html += '<th>Tr·∫°ng th√°i</th>';
                    html += '<th>Ng√†y ƒë√°nh gi√°</th>';
                    html += '<th>Thao t√°c</th>';
                    html += '</tr></thead><tbody>';
                    
                    filteredReviews.forEach(review => {
                        const stars = '‚≠ê'.repeat(review.rating || 0);
                        const date = new Date(review.createdAt).toLocaleString('vi-VN');
                        // M·∫∑c ƒë·ªãnh isVisible = true n·∫øu kh√¥ng c√≥ tr∆∞·ªùng n√†y (cho ƒë√°nh gi√° c≈©)
                        const isVisible = review.isVisible !== undefined ? review.isVisible : true;
                        const statusBadge = isVisible 
                            ? '<span style="background: #10b981; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">Hi·ªÉn th·ªã</span>'
                            : '<span style="background: #ef4444; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">ƒêang ·∫©n</span>';
                        const rowStyle = !isVisible ? 'background: #fee2e2; opacity: 0.8;' : '';
                        
                        html += `
                            <tr style="${rowStyle}">
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${review.user?.avatar ? `<img src="${review.user.avatar}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #667eea; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">' + (review.user?.fullName?.charAt(0) || '?') + '</div>'}
                                        <div>
                                            <div style="font-weight: 600;">${review.user?.fullName || 'N/A'}</div>
                                            <div style="font-size: 12px; color: #999;">${review.user?.email || ''}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        ${review.product?.image ? `<img src="${review.product.image}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px;">` : ''}
                                        <div style="font-weight: 500;">${review.product?.name || 'N/A'}</div>
                                    </div>
                                </td>
                                <td>
                                    <div style="font-size: 18px; color: #f39c12;">${stars}</div>
                                    <div style="font-size: 12px; color: #999;">${review.rating}/5</div>
                                </td>
                                <td>
                                    <div style="max-width: 300px; word-wrap: break-word;">
                                        ${review.comment || '<span style="color: #999;">Kh√¥ng c√≥ b√¨nh lu·∫≠n</span>'}
                                    </div>
                                    ${review.images && review.images.length > 0 ? `
                                        <div style="margin-top: 5px; display: flex; gap: 5px; flex-wrap: wrap;">
                                            ${review.images.map(img => `<img src="${img}" style="width: 50px; height: 50px; object-fit: cover; border-radius: 5px; cursor: pointer;" onclick="window.open('${img}', '_blank')">`).join('')}
                                        </div>
                                    ` : ''}
                                </td>
                                <td>${statusBadge}</td>
                                <td style="font-size: 12px; color: #666;">${date}</td>
                                <td>
                                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                                        <button class="btn ${isVisible ? 'btn-warning' : 'btn-success'}" onclick="toggleReviewVisibility('${review._id}', ${!isVisible})" style="padding: 5px 10px; font-size: 12px;">
                                            ${isVisible ? 'üëÅÔ∏è ·∫®n' : 'üëÅÔ∏è Hi·ªán'}
                                        </button>
                                        <button class="btn btn-danger" onclick="deleteReview('${review._id}')" style="padding: 5px 10px; font-size: 12px;">X√≥a</button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p style="text-align: center; padding: 40px; color: #999;">Kh√¥ng c√≥ ƒë√°nh gi√° n√†o!</p>';
                }
                
                document.getElementById('reviewsContent').innerHTML = html;
            } catch (error) {
                console.error('Load reviews error:', error);
                const errorMessage = error.message || 'L·ªói t·∫£i ƒë√°nh gi√°!';
                document.getElementById('reviewsContent').innerHTML = `
                    <p style="color: red; text-align: center; padding: 40px;">
                        ${errorMessage}<br>
                        <small style="color: #999; margin-top: 10px; display: block;">Vui l√≤ng ki·ªÉm tra console (F12) ƒë·ªÉ xem chi ti·∫øt l·ªói.</small>
                    </p>
                `;
            }
        }
        
        async function toggleReviewVisibility(reviewId, makeVisible) {
            try {
                const response = await fetch(`${API_BASE}/reviews/admin/${reviewId}/toggle-visibility`, {
                    method: 'PUT',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message || (makeVisible ? 'Hi·ªÉn th·ªã ƒë√°nh gi√° th√†nh c√¥ng!' : '·∫®n ƒë√°nh gi√° th√†nh c√¥ng!'));
                    loadReviews();
                } else {
                    alert(data.message || 'L·ªói c·∫≠p nh·∫≠t tr·∫°ng th√°i!');
                }
            } catch (error) {
                console.error('Toggle review visibility error:', error);
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }
        
        async function deleteReview(reviewId) {
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a ƒë√°nh gi√° n√†y?')) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/reviews/admin/${reviewId}`, {
                    method: 'DELETE',
                    headers: getAuthHeaders()
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('X√≥a ƒë√°nh gi√° th√†nh c√¥ng!');
                    loadReviews();
                } else {
                    alert(data.message || 'L·ªói x√≥a ƒë√°nh gi√°!');
                }
            } catch (error) {
                console.error('Delete review error:', error);
                alert('L·ªói k·∫øt n·ªëi!');
            }
        }

        function loadAPIs() {
            const apiList = document.getElementById('apiList');
            const grouped = {};
            
            apiEndpoints.forEach(api => {
                const category = api.path.split('/')[2] || 'other';
                if (!grouped[category]) {
                    grouped[category] = [];
                }
                grouped[category].push(api);
            });

            let html = '';
            Object.keys(grouped).sort().forEach(category => {
                html += `<div style="margin-bottom: 30px;">`;
                html += `<h3 style="color: #1e293b; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e2e8f0;">${category.toUpperCase()}</h3>`;
                html += `<div style="display: grid; gap: 12px;">`;
                
                grouped[category].forEach(api => {
                    const methodColor = {
                        'GET': '#10b981',
                        'POST': '#3b82f6',
                        'PUT': '#f59e0b',
                        'DELETE': '#ef4444',
                        'PATCH': '#8b5cf6'
                    }[api.method] || '#64748b';
                    
                    html += `
                        <div style="background: white; padding: 16px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 15px;" class="api-item">
                            <span style="background: ${methodColor}; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; min-width: 60px; text-align: center;">${api.method}</span>
                            <code style="flex: 1; color: #1e293b; font-size: 14px; font-weight: 500;">${api.path}</code>
                            <span style="color: #64748b; font-size: 13px;">${api.description}</span>
                            ${api.auth ? '<span style="background: #fef3c7; color: #92400e; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Auth</span>' : ''}
                            ${api.admin ? '<span style="background: #fee2e2; color: #991b1b; padding: 2px 8px; border-radius: 4px; font-size: 11px;">Admin</span>' : ''}
                        </div>
                    `;
                });
                
                html += `</div></div>`;
            });

            apiList.innerHTML = html;
        }

        function filterAPIs() {
            const search = document.getElementById('apiSearch').value.toLowerCase();
            const items = document.querySelectorAll('.api-item');
            
            items.forEach(item => {
                const text = item.textContent.toLowerCase();
                item.style.display = text.includes(search) ? 'flex' : 'none';
            });
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.classList.remove('active');
            }
        }
    </script>
</body>
</html>

